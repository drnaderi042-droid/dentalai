const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/image-crop-dialog-CKbwCGvE.js","assets/index-BSItzkt3.js","assets/index-DbJnq9AX.css","assets/index-b5NUrSMh.js","assets/DialogTitle-D9mOMHyE.js","assets/dialogTitleClasses-BJYaWiXv.js","assets/DialogContent-CPx_wcNJ.js","assets/Slider-B4qW6LuH.js","assets/visuallyHidden-Dan1xhjv.js","assets/image-crop-dialog-D4wcebRk.css","assets/role-nav-structure-DHfo1sWt.js","assets/url-helpers-DK-EJxWr.js","assets/role-nav-structure-Dj4K3jcL.css","assets/intra-oral-view-xgglfdg-.js","assets/upload-C5NUn5Ko.js","assets/preview-multi-file-C1SdoyfF.js","assets/format-number-BVcmMM5V.js","assets/file-thumbnail-J0C6dV__.js","assets/FormHelperText-CBXzj8d7.js","assets/image-BuqYs7tq.js","assets/color-preview-CjTlM1Ll.js","assets/Menu-Cy0n4kRw.js","assets/Card-BqWDE3fr.js","assets/CardContent-DE24Aeed.js","assets/FormControl-1z33WGqh.js","assets/InputLabel-DqZ4yv4U.js","assets/FormLabel-Dg62SF9b.js","assets/Select-QPCMlUZ4.js","assets/ai-diagnosis-display-CHy725wF.js","assets/Chip-CHY_XJWs.js","assets/Grid-BaG8uD1u.js","assets/TextField-DpdcsLRb.js","assets/cephalometric-ai-analysis-DawjY0rp.js","assets/advanced-cephalometric-visualizer-BadiHF3t.js","assets/ClickAwayListener-BBFqwi2L.js","assets/FormControlLabel-CtXEP1QR.js","assets/ToggleButtonGroup-Dsynh9XZ.js","assets/Skeleton-CVH0eaWu.js"])))=>i.map(i=>d[i]);
import{r as i,j as e,cG as ia,B as b,T as w,b7 as rt,S as X,o as la,I as re,dK as jn,i as wn,dg as vn,fG as An,fH as Sn,b as Cn,dh as T,di as R,dA as D,p as In,ek as Nn,cK as oa,bh as Te,e as sa,bt as za,A as _a,bc as C,d as J,ar as kn,v as Ua,aE as Mn,aK as At,cI as zt,cA as Tn,cs as Dn,dc as It,H as $n,C as Ln}from"./index-BSItzkt3.js";import{u as Gn}from"./uuidv4-B4SGT1yQ.js";import{g as ue,a as Oa,b as Wa}from"./url-helpers-DK-EJxWr.js";import{g as Pn,f as Rn}from"./orthodontic-analysis-BYuymS1f.js";import{c as Fn}from"./calendar-E-eGAUG7.js";import{U as _t}from"./upload-C5NUn5Ko.js";import"./image-BuqYs7tq.js";import{A as En}from"./animate-border-aH1OBDu2.js";import{C as xe}from"./Card-BqWDE3fr.js";import{a as Ka,c as Xa,T as Ht,b as Ya}from"./TableHead-DAuzvg-9.js";import{T as me}from"./TableCell-B7TbLBfh.js";import{G as St}from"./Grid-BaG8uD1u.js";import{T as De}from"./TextField-DpdcsLRb.js";import{D as Bn}from"./DatePicker-BK0jorBV.js";import{M as zn}from"./MobileDateTimePicker-Baldv5MM.js";import{F as Ha}from"./FormControl-1z33WGqh.js";import{I as Va}from"./InputLabel-DqZ4yv4U.js";import{S as Ja}from"./Select-QPCMlUZ4.js";import{M as _n}from"./Menu-Cy0n4kRw.js";import{L as Ct}from"./ListItemIcon-BgqmI6Kp.js";import{D as Ut}from"./DialogTitle-D9mOMHyE.js";import{D as Ot}from"./DialogContent-CPx_wcNJ.js";import{D as Wt}from"./dialogTitleClasses-BJYaWiXv.js";import"./index-WR0nwbrK.js";import"./preview-multi-file-C1SdoyfF.js";import"./index-b5NUrSMh.js";import"./format-number-BVcmMM5V.js";import"./file-thumbnail-J0C6dV__.js";import"./FormHelperText-CBXzj8d7.js";import"./visuallyHidden-Dan1xhjv.js";import"./ListItem-Doeuyi4X.js";import"./Chip-CHY_XJWs.js";import"./FormLabel-Dg62SF9b.js";function Un({text:c,speed:s=30,onComplete:Y,sx:_,...Q}){const[I,N]=i.useState(""),[L,r]=i.useState(!1),M=i.useRef(null);return i.useEffect(()=>{if(!c){N(""),r(!1);return}N(""),r(!1);let fe=0;const oe=()=>{fe<c.length?(N(c.substring(0,fe+1)),fe+=1,M.current=setTimeout(oe,s)):(r(!0),Y&&Y())};return M.current=setTimeout(oe,100),()=>{M.current&&clearTimeout(M.current)}},[c,s,Y]),e.jsx(b,{sx:{position:"relative",..._},...Q,children:e.jsx(w,{component:"div",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.8,fontSize:"0.8125rem",position:"relative","&::before":L?{}:{content:'""',position:"absolute",top:0,left:0,right:0,bottom:0,background:fe=>`linear-gradient(90deg, transparent 0%, ${ia(fe.palette.primary.main,.2)} 50%, transparent 100%)`,backgroundSize:"200% 100%",pointerEvents:"none",mixBlendMode:"overlay",animation:"shining 2s linear infinite","@keyframes shining":{"0%":{backgroundPosition:"-200% 0"},"100%":{backgroundPosition:"200% 0"}}},"&::after":{content:L?'""':'"▊"',display:"inline-block",width:"2px",height:"1.2em",ml:.5,bgcolor:"primary.main",animation:L?"none":"blink 1s infinite","@keyframes blink":{"0%, 50%":{opacity:1},"51%, 100%":{opacity:0}}}},children:I})})}function ca({measurements:c={}}){const s={SNA:{min:80,max:84,description:"موقعیت ماگزیلا نسبت به جمجمه"},SNB:{min:78,max:82,description:"موقعیت مندیبل نسبت به جمجمه"},ANB:{min:2,max:4,description:"رابطه اسکلتی فک بالا و پایین"},FMA:{min:22,max:28,description:"الگوی رشد عمودی صورت"},FMIA:{min:65,max:75,description:"زاویه دندان قدامی پایین با صفحه فرانکفورت"},IMPA:{min:90,max:95,description:"زاویه دندان قدامی پایین با صفحه مندیبل"},"U1-SN":{min:102,max:108,description:"زاویه دندان قدامی بالا با صفحه SN"},"L1-MP":{min:90,max:95,description:"زاویه دندان قدامی پایین با صفحه مندیبل"},GoGnSN:{min:30,max:38,description:"زاویه صفحه مندیبل با صفحه SN"}},Y=(I,N,L)=>I==null?"text.secondary":I>=N&&I<=L?"success.main":I<N-2||I>L+2?"error.main":"warning.main",_=(I,N,L)=>I==null?"نامشخص":I>=N&&I<=L?"نرمال":I<N?"کمتر از نرمال":"بیشتر از نرمال",Q=Object.keys(s).filter(I=>c[I]!==void 0);return Q.length===0?e.jsx(w,{variant:"body2",color:"text.secondary",children:"داده‌ای برای نمایش وجود ندارد"}):e.jsx(b,{sx:{overflowX:"auto"},children:e.jsxs(Ka,{size:"small",sx:{minWidth:600},children:[e.jsx(Xa,{children:e.jsxs(Ht,{children:[e.jsx(me,{sx:{fontWeight:600},children:"پارامتر"}),e.jsx(me,{align:"center",sx:{fontWeight:600},children:"مقدار بیمار"}),e.jsx(me,{align:"center",sx:{fontWeight:600},children:"مقدار نرمال"}),e.jsx(me,{align:"center",sx:{fontWeight:600},children:"وضعیت"}),e.jsx(me,{sx:{fontWeight:600},children:"توضیحات"})]})}),e.jsx(Ya,{children:Q.map(I=>{const N=c[I],L=s[I],r=Y(N,L.min,L.max),M=_(N,L.min,L.max);return e.jsxs(Ht,{hover:!0,children:[e.jsx(me,{sx:{fontWeight:500},children:I}),e.jsx(me,{align:"center",children:e.jsx(w,{variant:"body2",sx:{fontWeight:600},children:N!=null?N.toFixed(1):"-"})}),e.jsx(me,{align:"center",children:e.jsxs(w,{variant:"body2",color:"text.secondary",children:[L.min," - ",L.max]})}),e.jsx(me,{align:"center",children:e.jsx(w,{variant:"body2",sx:{color:r,fontWeight:500},children:M})}),e.jsx(me,{children:e.jsx(w,{variant:"caption",color:"text.secondary",children:L.description})})]},I)})})]})})}function qa({occlusionData:c=[]}){const s=["کانین چپ","مولر چپ","کانین راست","مولر راست"],Y={};return c.forEach(_=>{_.occlusion&&_.position&&(Y[_.occlusion]=_.position)}),e.jsx(b,{sx:{overflowX:"auto"},children:e.jsxs(Ka,{size:"small",sx:{minWidth:400},children:[e.jsx(Xa,{children:e.jsxs(Ht,{children:[e.jsx(me,{sx:{fontWeight:600},children:"اکلوژن دندان"}),e.jsx(me,{align:"center",sx:{fontWeight:600},children:"موقعیت"})]})}),e.jsx(Ya,{children:s.map(_=>e.jsxs(Ht,{hover:!0,children:[e.jsx(me,{sx:{fontWeight:500},children:_}),e.jsx(me,{align:"center",children:e.jsx(w,{variant:"body2",sx:{fontWeight:500},children:Y[_]||"-"})})]},_))})]})})}function On({sections:c=[],onComplete:s,sx:Y,..._}){const[Q,I]=i.useState(0),[N,L]=i.useState([]),r=i.useRef(!1),M=i.useRef(null),fe=i.useRef(!1),oe=i.useRef(null),$e=i.useRef(!1);i.useEffect(()=>{console.log("[TypingReport] Sections received:",{count:c.length,sections:c.map(S=>{var E;return{title:S.title,contentLength:((E=S.content)==null?void 0:E.length)||0,type:S.type}})})},[c]),i.useEffect(()=>{if(c.length===0){I(0),L([]),r.current=!1,fe.current=!1,$e.current=!1;return}const S=JSON.stringify(c.map(E=>({title:E.title,content:E.content})));return M.current!==S&&(oe.current&&(clearTimeout(oe.current),oe.current=null),M.current=S,$e.current=!1,fe.current?(I(0),L([]),r.current=!1):fe.current=!0),()=>{oe.current&&(clearTimeout(oe.current),oe.current=null)}},[c]);const be=i.useCallback(()=>{r.current||(r.current=!0,I(S=>{const E=c[S];return E&&L(k=>k.some(se=>se.title===E.title&&se.type===E.type)?k:[...k,E]),oe.current=setTimeout(()=>{I(k=>k<c.length-1?(r.current=!1,k+1):(s&&!$e.current&&($e.current=!0,s()),k)),oe.current=null},500),S}))},[c,s]),y=c[Q];return i.useEffect(()=>{if(y&&(y.type==="table"||y.type==="occlusion-table")&&!r.current){const S=N.some(k=>k.title===y.title&&k.type===y.type),E=c[Q]&&c[Q].title===y.title&&c[Q].type===y.type;if(!S&&E){const k=setTimeout(()=>{be()},100);return()=>clearTimeout(k)}}},[y,Q,c,be,N]),e.jsxs(xe,{sx:{pt:1,bgcolor:S=>ia(S.palette.background.paper,.8),backdropFilter:"blur(10px)",border:S=>`1px solid ${ia(S.palette.divider,.1)}`,...Y},..._,children:[e.jsxs(b,{sx:{mb:3},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"آنالیز کامل"}),e.jsx(w,{variant:"body2",color:"text.secondary",children:"در حال انجام آنالیزهای مختلف..."})]}),e.jsxs(b,{sx:{minHeight:"400px",maxHeight:"none",overflowY:"visible",py:2},children:[N.map((S,E)=>{const k=`${S.title}-${S.type||"text"}-${E}`;return e.jsxs(b,{sx:{mb:3},children:[e.jsxs(w,{variant:"subtitle1",sx:{mb:1,color:"text.primary",fontWeight:600,display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{component:"span",sx:{width:8,height:8,borderRadius:"50%",bgcolor:"text.secondary",display:"inline-block"}}),S.title]}),e.jsx(b,{sx:{pl:2},children:S.type==="table"&&S.tableData?e.jsx(ca,{measurements:S.tableData.measurements}):S.type==="occlusion-table"&&S.tableData?e.jsx(qa,{occlusionData:S.tableData.occlusionData}):e.jsx(w,{variant:"body2",sx:{whiteSpace:"pre-wrap",wordBreak:"break-word",lineHeight:1.8,fontSize:"0.8125rem"},children:S.content})})]},k)}),y&&!N.some(S=>S.title===y.title&&S.type===y.type)&&e.jsxs(b,{sx:{mb:3},children:[e.jsxs(w,{variant:"subtitle1",sx:{mb:1,color:"text.primary",fontWeight:600,display:"flex",alignItems:"center",gap:1},children:[e.jsx(b,{component:"span",sx:{width:8,height:8,borderRadius:"50%",bgcolor:"text.secondary",display:"inline-block",animation:y.type==="table"?"none":"pulse 1.5s infinite","@keyframes pulse":{"0%, 100%":{opacity:1},"50%":{opacity:.5}}}}),y.title]}),e.jsx(b,{sx:{pl:2},children:y.type==="table"&&y.tableData?e.jsx(ca,{measurements:y.tableData.measurements}):y.type==="occlusion-table"&&y.tableData?e.jsx(qa,{occlusionData:y.tableData.occlusionData}):e.jsx(Un,{text:y.content,speed:20,onComplete:be})})]}),c.length>0&&e.jsx(b,{sx:{mt:3,pt:2,borderTop:S=>`1px solid ${S.palette.divider}`},children:e.jsxs(w,{variant:"caption",color:"text.secondary",children:["پیشرفت: ",N.length+(y?1:0)," / ",c.length]})})]})]})}const Qa=rt.memo(({item:c,onEdit:s,onDelete:Y,getCategoryLabel:_})=>{if(!c)return null;const Q=(c.originalName||c.name||`تصویر-${c.id}`).length>20?`${(c.originalName||c.name||`تصویر-${c.id}`).substring(0,20)}...`:c.originalName||c.name||`تصویر-${c.id}`,I=ue(c.path||c.url||""),N=_?_(c.category):c.category||"نامشخص";return e.jsx(xe,{sx:{p:1.5,border:1,borderColor:"divider",bgcolor:"background.paper",marginTop:"0 !important"},children:e.jsxs(X,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(b,{component:"img",src:I,alt:Q,sx:{width:36,height:36,objectFit:"cover",borderRadius:1}}),e.jsxs(b,{sx:{flex:1,minWidth:0},children:[e.jsx(w,{variant:"body2",noWrap:!0,children:Q}),e.jsx(w,{variant:"caption",color:"text.secondary",children:N})]}),e.jsxs(X,{direction:"row",spacing:.5,alignItems:"center",children:[e.jsx(la,{onClick:L=>{L.stopPropagation(),L.preventDefault(),s&&typeof s=="function"&&s(c)},sx:{width:26,height:26,p:0},children:e.jsx(re,{icon:"solar:pen-bold",width:18})}),e.jsx(la,{onClick:L=>{L.stopPropagation(),Y(c)},sx:{width:26,height:26,p:0},children:e.jsx(re,{icon:"mingcute:close-line",width:16})})]})]})})},(c,s)=>!c.item||!s.item||c.onEdit!==s.onEdit||c.onDelete!==s.onDelete?!1:c.item.id===s.item.id&&(c.item.originalName||c.item.name)===(s.item.originalName||s.item.name)&&c.item.category===s.item.category&&c.item.path===s.item.path);Qa.displayName="ImageListItem";const Wn=i.lazy(()=>It(()=>import("./image-crop-dialog-CKbwCGvE.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9])));i.lazy(()=>It(()=>import("./role-nav-structure-DHfo1sWt.js"),__vite__mapDeps([10,1,2,11,12])));const Hn=rt.lazy(()=>It(()=>import("./intra-oral-view-xgglfdg-.js"),__vite__mapDeps([13,1,2,14,15,3,16,17,18,19,20,21,4,5,6,22,23,24,25,26,27])).then(c=>({default:c.IntraOralView})));rt.lazy(()=>It(()=>import("./ai-diagnosis-display-CHy725wF.js"),__vite__mapDeps([28,1,2,3,22,29,30,4,5,6,31,27,21,25,26,18,24])));rt.lazy(()=>It(()=>import("./cephalometric-ai-analysis-DawjY0rp.js"),__vite__mapDeps([32,1,2,11,14,15,3,16,17,18,19,33,20,22,23,21,4,5,6,31,27,25,26,24,34,35,36,37])).then(c=>({default:c.CephalometricAIAnalysis})));function Vn(){var Ba;const{id:c}=jn(),{user:s}=wn(),Y=vn(),{setHeaderContent:_,setHideRightButtons:Q}=An();Sn();const I=Cn(),[N,L]=i.useState("general"),[r,M]=i.useState(null),[fe,oe]=i.useState(!0),[$e,be]=i.useState(!1),[y,S]=i.useState([]),[E,k]=i.useState(!1),[da,se]=i.useState(!1),[ma,ha]=i.useState(!1),[Nt,kt]=i.useState("profile"),[ot,Vt]=i.useState([]),[Jt,st]=i.useState(!1),[Z,it]=i.useState(null),[Mt,Ke]=i.useState("general"),[ua,ga]=i.useState(!1),[Xe,pa]=i.useState(null),[fa,Tt]=i.useState(!1),[lt,ze]=i.useState(null),[je,ct]=i.useState([]),[qt,ya]=i.useState(!1),[Jn,qn]=i.useState(!1),[Kn,Kt]=i.useState(!0),[xa,ba]=i.useState(!1),ja=i.useRef(!1),[we,Le]=i.useState(new Set),[wa,Za]=i.useState(0),[q,Dt]=i.useState(null),[Ye,va]=i.useState(!1),[Aa,Qe]=i.useState(0),[en,Ze]=i.useState("");i.useEffect(()=>{console.log("[State] completeAnalysisReport changed:",{isNull:q===null,isArray:Array.isArray(q),length:(q==null?void 0:q.length)||0,sections:(q==null?void 0:q.map(t=>{var a;return{title:t.title,contentLength:((a=t.content)==null?void 0:a.length)||0}}))||[]})},[q]),i.useEffect(()=>{y.length>0&&Za(0)},[y.length]);const Ae=i.useCallback(t=>[...t].sort((a,n)=>{const o=new Date(a.createdAt||a.date||a.uploadDate||0);return new Date(n.createdAt||n.date||n.uploadDate||0).getTime()-o.getTime()}),[]),[$t,Sa]=i.useState(null),[ve,Ca]=i.useState(null);i.useCallback((t,a)=>{t.stopPropagation(),Sa({top:t.clientY-8,left:t.clientX-8}),Ca(a)},[]);const Se=i.useCallback(()=>{Sa(null),Ca(null)},[]),[Xt,dt]=i.useState(!1),[Lt,mt]=i.useState(null),te=i.useRef(null),_e=i.useRef(null),Yt=i.useRef(!1);i.useEffect(()=>{if(Xt)requestAnimationFrame(()=>{const t=window.innerWidth-document.documentElement.clientWidth;t>0&&(document.body.style.paddingRight=`${t}px`,document.documentElement.style.setProperty("--scrollbar-width",`${t}px`))});else{const t=setTimeout(()=>{document.body.style.paddingRight="",document.documentElement.style.removeProperty("--scrollbar-width")},300);return()=>clearTimeout(t)}return()=>{document.body.style.paddingRight="",document.documentElement.style.removeProperty("--scrollbar-width")}},[Xt]);const Gt=i.useCallback(t=>({profile:t.filter(a=>a.category==="profile"||a.category==="frontal"),lateral:t.filter(a=>a.category==="lateral"||a.category==="cephalometric"||a.category==="cephalometry"),intraoral:t.filter(a=>a.category==="intraoral"||a.category==="intra"),opg:t.filter(a=>a.category==="opg"||a.category==="panoramic"),general:t.filter(a=>a.category==="general"&&a.category!=="opg"&&a.category!=="panoramic")}),[]),Qt=i.useCallback(t=>{let a;if(typeof t=="string"||typeof t=="number")a=y.find(n=>n.id===t),a||(a={id:t});else if(t!=null&&t.id)a=t;else if(t!=null&&t._imageId){const n=t._imageId;a=y.find(o=>o.id===n),a||(a={id:n})}a&&a.id&&(mt(a),dt(!0)),Se()},[y,Se]),tn=i.useCallback(async()=>{if(!(!Lt||!Lt.id)){k(!0),setTimeout(()=>{dt(!1)},150);try{await T.delete(`${R.patients}/${c}/images`,{data:{imageId:Lt.id},headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`,"Content-Type":"application/json"}});const a=(await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})).data.images||[];S(a);const n=Gt(a);M(o=>({...o,images:n})),te.current&&clearTimeout(te.current),D.success("تصویر با موفقیت حذف شد")}catch(t){console.error("Error deleting image:",t),D.error("خطا در حذف تصویر")}finally{k(!1),setTimeout(()=>{mt(null)},300)}}},[Lt,c,s==null?void 0:s.accessToken,Gt]),an=i.useCallback(async t=>{try{const a=ue(t.path),o=await(await fetch(a)).blob(),d=URL.createObjectURL(o),u=document.createElement("a");u.href=d,u.download=t.originalName||`image-${t.id}.jpg`,document.body.appendChild(u),u.click(),u.remove(),URL.revokeObjectURL(d),D.success("دانلود آغاز شد")}catch(a){console.error("Download error",a),D.error("خطا در دانلود تصویر")}finally{Se()}},[Se]),[ht,Xn]=i.useState("gpt-4o"),[Zt,Yn]=i.useState("general"),[Qn,Zn]=i.useState({}),Ia={general:{SNA:{mean:"82",sd:"3.5",severity:"نرمال",note:"نشان‌دهنده موقعیت قدامی-خلفی فک بالا نسبت به قاعده جمجمه. افزایش: جلو بودن ماگزیلا. کاهش: عقب بودن ماگزیلا"},SNB:{mean:"80",sd:"3.5",severity:"نرمال",note:"نشان‌دهنده موقعیت قدامی-خلفی فک پایین نسبت به قاعده جمجمه. افزایش: جلو بودن مندیبل. کاهش: عقب بودن مندیبل"},ANB:{mean:"2",sd:"2",severity:"نرمال",note:"نشان‌دهنده رابطه قدامی-خلفی فک بالا نسبت به فک پایین (اختلاف SNA و SNB).مندیبل (کلاس II). کاهش: جلو بودن مندیبل یا عقب بودن ماگزیلا (کلاس III)"},"U1-SN":{mean:"103",sd:"6",severity:"نرمال",note:"زاویه دندان سانترال فک بالا نسبت به خط SN. افزایش: incisor بالا به سمت جلو (proclined). کاهش: incisor بالا به سمت عقب (retroclined)"},"L1-MP":{mean:"90",sd:"3",severity:"نرمال",note:"زاویه دندان سانترال فک پایین نسبت به صفحه مندیبولار. افزایش: incisor پایین به سمت جلو (proclined). کاهش: incisor پایین به سمت عقب (retroclined)"},"GoGn-SN":{mean:"32",sd:"4",severity:"نرمال",note:"زاویه صفحه مندیبولار نسبت به خط SN. افزایش: صفحه مندیبولار شیب دار (vertical growth). کاهش: صفحه مندیبولار صاف (horizontal growth)"},Overbite:{mean:"2.5",sd:"1.5",severity:"نرمال",note:"فاصله عمودی بین دندان‌های پیشین بالا و پایین (میلی‌متر). افزایش: overbite زیاد (deep bite). کاهش: overbite کم یا open bite"},Overjet:{mean:"2.5",sd:"1.5",severity:"نرمال",note:"فاصله افقی بین دندان‌های پیشین بالا و پایین (میلی‌متر). افزایش: overjet زیاد (دندان‌های بالا جلوتر). کاهش: overjet کم یا negative overjet (دندان‌های پایین جلوتر)"},"Facial Axis":{mean:"90",sd:"3",severity:"نرمال",note:"محور صورت (زاویه بین Ba-Na و Pt-Gn). افزایش: رشد عمودی صورت (vertical growth pattern). کاهش: رشد افقی صورت (horizontal growth pattern)"},"Facial Depth":{mean:"88",sd:"3",severity:"نرمال",note:"عمق صورت (زاویه بین N-Po و FH). افزایش: صورت عمیق‌تر (deep face). کاهش: صورت کم‌عمق‌تر (shallow face)"},"Lower Face Height Ratio":{mean:"47",sd:"2",severity:"نرمال",note:"نسبت فاصله عمودی صورت پایین (فاصله عمودی ANS-Me / فاصله عمودی N-Me × 100). افزایش: ارتفاع صورت پایین بیشتر (long face). کاهش: ارتفاع صورت پایین کمتر (short face)"},"Mandibular Plane":{mean:"26",sd:"4",severity:"نرمال",note:"صفحه مندیبولار (زاویه Go-Me نسبت به FH). افزایش: صفحه مندیبولار شیب‌دار (steep mandibular plane). کاهش: صفحه مندیبولار صاف (flat mandibular plane)"},Convexity:{mean:"0",sd:"2",severity:"نرمال",note:"تحدب صورت (فاصله A point از خط N-Pog). افزایش: صورت محدب‌تر (convex profile - کلاس II). کاهش: صورت مقعرتر (concave profile - کلاس III)"},"Upper Incisor":{mean:"22",sd:"4",severity:"نرمال",note:"زاویه دندان پیشین بالا (نسبت به A-Pog). افزایش: incisor بالا به سمت جلو (proclined). کاهش: incisor بالا به سمت عقب (retroclined)"},"Lower Incisor":{mean:"25",sd:"4",severity:"نرمال",note:"زاویه دندان پیشین پایین (نسبت به A-Pog). افزایش: incisor پایین به سمت جلو (proclined). کاهش: incisor پایین به سمت عقب (retroclined)"},"Interincisal Angle":{mean:"130",sd:"6",severity:"نرمال",note:"زاویه بین خط U1-U1A و خط L1-L1A. افزایش: زاویه بیشتر (بیشتر retroclined). کاهش: زاویه کمتر (بیشتر proclined)"},"N-A-Pog":{mean:"0",sd:"2",severity:"نرمال",note:"زاویه بین N-A-Pog (تحدب صورت). افزایش: صورت محدب‌تر (convex profile - کلاس II). کاهش: صورت مقعرتر (concave profile - کلاس III)"},"Co-A":{mean:"90",sd:"4",severity:"نرمال",note:"طول فک بالا (فاصله Co-A). افزایش: فک بالا بلندتر (maxillary prognathism). کاهش: فک بالا کوتاه‌تر (maxillary retrognathism)"},"Co-Gn":{mean:"120",sd:"5",severity:"نرمال",note:"طول فک پایین (فاصله Co-Gn). افزایش: فک پایین بلندتر (mandibular prognathism). کاهش: فک پایین کوتاه‌تر (mandibular retrognathism)"},"Lower Face Height":{mean:"65",sd:"4",severity:"نرمال",note:"فاصله عمودی صورت پایین (فاصله عمودی ANS-Me). افزایش: ارتفاع صورت پایین بیشتر (long face). کاهش: ارتفاع صورت پایین کمتر (short face)"},"Upper Face Height":{mean:"55",sd:"3",severity:"نرمال",note:"ارتفاع صورت بالا (N-ANS). افزایش: ارتفاع صورت بالا بیشتر. کاهش: ارتفاع صورت بالا کمتر"},"Facial Height Ratio":{mean:"55",sd:"2",severity:"نرمال",note:"نسبت ارتفاع صورت (ANS-Me/N-Me × 100). افزایش: نسبت بیشتر (long face pattern). کاهش: نسبت کمتر (short face pattern)"},"Mandibular Plane Angle":{mean:"25",sd:"4",severity:"نرمال",note:"زاویه صفحه مندیبولار. افزایش: صفحه مندیبولار شیب‌دار (vertical growth). کاهش: صفحه مندیبولار صاف (horizontal growth)"},FMA:{mean:"25",sd:"4",severity:"نرمال",note:"زاویه صفحه چهره‌ای فرانکفورت نسبت به صفحه مندیبولار. افزایش: صورت عمودی (vertical growth pattern). کاهش: صورت افقی (horizontal growth pattern)"},FMIA:{mean:"65",sd:"5",severity:"نرمال",note:"زاویه صفحه چهره‌ای فرانکفورت نسبت به incisor پایین. افزایش: incisor پایین به سمت عقب (retroclined). کاهش: incisor پایین به سمت جلو (proclined)"},IMPA:{mean:"90",sd:"3",severity:"نرمال",note:"زاویه incisor پایین نسبت به صفحه مندیبولار. افزایش: incisor پایین به سمت جلو (proclined). کاهش: incisor پایین به سمت عقب (retroclined)"},"Jarabak Ratio":{mean:"62",sd:"3",severity:"نرمال",note:"نسبت ارتفاع خلفی (PFH: S-Go) به ارتفاع قدامی (AFH: N-Me) ضربدر 100. افزایش: رشد عمودی بیشتر. کاهش: رشد افقی بیشتر"},"Saddle Angle":{mean:"123",sd:"5",severity:"نرمال",note:"زاویه سدل (∠N-S-Ar). ↑ → عقب‌گرد، ↓ → جلوگرد"},"Articular Angle":{mean:"143",sd:"6",severity:"نرمال",note:"زاویه آرتیکولار (∠S-Ar-Go). ↑ → رشد افقی، ↓ → رشد عمودی"},"Gonial Angle (Total)":{mean:"130",sd:"7",severity:"نرمال",note:"زاویه گونیال کل (∠Ar-Go-Me). ↑ → رشد عمودی، ↓ → رشد افقی"},"Upper Gonial Angle":{mean:"53.5",sd:"1.5",severity:"نرمال",note:"زاویه گونیال بالا (∠Ar-Go-N)"},"Lower Gonial Angle":{mean:"72.5",sd:"2.5",severity:"نرمال",note:"زاویه گونیال پایین (∠N-Go-Gn). ↑ → رشد عمودی"},"Sum of Posterior Angles":{mean:"396",sd:"6",severity:"نرمال",note:"مجموع زوایای خلفی (Saddle + Articular + Gonial). >۳۹۶° → عمودی، <۳۹۶° → افقی"},"Y-Axis (Growth Axis)":{mean:"59.5",sd:"3.5",severity:"نرمال",note:"محور Y (∠SGn–FH فرانکفورت). ↑ → رشد عمودی، ↓ → رشد افقی"},"Basal Plane Angle":{mean:"-",sd:"-",severity:"-",note:"زاویه صفحه بازال (∠PNS-ANS به Go-Me). مشابه MP angle"},"Ramus Height":{mean:"-",sd:"-",severity:"-",note:"ارتفاع راموس (Ar-Go). ↑ → افقی، ↓ → عمودی"},"Mandibular Arc":{mean:"27",sd:"1",severity:"نرمال",note:"زاویه بین Corpus Axis و Condylar Axis. ↑ → رشد عمودی"},"Palatal Plane to FH":{mean:"0",sd:"3",severity:"نرمال",note:"زاویه صفحه پالاتال به FH (∠ANS-PNS به FH). کمی ↓ به خلف"},"Occlusal Plane to FH":{mean:"9",sd:"1",severity:"نرمال",note:"زاویه صفحه اکلوژال به FH (∠Occlusal Plane به FH)"},"N-S-Ar":{mean:"123",sd:"5",severity:"نرمال",note:"زاویه بین nasion، sella و articulare. افزایش: زاویه بیشتر (بازتر). کاهش: زاویه کمتر (بسته‌تر)"},"N-Ar-Go":{mean:"123",sd:"5",severity:"نرمال",note:"زاویه محدود کننده (زاویه بین N-Ar-Go). افزایش: رشد عمودی صورت. کاهش: رشد افقی صورت"},"Go-Co-N-S":{mean:"59",sd:"4",severity:"نرمال",note:"میزان تمایز ساژیتال (زاویه بین Go-Co و N-S). افزایش: تمایز ساژیتال بیشتر. کاهش: تمایز ساژیتال کمتر"},"Go-Co-Go-Gn":{mean:"4",sd:"2",severity:"نرمال",note:"انتخاب اجتماعی (نسبت Go-Co به Go-Gn). افزایش: نسبت بیشتر. کاهش: نسبت کمتر"},"N-Co-Go-Co":{mean:"90",sd:"5",severity:"نرمال",note:"ایدئال فرهنگی (زاویه بین N-Co و Go-Co). افزایش: زاویه بیشتر. کاهش: زاویه کمتر"},"Ar-Co-Co-Gn":{mean:"74",sd:"4",severity:"نرمال",note:"نخستین sagittal (زاویه بین Ar-Co و Co-Gn). افزایش: زاویه بیشتر. کاهش: زاویه کمتر"},"AO-BO":{mean:"0",sd:"2",severity:"نرمال",note:"تفاوت عمودی A و B points نسبت به نیروی عمودی (0 = کلاس I). افزایش: کلاس II (ماگزیلا جلوتر یا مندیبل عقب‌تر). کاهش: کلاس III (ماگزیلا عقب‌تر یا مندیبل جلوتر)"},"PP/Go-Gn":{mean:"27",sd:"4",severity:"نرمال",note:"زاویه بین صفحه پلاتین و صفحه مندیبولار. افزایش: زاویه بیشتر (vertical growth pattern). کاهش: زاویه کمتر (horizontal growth pattern)"},"S-Go":{mean:"75",sd:"5",severity:"نرمال",note:"ابعاد عمودی چهره (سلا-گناتیون). افزایش: ارتفاع عمودی بیشتر (long face). کاهش: ارتفاع عمودی کمتر (short face)"},"Sagittal Jaw":{mean:"0",sd:"2",severity:"نرمال",note:"زاویه ساژیتال فک (معمولاً همان ANB). افزایش: کلاس II. کاهش: کلاس III"}},steiner:{SNA:{mean:"82",sd:"3.5",severity:"نرمال",note:"نشان‌دهنده موقعیت قدامی-خلفی فک بالا (ماگزیلا) نسبت به قاعده جمجمه. افزایش: جلو بودن ماگزیلا. کاهش: عقب بودن ماگزیلا"},SNB:{mean:"80",sd:"3.5",severity:"نرمال",note:"زاویه ارتباط بین اسنو، nasion و B point. افزایش: جلو بودن مندیبل. کاهش: عقب بودن مندیبل"},ANB:{mean:"2",sd:"2",severity:"نرمال",note:"تفاوت SNA و SNB . افزایش: جلو بودن ماگزیلا یا عقب بودن مندیبل (کلاس II). کاهش: جلو بودن مندیبل یا عقب بودن ماگزیلا (کلاس III)"},Overbite:{mean:"2.5",sd:"1.5",severity:"نرمال",note:"فاصله عمودی بین دندان‌های پیشین بالا و پایین (میلی‌متر). افزایش: overbite زیاد (deep bite). کاهش: overbite کم یا open bite"},Overjet:{mean:"2.5",sd:"1.5",severity:"نرمال",note:"فاصله افقی بین دندان‌های پیشین بالا و پایین (میلی‌متر). افزایش: overjet زیاد (دندان‌های بالا جلوتر). کاهش: overjet کم یا negative overjet (دندان‌های پایین جلوتر)"},"U1-SN":{mean:"103",sd:"6",severity:"نرما��",note:"زاویه دندان پیشین فک بالا نسبت به خط SN. افزایش: incisor بالا به سمت جلو (proclined). کاهش: incisor بالا به سمت عقب (retroclined)"},"L1-MP":{mean:"90",sd:"3",severity:"نرمال",note:"زاویه دندان پیشین فک پایین نسبت به صفحه مندیبولار. افزایش: incisor پایین به سمت جلو (proclined). کاهش: incisor پایین به سمت عقب (retroclined)"},"GoGn-SN":{mean:"32",sd:"4",severity:"نرمال",note:"زاویه صفحه مندیبولار نسبت به خط SN. افزایش: صفحه مندیبولار شیب دار (vertical growth). کاهش: صفحه مندیبولار صاف (horizontal growth)"}},ricketts:{"Facial Axis":{mean:"90",sd:"3",severity:"نرمال",note:"محور صورت (زاویه بین Ba-Na و Pt-Gn). افزایش: رشد عمودی صورت (vertical growth pattern). کاهش: رشد افقی صورت (horizontal growth pattern)"},"Facial Depth":{mean:"88",sd:"3",severity:"نرمال",note:"عمق صورت (زاویه بین N-Po و FH). افزایش: صورت عمیق‌تر (deep face). کاهش: صور�� کم‌عمق‌تر (shallow face)"},"Lower Face Height":{mean:"47",sd:"2",severity:"نرمال",note:"نسبت فاصله عمودی صورت پایین (فاصله عمودی ANS-Me / فاصله عمودی N-Me × 100). افزایش: ارتفاع صورت پایین بیشتر (long face). کاهش: ارتفاع صورت پایین کمتر (short face)"},"Mandibular Plane":{mean:"26",sd:"4",severity:"نرمال",note:"صفحه مندیبولار (زاویه Go-Me نسبت به FH). افزایش: صفحه مندیبولار شیب‌دار (steep mandibular plane). کاهش: صفحه مندیبولار صاف (flat mandibular plane)"},Convexity:{mean:"0",sd:"2",severity:"نرمال",note:"تحدب صورت (فاصله A point از خط N-Pog). افزایش: صورت محدب‌تر (convex profile - کلاس II). کاهش: صورت مقعرتر (concave profile - کلاس III)"},"Upper Incisor":{mean:"22",sd:"4",severity:"نرمال",note:"زاویه دندان پیشین بالا (نسبت به A-Pog). افزایش: incisor بالا به سمت جلو (proclined). کاهش: incisor بالا به سمت عقب (retroclined)"},"Lower Incisor":{mean:"25",sd:"4",severity:"نرمال",note:"زاویه دندان پیشین پایین (نسبت به A-Pog). افزایش: incisor پایین به سمت جلو (proclined). کاهش: incisor پایین به سمت عقب (retroclined)"},"Interincisal Angle":{mean:"130",sd:"6",severity:"نرمال",note:"زاویه بین خط U1-U1A و خط L1-L1A. افزایش: زاویه بیشتر (بیشتر retroclined). کاهش: زاویه کمتر (بیشتر proclined)"}},mcnamara:{"N-A-Pog":{mean:"0",sd:"2",severity:"ن��مال",note:"زاویه بین N-A-Pog (تحدب صورت). افزایش: صورت محدب‌تر (convex profile - کلاس II). کاهش: صورت مقعرتر (concave profile - کلاس III)"},"Co-A":{mean:"90",sd:"4",severity:"نرمال",note:"طول فک بالا (فاصله Co-A). افزایش: ��ک بالا بلندتر (maxillary prognathism). کاهش: فک بالا کوتاه‌تر (maxillary retrognathism)"},"Co-Gn":{mean:"120",sd:"5",severity:"نرمال",note:"طول فک پایین (فاصله Co-Gn). افزایش: فک پایین بلندتر (mandibular prognathism). کاهش: فک پایین کوتاه‌تر (mandibular retrognathism)"},"Mandibular Length":{mean:"120",sd:"5",severity:"نرمال",note:"طول مندیبول (Co-Gn). افزایش: مندیبول بلندتر (mandibular prognathism). کاهش: مندیبول کوتاه‌تر (mandibular retrognathism)"},"Maxillary Length":{mean:"90",sd:"4",severity:"نرمال",note:"طول ماگزیلا (Co-A). افزایش: ماگزیلا بلندتر (maxillary prognathism). کاهش: ماگزیلا کوتاه‌تر (maxillary retrognathism)"},"Lower Face Height":{mean:"65",sd:"4",severity:"نرمال",note:"فاصله عمودی صورت پایین (فاصله عمودی ANS-Me). افزایش: ارتفاع صورت پایین بیشتر (long face). کاهش: ارتفاع صورت پایین کمتر (short face)"},"Upper Face Height":{mean:"55",sd:"3",severity:"نرمال",note:"ارتفاع صورت بالا (N-ANS). افزایش: ارتفاع صورت بالا بیشتر. کاهش: ارتفاع صورت بالا کمتر"},"Facial Height Ratio":{mean:"55",sd:"2",severity:"نرمال",note:"نسبت ارتفاع صورت (ANS-Me/N-Me × 100). افزایش: نسبت بیشتر (long face pattern). کاهش: نسبت کمتر (short face pattern)"},"Mandibular Plane Angle":{mean:"25",sd:"4",severity:"نرمال",note:"زاویه صفحه مندیبولار. افزایش: صفحه مندیبولار شیب‌دار (vertical growth). کاهش: صفحه مندیبولار صاف (horizontal growth)"}},wits:{"AO-BO":{mean:"0",sd:"2",severity:"نرمال",note:"تفاوت عمودی A و B points نسبت به نیروی عمودی (0 = کلاس I). افزایش: کلاس II (ماگزیلا جلوتر یا مندیبل عقب‌تر). کاهش: کلاس III (ماگزیلا عقب‌تر یا مندیبل جلوتر)"},"PP/Go-Gn":{mean:"27",sd:"4",severity:"نرمال",note:"زاویه بین صفحه پلاتین و صفحه مندیبولار. افزایش: زاویه بیشتر (vertical growth pattern). کاهش: زاویه کمتر (horizontal growth pattern)"},"S-Go":{mean:"75",sd:"5",severity:"نرمال",note:"ابعاد عمودی چهره (سلا-گناتیون). افزایش: ارتفاع عمودی بیشتر (long face). کاهش: ارتفاع عمودی کمتر (short face)"},"Sagittal Jaw":{mean:"0",sd:"2",severity:"نرمال",note:"زاویه ساژیتال فک (معمولاً همان ANB). افزایش: کلاس II. کاهش: کلاس III"},"Occlusal Plane":{mean:"8",sd:"3",severity:"نرمال",note:"تفاوت افقی صفحه اکلوزال. افزایش: صفحه اک��وزال شیب‌دارتر. کاهش: صفحه اکلوزال صاف‌تر"}},tweed:{FMA:{mean:"25",sd:"4",severity:"نرمال",note:"زاویه صفحه چهره‌ای فرانکفورت نسبت به صفحه مندیبولار. افزایش: صورت عمودی (vertical growth pattern). کاهش: صورت افقی (horizontal growth pattern)"},FMIA:{mean:"65",sd:"5",severity:"نرمال",note:"زاویه صفحه چهره‌ای فرانکفورت نسبت به incisor پایین. افزایش: incisor پایین به سمت عقب (retroclined). کاهش: incisor پایین به سمت جلو (proclined)"},IMPA:{mean:"90",sd:"3",severity:"نرمال",note:"زاویه incisor پایین نسبت به صفحه مندیبولار. افز��یش: incisor پایین به سمت جلو (proclined). کاهش: incisor پایین به سمت عقب (retroclined)"}},bjork:{"S-Ar/Go-Gn Ratio":{mean:"62",sd:"3",severity:"نرمال",note:"نسبت طول سوراسلار به گونی ذره (ارزش رشد). افزایش: رشد عمودی بیشتر. کاهش: رشد افقی بیشتر"},"Ar-Go-N/Go-Me Ratio":{mean:"56",sd:"3",severity:"نرمال",note:"نسبت sagittal مندیبولار. افزایش: مندیبول جلوتر. کاهش: مندیبول عقب‌تر"},"S-Go/Go-Me Ratio":{mean:"62",sd:"3",severity:"نرمال",note:"نسبت عمودی چهره (اندازه‌گیری مقایسه‌ای). افزایش: ارتفاع عمودی بیشتر (long face). کاهش: ارتفاع عمودی کمتر (short face)"},"MP/SN":{mean:"32",sd:"4",severity:"نرمال",note:"زاویه صفحه مندیبولار نسبت به SN. افزایش: صفحه مندیبولار شیب‌دار (vertical growth). کاهش: صفحه مندیبولار صاف (horizontal growth)"},"NS-Gn":{mean:"104",sd:"5",severity:"نرمال",note:"زاویه nasion-sella-gnathion. افزایش: صورت عمودی‌تر. کاهش: صورت افقی‌تر"}},jarabak:{"Jarabak Ratio":{mean:"62",sd:"3",severity:"نرمال",note:"نسبت ارتفاع خلفی (PFH: S-Go) به ارتفاع قدامی (AFH: N-Me) ضربدر 100. افزایش: رشد عمودی بیشتر. کاهش: رشد افقی بیشتر"},"S-Go/Ar-Go Ratio":{mean:"53",sd:"3",severity:"نرمال",note:"فاکتور CAG رشد (اندازه‌گیری مقایسه‌ای رشد). افزایش: رشد عمودی بیشتر. کاهش: رشد افقی بیشتر"},"Ar-Go/N-Go Ratio":{mean:"47",sd:"3",severity:"نرمال",note:"عکس اندازه‌گیری مقایسه‌ای رشد. افزایش: رشد افقی بیشتر. کاهش: رشد عمودی بیشتر"},"Co-Gn/Ar-Go Ratio":{mean:"2.5",sd:"0.3",severity:"نرمال",note:"ف��کتور CG ارتفاع قدامی رامی. افزایش: ارتفاع قدامی بیشتر. کاهش: ارتفاع قدامی کمتر"},"S-Ar/Go-Gn Ratio":{mean:"98",sd:"5",severity:"نرمال",note:"نسبت SAG رشد. افزایش: رشد عمودی بیشتر. کاهش: رشد افقی بیشتر"},"Go-Gn/SN Angle":{mean:"46",sd:"4",severity:"نرمال",note:"زاویه رشد (صفحه مندیبولار نسبت به SN). افزایش: رشد عمودی (vertical growth). کاهش: رشد افقی (horizontal growth)"}},sassouni:{"N-S-Ar":{mean:"123",sd:"5",severity:"نرمال",note:"زاویه بین nasion، sella �� articulare. افزایش: زاویه بیشتر (بازتر). کاهش: زاویه کمتر (بسته‌تر)"},"N-Ar-Go":{mean:"123",sd:"5",severity:"نرمال",note:"زاویه محدود کننده (زاویه بین N-Ar-Go). افزایش: رشد عمودی صورت. کاهش: رشد افقی صورت"},"Go-Co-N-S":{mean:"59",sd:"4",severity:"نرمال",note:"میزان تمایز ساژیتال (زاویه بین Go-Co و N-S). افزایش: تمایز ساژیتال بیشتر. کاهش: تمایز ساژیتال کمتر"},"Go-Co-Go-Gn":{mean:"4",sd:"2",severity:"نرمال",note:"انتخاب اجتماعی (نسبت Go-Co به Go-Gn). افزایش: نسبت بیشتر. کاهش: نسبت کمتر"},"N-Co-Go-Co":{mean:"90",sd:"5",severity:"نرمال",note:"ایدئال فرهنگی (زاویه بین N-Co و Go-Co). افزایش: زاویه بیشتر. کاهش: زاویه کمتر"},"Ar-Co-Co-Gn":{mean:"74",sd:"4",severity:"نرمال",note:"نخستین sagittal (زاویه بین Ar-Co و Co-Gn). افزایش: زاویه بیشتر. کاهش: زاویه کمتر"}}};i.useEffect(()=>()=>{te.current&&clearTimeout(te.current),_e.current&&clearTimeout(_e.current)},[]),i.useEffect(()=>{const t=async()=>{try{oe(!0);const n=(await T.get(`${R.patients}/${c}`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})).data.patient;let o=null;try{n.cephalometricTableData&&typeof n.cephalometricTableData=="string"&&(o=JSON.parse(n.cephalometricTableData))}catch(m){console.warn("Failed to parse cephalometricTableData:",m),o=null}let d=null;try{n.cephalometricRawData&&typeof n.cephalometricRawData=="string"&&(d=JSON.parse(n.cephalometricRawData))}catch(m){console.warn("Failed to parse cephalometricRawData:",m),d=null}let u=null;try{n.cephalometricLandmarks&&typeof n.cephalometricLandmarks=="string"&&(u=JSON.parse(n.cephalometricLandmarks))}catch(m){console.warn("Failed to parse cephalometricLandmarks:",m),u=null}let h=null;try{n.intraOralAnalysis&&typeof n.intraOralAnalysis=="string"&&(h=JSON.parse(n.intraOralAnalysis))}catch(m){console.warn("Failed to parse intraOralAnalysis:",m),h=null}M({id:n.id,name:`${n.firstName} ${n.lastName}`,age:n.age,phone:n.phone,gender:n.gender||"",diagnosis:n.diagnosis,treatment:n.treatment,status:n.status,startDate:n.createdAt?Te(n.createdAt):null,nextVisit:n.nextVisit?Te(n.nextVisit):null,notes:n.notes||"",aiDiagnosis:n.diagnosis,softTissue:n.softTissueAnalysis||"آنالیز بافت نرم: خط زیبایی E مناسب، لب بالایی در حد طبیعی",cephalometric:n.cephalometricAnalysis||"آنالیز سفالومتریک: ANB: 6 درجه، SNA: 82 درجه، SNB: 76 درجه",cephalometricTable:o,cephalometricRawData:d,cephalometricLandmarks:u,treatmentPlan:n.treatmentPlan||"طرح درمان ��یشنهادی: استخراج دندان‌های آسیاب، استفاده از mini-implants",summary:n.summary||"خلاصه پرونده: بیمار نیازمند درمان ارتودنسی پیشرفته",images:{profile:[],lateral:[],intraoral:[],general:[]}});try{const x=(await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})).data.images||[];Yt.current||(console.log("[Patient Images] Total images:",x.length),console.log("[Patient Images] Categories found:",x.map(l=>({id:l.id,category:l.category,name:l.originalName}))),Yt.current=!0);const v=Ae(x),j={profile:v.filter(l=>l.category==="profile"||l.category==="frontal"),lateral:v.filter(l=>l.category==="lateral"||l.category==="cephalometric"||l.category==="cephalometry"),intraoral:v.filter(l=>l.category==="intraoral"||l.category==="intra"),general:v.filter(l=>l.category==="general"||l.category==="opg"||l.category==="panoramic")};M(l=>{var $,ae,O,W,K,ne,Ne,ke,Ge,Pe,Re,Fe;const f=(((ae=($=l==null?void 0:l.images)==null?void 0:$.profile)==null?void 0:ae.length)||0)+(((W=(O=l==null?void 0:l.images)==null?void 0:O.lateral)==null?void 0:W.length)||0)+(((ne=(K=l==null?void 0:l.images)==null?void 0:K.intraoral)==null?void 0:ne.length)||0)+(((ke=(Ne=l==null?void 0:l.images)==null?void 0:Ne.general)==null?void 0:ke.length)||0),G=j.profile.length+j.lateral.length+j.intraoral.length+j.general.length;if(f===G&&f>0){const Ee=new Set([...(((Ge=l==null?void 0:l.images)==null?void 0:Ge.profile)||[]).map(B=>B.id),...(((Pe=l==null?void 0:l.images)==null?void 0:Pe.lateral)||[]).map(B=>B.id),...(((Re=l==null?void 0:l.images)==null?void 0:Re.intraoral)||[]).map(B=>B.id),...(((Fe=l==null?void 0:l.images)==null?void 0:Fe.general)||[]).map(B=>B.id)]),Be=new Set([...j.profile.map(B=>B.id),...j.lateral.map(B=>B.id),...j.intraoral.map(B=>B.id),...j.general.map(B=>B.id)]);if(Ee.size===Be.size&&[...Ee].every(B=>Be.has(B)))return l}return{...l,images:j}}),S(l=>{const f=Ae(x);if(l.length===f.length){const G=new Set(l.map(ae=>ae.id)),$=new Set(f.map(ae=>ae.id));if(G.size===$.size&&[...G].every(ae=>$.has(ae)))return l}return Ae(x)})}catch(m){console.warn("Could not fetch patient images:",m)}oe(!1)}catch(a){console.error("Error fetching patient:",a),oe(!1),M({id:c,name:"بیمار یافت نشد",age:0,phone:"",diagnosis:"",treatment:"",status:"",startDate:null,nextVisit:null,notes:"",aiDiagnosis:"",softTissue:"",cephalometric:"",treatmentPlan:"",summary:"",images:{profile:[],lateral:[],intraoral:[],general:[]}})}};s&&c&&(Yt.current=!1,t())},[c,s,Ae]);const Na=i.useCallback(t=>{const a={},n=d=>{for(const u of d)if(t[u])return t[u];return null},o=d=>{const u=Object.keys(t);for(const h of d){const m=u.find(x=>x.toLowerCase().includes(h.toLowerCase())||h.toLowerCase().includes(x.toLowerCase()));if(m)return t[m]}return null};try{const d=n(["S","s"]),u=n(["N","n"]),h=n(["A","a"]);d&&u&&h&&(a.SNA=Pt(d,u,h));const m=n(["S","s"]),x=n(["N","n"]),v=n(["B","b"]);m&&x&&v&&(a.SNB=Pt(m,x,v)),a.SNA!==void 0&&a.SNB!==void 0&&(a.ANB=a.SNA-a.SNB);const j=n(["Or","or","OR"])||o(["or","orbit"]),l=n(["Po","po","PO"])||o(["po","porion"]),f=n(["Go","go","GO"])||o(["go","gonion"]),G=n(["Me","me","ME"])||o(["me","menton"]);j&&l&&f&&G&&(a.FMA=Rt(j,l,f,G),a.FMA=Math.round(Math.max(0,Math.min(180,a.FMA))*10)/10);const $=n(["Or","or","OR","orbitale","Orbitale"])||o(["or","orbit"]),ae=n(["Po","po","PO","porion","Porion"])||o(["po","porion"]),O=n(["L1","l1","lower_incisor","Lower_incisor","lower incisor"])||o(["l1","lower","incisor","li"]),W=n(["Me","me","ME","menton","Menton"])||o(["me","menton"]);if($&&ae&&O&&W){const F=Ce($,ae),g=Ce(O,W);let p=Math.abs(F-g);p>180&&(p=360-p),p>90?a.FMIA=180-p:a.FMIA=p,a.FMIA=Math.round(Math.max(0,Math.min(180,a.FMIA))*10)/10}const K=n(["Go","go","GO","gonion","Gonion"])||o(["go","gonion"]),ne=n(["Me","me","ME","menton","Menton"])||o(["me","menton"]),Ne=n(["LIA","lia","Lia","lower_incisor_apex","Lower_incisor_apex","lower incisor apex"])||o(["lia","lower","incisor","apex"]),ke=n(["LIT","lit","Lit","lower_incisor_tip","Lower_incisor_tip","lower incisor tip"])||o(["lit","lower","incisor","tip"]);if(!Ne||!ke){const F=n(["L1","l1","lower_incisor","Lower_incisor","lower incisor"])||o(["l1","lower","incisor","li"]);F&&K&&ne&&(a.IMPA=Rt(K,ne,F,ne),a.IMPA=Math.round(Math.max(0,Math.min(180,a.IMPA))*10)/10)}else K&&ne&&Ne&&ke&&(a.IMPA=Rt(K,ne,Ne,ke),a.IMPA=Math.round(Math.max(0,Math.min(180,a.IMPA))*10)/10);const Ge=n(["S","s"]),Pe=n(["N","n"]),Re=n(["Go","go","GO"]),Fe=n(["Gn","gn","GN"]);if(Ge&&Pe&&Re&&Fe){const F=Ce(Ge,Pe),g=Ce(Re,Fe),p=Math.abs(F-g);a["GoGn-SN"]=p,a.GoGnSN=p}const Ee=n(["S","s","sella","Sella"])||o(["s","sella"]),Be=n(["N","n","nasion","Nasion"])||o(["n","nasion"]),B=n(["U1","u1","upper_incisor","Upper_incisor","upper incisor"])||o(["u1","upper","incisor","ui"]);if(Ee&&Be&&B){const F=Pt(B,Be,Ee);a["U1-SN"]=Math.round(Math.max(0,Math.min(180,F))*10)/10}const ft=n(["Go","go","GO","gonion","Gonion"])||o(["go","gonion"]),yt=n(["Me","me","ME","menton","Menton"])||o(["me","menton"]),xt=n(["L1","l1","lower_incisor","Lower_incisor","lower incisor"])||o(["l1","lower","incisor","li"]);if(ft&&yt&&xt){const F=Pt(xt,yt,ft);a["L1-MP"]=Math.round(Math.max(0,Math.min(180,F))*10)/10}const bt=n(["U1","u1","upper_incisor","Upper Incisor"]),z=n(["U1A","u1a","U1a","upper_incisor_apex","Upper_incisor_apex"]),Ue=n(["L1","l1","lower_incisor","Lower Incisor"]),Oe=n(["L1A","l1a","L1a","lower_incisor_apex","Lower_incisor_apex"]);if(bt&&z&&Ue&&Oe){const F=Rt(bt,z,Ue,Oe);a.InterincisalAngle=Math.round(F*10)/10}if(t.S&&t.N&&t.Go&&t.Gn&&!a["GoGn-SN"]){const F=Ce(t.S,t.N),g=Ce(t.Go,t.Gn);a["SN-GoGn"]=Math.abs(F-g)}if(t.Ba&&t.Na&&t.Pt&&t.Gn){const F=Ce(t.Ba,t.Na),g=Ce(t.Pt,t.Gn);a.FacialAxis=Math.abs(F-g)}if(t.Go&&t.Me){const F=Ce(t.Go,t.Me);a.MandibularPlane=F}if(t.N&&t.ANS&&t.Me){const F=Math.sqrt((t.N.x-t.ANS.x)**2+(t.N.y-t.ANS.y)**2),g=Math.sqrt((t.ANS.x-t.Me.x)**2+(t.ANS.y-t.Me.y)**2);g>0&&(a.UpperLowerFaceRatio=F/g)}const We=n(["S","s","Sella","sella"]),et=n(["Go","go","GO","gonion","Gonion"]),He=n(["N","n","Nasion","nasion"]),tt=n(["Me","me","ME","menton","Menton"]);if(We&&et&&He&&tt){const F=Math.sqrt((We.x-et.x)**2+(We.y-et.y)**2),g=Math.sqrt((He.x-tt.x)**2+(He.y-tt.y)**2);g>0&&(a["Jarabak Ratio"]=Math.round(F/g*100*10)/10)}console.log("✅ Calculated measurements from landmarks:",a)}catch(d){console.error("Error calculating measurements from landmarks:",d)}return a},[]),Pt=(t,a,n)=>{const o=Math.atan2(t.y-a.y,t.x-a.x);let u=(Math.atan2(n.y-a.y,n.x-a.x)-o)*(180/Math.PI);return u<0&&(u+=360),u>180?360-u:u},Ce=(t,a)=>Math.atan2(a.y-t.y,a.x-t.x)*(180/Math.PI),Rt=(t,a,n,o)=>{const d=a.x-t.x,u=a.y-t.y,h=o.x-n.x,m=o.y-n.y,x=d*h+u*m,v=Math.sqrt(d*d+u*u),j=Math.sqrt(h*h+m*m);if(v===0||j===0)return 0;const l=x/(v*j),f=Math.max(-1,Math.min(1,l)),$=Math.acos(f)*(180/Math.PI);return $>90?180-$:$},ut=i.useRef(!1);i.useEffect(()=>{if(ut.current)return;const t=Ia[Zt]||Ia.steiner,a=r==null?void 0:r.cephalometricRawData,n=(r==null?void 0:r.cephalometricTable)&&Object.keys(r.cephalometricTable).length>0;if(t)if(a&&Object.keys(a).length>0){const o={};Object.keys(t).forEach(d=>{o[d]={...t[d],measured:a[d]||""}}),M(d=>(ut.current=!0,{...d,cephalometricTable:o}))}else if(n)ut.current=!0;else{const o={};Object.keys(t).forEach(d=>{o[d]={...t[d],measured:""}}),M(d=>(ut.current=!0,{...d,cephalometricTable:o}))}},[Zt,r==null?void 0:r.cephalometricRawData]),i.useEffect(()=>{ut.current=!1},[Zt]),i.useEffect(()=>{const t=(r==null?void 0:r.cephalometricTable)&&Object.keys(r.cephalometricTable).length>0,a=t&&Object.values(r.cephalometricTable).some(u=>u&&u.measured&&String(u.measured).trim()!==""),n=c?localStorage.getItem(`cephalometric_viewing_tables_${c}`)==="true":!1;if(!t||!a){Kt(!0),xa&&(ba(!1),c&&(localStorage.removeItem(`cephalometric_analysis_confirmed_${c}`),localStorage.removeItem(`cephalometric_viewing_tables_${c}`)));return}(c?localStorage.getItem(`cephalometric_analysis_confirmed_${c}`):null)==="true"&&!xa&&ba(!0),n?(Kt(!1),ja.current=!0):ja.current||Kt(!0)},[c,r==null?void 0:r.cephalometricTable]);const nn=async t=>{if(!t){D.error("لطفا تصویر ��لی را انتخاب کنید");return}ya(!0);try{const a=new FormData;a.append("file",t);const n=Oa(8e3),o=await fetch(`${n}/split-composite-image`,{method:"POST",body:a});if(!o.ok)throw new Error("خطا در تقسیم تصویر");const d=await o.json();if(d.success&&d.splits)ct(d.splits),Le(new Set(d.splits.map((u,h)=>h))),D.success(`تصویر به ${d.total_splits} بخش تقسیم شد`);else throw new Error("خطا در پردازش نتیجه")}catch(a){console.error("Error splitting image:",a),D.error(`خطا در تقسیم تصویر: ${a.message||"خطای ناشناخته"}`)}finally{ya(!1)}},rn=async()=>{if(we.size===0){D.error("لطفا حداقل یک تصویر را انتخاب کنید");return}be(!0);try{const t={intraoral:[],lateral:[],profile:[],general:[]};we.forEach(h=>{const m=je[h];if(!m)return;const x=atob(m.image_base64),v=new Array(x.length);for(let $=0;$<x.length;$++)v[$]=x.charCodeAt($);const j=new Uint8Array(v),l=new Blob([j],{type:"image/jpeg"}),f=new File([l],`split-${m.row}-${m.col}.jpg`,{type:"image/jpeg"});let G=m.category||"general";G==="frontal"&&(G="profile"),t[G]?t[G].push(f):t.general.push(f)});const a=[];for(const[h,m]of Object.entries(t)){if(m.length===0)continue;const x=new FormData;m.forEach(v=>{x.append("images",v)}),x.append("category",h),a.push(T.post(`${R.patients}/${c}/images`,x,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}))}await Promise.all(a);const o=(await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})).data.images||[],d=Ae(o);S(d);const u={profile:d.filter(h=>h.category==="profile"||h.category==="frontal"),lateral:d.filter(h=>h.category==="lateral"||h.category==="cephalometric"||h.category==="cephalometry"),intraoral:d.filter(h=>h.category==="intraoral"||h.category==="intra"),general:d.filter(h=>h.category==="general"||h.category==="opg"||h.category==="panoramic")};M(h=>({...h,images:u})),D.success(`${we.size} تصویر با موفقیت ذخیره شد`),Tt(!1),ze(null),ct([]),Le(new Set)}catch(t){console.error("Error saving split images:",t),D.error("خطا در ذخیره تصاویر")}finally{be(!1)}},ka=async t=>{try{const a=new FormData;a.append("file",t);const n=await fetch(Wa("/classify-image-type"),{method:"POST",body:a});if(!n.ok)throw new Error("خطا در تشخیص نوع تصویر");return await n.json()}catch(a){return console.error("Error classifying image type:",a),{category:"general",confidence:0}}},Ft=i.useCallback(async(t,a)=>{if(!(!t||t.length===0)){be(!0);try{if(a==="general"){const h=await Promise.all(t.map(async v=>{const j=await ka(v);return{file:v,detectedCategory:j.category||"general",confidence:j.confidence||0}})),m={intraoral:[],lateral:[],profile:[],general:[]};h.forEach(({file:v,detectedCategory:j,confidence:l})=>{const f=l>=.3?j:"general";f==="intraoral"?m.intraoral.push(v):f==="lateral"?m.lateral.push(v):f==="profile"||f==="frontal"?m.profile.push(v):m.general.push(v)});const x=[];Object.entries(m).forEach(([v,j])=>{if(j.length>0){const l=new FormData;j.forEach(f=>{l.append("images",f)}),l.append("category",v),x.push(T.post(`${R.patients}/${c}/images`,l,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}))}}),await Promise.all(x)}else{const h=new FormData;t.forEach(m=>{h.append("images",m)}),h.append("category",a),await T.post(`${R.patients}/${c}/images`,h,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})}const o=(await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})).data.images||[],d=Ae(o);S(d);const u=Gt(d);M(h=>({...h,images:u})),se(!0),te.current&&clearTimeout(te.current),te.current=setTimeout(()=>se(!1),3e3),a==="general"?D.success("تصاویر با موفقیت تقسیم و آپلود شدند"):D.success("تصاویر با موفقیت آپلود شدند")}catch(n){console.error("[Upload] Upload error full:",n);let o="خطا در آپلود تصویر";if(!n)o="Unknown error";else if(typeof n=="string")o=n;else if(typeof n=="object"){const{message:d,error:u,detail:h,response:m}=n;if(d)o=d;else if(u)o=u;else if(h)o=h;else if(m&&m.data&&m.data.message){const{message:x}=m.data;o=x}}console.error("[Upload] Parsed upload error message:",o),D.error(o)}finally{be(!1)}}},[c,s==null?void 0:s.accessToken,Gt,Ae]),Ma=i.useCallback((t,a)=>{if(a==="cephalometric"){Y(`/dashboard/orthodontics/patient/${c}/analysis`,{state:{uploadedImages:y,selectedImageIndex:wa,lateralImages:Ae(y.filter(n=>n.category==="lateral"||n.category==="cephalometric"||n.category==="cephalometry"))}});return}L(a)},[Y,c,y,wa,Ae]),Ta=i.useMemo(()=>e.jsxs(X,{direction:"row",alignItems:"center",spacing:{xs:1,sm:2},sx:{flexGrow:1,minWidth:0,overflow:"hidden",width:"100%",maxWidth:"100%"},children:[e.jsx(la,{onClick:()=>Y(In.dashboard.orthodontics),sx:{width:{xs:36,sm:40},height:{xs:36,sm:40},minWidth:{xs:36,sm:40},flexShrink:0,bgcolor:"transparent",boxShadow:"none",color:"text.primary",transform:"none !important","&:hover":{bgcolor:"action.hover",boxShadow:"none",transform:"none !important"},"&:active":{transform:"none !important"}},"aria-label":"بازگشت",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",style:{transform:"rotate(180deg)"},children:e.jsx("path",{d:"M14.9998 19.9201L8.47984 13.4001C7.70984 12.6301 7.70984 11.3701 8.47984 10.6001L14.9998 4.08008",stroke:"currentColor",strokeWidth:"1.5",strokeMiterlimit:"10",strokeLinecap:"round",strokeLinejoin:"round"})})}),e.jsx(b,{sx:{flexGrow:1,minWidth:0,display:"flex",justifyContent:"center"},children:e.jsxs(Nn,{value:N,onChange:(t,a)=>Ma(t,a),"aria-label":"تب‌های ناوبری",variant:"fullWidth",sx:{width:"100%",minWidth:0,borderRadius:1,mx:"auto",maxWidth:"none","& .MuiTab-root":{flex:1,minWidth:0,maxWidth:"none",zIndex:2,position:"relative"}},children:[e.jsx(oa,{label:"مشخصات",value:"general"}),e.jsx(oa,{label:"سفالومتری",value:"cephalometric"}),e.jsx(oa,{label:"دهان",value:"intra-oral"})]})})]}),[N,Ma,Y]);i.useEffect(()=>(_(Ta),Q(!0),()=>{_(null),Q(!1)}),[Ta,_,Q]);const Da=i.useCallback(t=>{let a;if(typeof t=="string"||typeof t=="number")a=y.find(n=>n.id===t),a||(a={id:t});else if(t!=null&&t.id)a=t;else if(t!=null&&t._imageId){const n=t._imageId;a=y.find(o=>o.id===n),a||(a={id:n})}if(!a||!a.id){console.error("Invalid image ID for deletion");return}mt(a),dt(!0)},[y]),on=i.useCallback(async()=>{k(!0);try{const t=r.name.split(" "),a={firstName:t[0],lastName:t.slice(1).join(" "),age:parseInt(r.age,10),phone:r.phone,gender:r.gender,status:r.status,notes:r.notes};if(r.startDate){const n=Te.isMoment(r.startDate)?r.startDate:Te(r.startDate);a.startDate=n.toISOString()}if(r.nextVisit){const n=Te.isMoment(r.nextVisit)?r.nextVisit:Te(r.nextVisit);a.nextVisit=n.toISOString()}await T.put(`${R.patients}/${c}`,a,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),se(!0),te.current&&clearTimeout(te.current),te.current=setTimeout(()=>se(!1),3e3)}catch(t){console.error("Save error:",t),alert("خطا در ذخیره اطلاعات")}finally{k(!1)}},[r,c,s==null?void 0:s.accessToken]),sn=async()=>{if(!(r!=null&&r.nextVisit)){alert("لطفا تاریخ و ساعت ویزیت را انتخاب کنید");return}k(!0);try{const t=Te.isMoment(r.nextVisit)?r.nextVisit:Te(r.nextVisit);if(!t||!t.isValid())throw new Error("تاریخ و ساعت ویزیت نامعتبر است");const a=t.toISOString(),n=t.clone().add(1,"hour").toISOString();if(!a||!n||a==="Invalid date"||n==="Invalid date")throw new Error("تاریخ و ساعت ویزیت نامعتبر است");const o={id:Gn(),title:`ویزیت - ${r.name||"بیمار"}`,start:a,end:n,allDay:!1,description:`Patient ID: ${r.id}`,color:"#00a76f"};console.log("Event data to send:",o),console.log("Start:",a,"End:",n),await Fn(o),await T.put(`${R.patients}/${c}`,{nextVisit:a},{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),M(d=>({...d,nextVisit:Te(a)})),D.success("نوبت ثبت شد و به تقویم اضافه گردید")}catch(t){console.error("Schedule visit error:",t),D.error("خطا در ثبت نوبت")}finally{k(!1)}},ea=i.useMemo(()=>y.map(t=>ue(t.path)),[y]),ln=i.useCallback(async()=>{var t,a,n,o,d,u,h,m,x,v,j,l,f,G,$,ae,O,W,K,ne,Ne,ke,Ge,Pe,Re,Fe,Ee,Be,B,ft,yt,xt,bt;if(y.length===0){D.error("ابتدا تصاویر بیمار را آپلود کنید");return}va(!0),Dt(null),Qe(0),Ze("در حال آماده‌سازی...");try{const z=[],Ue=Oa(7272),Oe=Wa();let We={},et;Qe(10),Ze("در حال آنالیز تصاویر داخل دهانی...");const He=y.filter(g=>{const{category:p}=g;return p==="intraoral"||p==="intra"||p==="occlusal-upper"||p==="occlusal-lower"||p==="occlusal"||p==="lateral-intraoral"||p==="lateral-intraoral-left"||p==="frontal-intraoral"});if(He.length>0)try{const g=H=>{const A={"کانین چپ":null,"مولر چپ":null,"کانین راست":null,"مولر راست":null};return H.forEach(({imageIndex:V,detections:ie,imageWidth:U,isLeftFromCategory:ce,isRightFromCategory:Bt,category:ee})=>{ie.forEach(P=>{const ge=P.class_name||"";let pe="";const jt=/class\s*(I{1,3})\s*([\d/]+)?/i,at=ge.match(jt);if(at){const Je=at[1],qe=at[2]||"";pe=`Cl ${Je}${qe?` ${qe}`:""}`}else pe=ge||"-";const wt=ge.toLowerCase(),de=wt.includes("canine"),vt=wt.includes("molar");let Me=!1,nt=!1;if(ce)Me=!0;else if(Bt)nt=!0;else{if(U){let Je=0,qe=!1;P.bbox?Array.isArray(P.bbox)&&P.bbox.length>=4?(Je=P.bbox[0]+P.bbox[2]/2,qe=!0):typeof P.bbox=="object"&&P.bbox.x1!==void 0&&(Je=(P.bbox.x1+P.bbox.x2)/2,qe=!0):P.x1!==void 0&&P.x2!==void 0&&(Je=(P.x1+P.x2)/2,qe=!0),qe&&Je>0&&(Me=Je<U/2,nt=!Me)}!Me&&!nt&&(Me=V===0,nt=V===1)}de&&(Me&&!A["کانین چپ"]?A["کانین چپ"]=pe:nt&&!A["کانین راست"]&&(A["کانین راست"]=pe)),vt&&(Me&&!A["مولر چپ"]?A["مولر چپ"]=pe:nt&&!A["مولر راست"]&&(A["مولر راست"]=pe))})}),[{occlusion:"کانین چپ",position:A["کانین چپ"]||"-"},{occlusion:"مولر چپ",position:A["مولر چپ"]||"-"},{occlusion:"کانین راست",position:A["کانین راست"]||"-"},{occlusion:"مولر راست",position:A["مولر راست"]||"-"}]},p=[];for(let H=0;H<He.length;H++){const A=He[H],V=ue(A.path),ie=A.category||"";let U=!1,ce=!1;ie==="lateral-intraoral-left"?U=!0:ie==="lateral-intraoral"&&(ce=!0);const ee=await(await fetch(V)).blob(),P=new File([ee],A.originalName||"image.jpg",{type:ee.type});let ge=0;try{const de=new Image;de.src=V,await new Promise((vt,Me)=>{de.onload=()=>{ge=de.width,vt()},de.onerror=Me})}catch(de){console.warn("Could not get image dimensions:",de),ge=1e3}const pe=new FormData;pe.append("file",P),pe.append("model","fyp2"),pe.append("conf","0.25");let jt;try{jt=await T.post(`${Oe}/predict`,pe,{headers:{"Content-Type":"multipart/form-data"},params:{model:"fyp2"},timeout:6e4,validateStatus:de=>de<500})}catch(de){console.warn("Unified API failed, trying backend API:",de.message),jt=await T.post(`${Ue}/api/predict?model=fyp2`,pe,{headers:{"Content-Type":"multipart/form-data"},timeout:6e4,validateStatus:vt=>vt<500})}const at=((t=jt.data)==null?void 0:t.detections)||[],wt=at.filter(de=>de.confidence>.25);p.push({imageIndex:H,detections:wt.length>0?wt:at,imageWidth:ge,isLeftFromCategory:U,isRightFromCategory:ce,category:ie})}const le=g(p);let ye="";le.some(H=>H.position&&H.position!=="-")?(ye=`اکلوژن دندان ها
`,le.forEach(H=>{H.position&&H.position!=="-"&&(ye+=`${H.occlusion}: ${H.position}
`)})):(ye=`اکلوژن دندان ها
`,ye+="مشکلی شناسایی نشد."),z.push({title:"آنالیز داخل دهانی",content:ye}),z.push({title:"جدول اکلوژن دندان‌ها",type:"occlusion-table",tableData:{occlusionData:le},content:""})}catch(g){let p="خطای نامشخص";g.code==="ECONNABORTED"||(a=g.message)!=null&&a.includes("timeout")?p="زمان انتظار به پایان رسید. لطفاً دوباره تلاش کنید.":g.response?g.response.status===500?p=((o=(n=g.response)==null?void 0:n.data)==null?void 0:o.error)||((u=(d=g.response)==null?void 0:d.data)==null?void 0:u.message)||"خطای سرور (500)":g.response.status===404?p="Endpoint یافت نشد. لطفاً با پشتیبانی تماس بگیرید.":g.response.status===503?p="سرویس در دسترس نیست. لطفاً بعداً تلاش کنید.":p=((m=(h=g.response)==null?void 0:h.data)==null?void 0:m.error)||((v=(x=g.response)==null?void 0:x.data)==null?void 0:v.message)||`خطای ${g.response.status}`:g.request?p="خطا در ارتباط با سرور. لطفاً اتصال اینترنت خود را بررسی کنید.":p=g.message||"خطای نامشخص",z.push({title:"آنالیز داخل دهانی",content:`خطا در انجام آنالیز داخل دهانی: ${p}
توصیه: لطفاً تصویر را مجدداً آپلود کنید یا از تب آنالیز داخل دهان استفاده کنید.`})}else z.push({title:"آنالیز داخل دهانی",content:`تصویر داخل دهانی یافت نشد.
توصیه: لطفاً تصاویر داخل دهانی را آپلود کنید تا آنالیز کامل‌تر شود.`});Qe(40),Ze("در حال آنالیز پروفایل صورت...");const tt=y.filter(g=>g.category==="profile"||g.category==="frontal");if(tt.length>0)try{const g=tt[0],p=ue(g.path),ye=await(await fetch(p)).blob(),Ve=new File([ye],g.originalName||"image.jpg",{type:ye.type}),H=new FormData;H.append("file",Ve);let A=[],V="";const ie=await T.post(`${Ue}/api/ai/facial-landmark?model=face_alignment`,H,{headers:{"Content-Type":"multipart/form-data"},validateStatus:ce=>ce===200||ce===503});if(ie.status===503)throw new Error("مدل Face Alignment در دسترس نیست (Service Unavailable)");A=((j=ie.data)==null?void 0:j.landmarks)||[],et={landmarks:A,measurements:(l=ie.data)==null?void 0:l.measurements};const U=ie.status===200&&(((f=ie.data)==null?void 0:f.success)===!0||A&&A.length>0);if(U&&A&&A.length>0){if(V=`لندمارک‌های شناسایی شده: ${A.length} نقطه کلیدی
`,V+=`مدل استفاده شده: Face Alignment (دقت بالا)
`,(G=ie.data)!=null&&G.measurements){const{measurements:ce}=ie.data;ce.facialAngle&&(V+=`زاویه پروفایل صورت: ${ce.facialAngle.toFixed(1)}°
`),ce.nasolabialAngle&&(V+=`زاویه نازولیبیال: ${ce.nasolabialAngle.toFixed(1)}°
`)}V+=`
وضعیت: تحلیل پروفایل صورت با موفقیت انجام شد. برای بررسی دقیق‌تر و محاسبه پارامترهای صورت، به تب آنالیز صورت مراجعه کنید.`}else ie.status===200?(V=`آنالیز پروفایل صورت انجام شد اما لندمارک‌های کافی شناسایی نشد.
`,V+=`تعداد لندمارک‌های شناسایی شده: ${(A==null?void 0:A.length)||0}
`,V+="توصیه: لطفاً تصویر پروفایل واضح‌تری آپلود کنید یا از تب آنالیز صورت استفاده کنید."):V=`خطا در شناسایی لندمارک‌های صورت.
توصیه: لطفاً تصویر پروفایل واضح‌تری آپلود کنید.`;z.push({title:"آنالیز پروفایل صورت",content:V}),console.log("[Facial Analysis] Section added:",{title:"آنالیز پروفایل صورت",contentLength:V.length,landmarksCount:(A==null?void 0:A.length)||0,success:U})}catch(g){const p=((ae=($=g.response)==null?void 0:$.data)==null?void 0:ae.error)||g.message||"خطای نامشخص";let le="";((O=g.response)==null?void 0:O.status)===503||(W=g.message)!=null&&W.includes("Service Unavailable")||p.includes("Service Unavailable")?le=`مدل Face Alignment در دسترس نیست (Service Unavailable).
لطفاً با پشتیبانی تماس بگیرید یا از تب آنالیز صورت استفاده کنید.`:p.includes("not installed")||p.includes("face-alignment")?le="مدل آنالیز صورت در دسترس نیست. لطفاً با پشتیبانی تماس بگیرید یا از تب آنالیز صورت استفاده کنید.":le=`خطا در انجام آنالیز پروفایل: ${p}
توصیه: لطفاً تصویر را مجدداً آپلود کنید یا از تب آنالیز صورت استفاده کنید.`,z.push({title:"آنالیز پروفایل صورت",content:le})}else z.push({title:"آنالیز پروفایل صورت",content:`تصویر پروفایل یافت نشد.
توصیه: لطفاً تصاویر پروفایل یا فرونتال را آپلود کنید تا آنالیز کامل‌تر شود.`});Qe(70),Ze("در حال آنالیز لترال سفالومتری...");const F=y.filter(g=>g.category==="lateral"||g.category==="cephalometric"||g.category==="cephalometry");if(F.length>0)try{const g=F[0],p=ue(g.path);console.log("[Cephalometric Analysis] Fetching image from:",p);const le=await fetch(p);if(!le.ok)throw new Error(`Failed to fetch image: ${le.status} ${le.statusText}`);const ye=await le.blob();console.log("[Cephalometric Analysis] Image blob size:",ye.size,"bytes");const Ve=new FileReader,H=await new Promise((ee,P)=>{Ve.onloadend=()=>{const{result:ge}=Ve;console.log("[Cephalometric Analysis] Base64 image length:",(ge==null?void 0:ge.length)||0),ee(ge)},Ve.onerror=P,Ve.readAsDataURL(ye)});let A;console.log("[Cephalometric Analysis] Unified AI Service URL:",Oe),console.log("[Cephalometric Analysis] Attempting to call unified API:",`${Oe}/detect-cldetection2023`);try{A=await T.post(`${Oe}/detect-cldetection2023`,{image_base64:H},{timeout:12e4,validateStatus:ee=>ee<500,headers:{"Content-Type":"application/json"}}),console.log("[Cephalometric Analysis] Unified API response status:",A==null?void 0:A.status)}catch(ee){console.warn("[Cephalometric Analysis] Unified API failed, trying backend API:",ee.message),console.warn("[Cephalometric Analysis] Unified error details:",{message:ee.message,code:ee.code,response:(K=ee.response)==null?void 0:K.data,status:(ne=ee.response)==null?void 0:ne.status});try{console.log("[Cephalometric Analysis] Attempting to call backend API:",`${Ue}/api/detect-cldetection2023`),A=await T.post(`${Ue}/api/detect-cldetection2023`,{image_base64:H},{timeout:12e4,validateStatus:P=>P<500,headers:{"Content-Type":"application/json"}}),console.log("[Cephalometric Analysis] Backend API response status:",A==null?void 0:A.status)}catch(P){throw console.error("[Cephalometric Analysis] Backend API also failed:",P.message),console.error("[Cephalometric Analysis] Backend error details:",{message:P.message,code:P.code,response:(Ne=P.response)==null?void 0:Ne.data,status:(ke=P.response)==null?void 0:ke.status}),ee}}const V={...((Ge=A.data)==null?void 0:Ge.landmarks)||{}},ie=Object.values(V).filter(ee=>ee!=null).length;let U=((Pe=A.data)==null?void 0:Pe.measurements)||{};(!U||Object.keys(U).length===0)&&(U=Na(V)),We={SNA:U.SNA,SNB:U.SNB,ANB:U.ANB,FMA:U.FMA,FMIA:U.FMIA,IMPA:U.IMPA,"U1-SN":U["U1-SN"],"L1-MP":U["L1-MP"],GoGnSN:U.GoGnSN};const ce=Pn(We,et),Bt=Rn(ce);z.push({title:"جدول پارامترهای سفالومتری",type:"table",tableData:{measurements:We},content:""}),z.push({title:"آنالیز لترال سفالومتری",content:Bt})}catch(g){let p="خطای نامشخص";g.code==="ECONNABORTED"||(Re=g.message)!=null&&Re.includes("timeout")?p="زمان انتظار به پایان رسید. لطفاً دوباره تلاش کنید.":g.response?g.response.status===500?p=((Ee=(Fe=g.response)==null?void 0:Fe.data)==null?void 0:Ee.error)||((B=(Be=g.response)==null?void 0:Be.data)==null?void 0:B.message)||"خطای سرور (500)":g.response.status===404?p="Endpoint یافت نشد. لطفاً با پشتیبانی تماس بگیرید.":g.response.status===503?p="سرویس در دسترس نیست. لطفاً بعداً تلاش کنید.":p=((yt=(ft=g.response)==null?void 0:ft.data)==null?void 0:yt.error)||((bt=(xt=g.response)==null?void 0:xt.data)==null?void 0:bt.message)||`خطای ${g.response.status}`:g.request?p="خطا در شبکه. لطفاً اتصال اینترنت خود را بررسی کنید.":p=g.message||"خطای نامشخص",z.push({title:"آنالیز لترال سفالومتری",content:`خطا در انجام آنالیز سفالومتری: ${p}
توصیه: لطفاً تصویر را مجدداً آپلود کنید یا از تب آنالیز سفالومتری استفاده کنید.`})}else z.push({title:"آنالیز لترال سفالومتری",content:`تصویر لترال سفالومتری یافت نشد.
توصیه: لطفاً تصاویر لترال را آپلود کنید تا آنالیز کامل‌تر و طرح درمان ارائه شود.`});Qe(100),Ze("در حال آماده‌سازی نتایج..."),console.log("[Complete Analysis] Final sections:",{count:z.length,sections:z.map(g=>{var p;return{title:g.title,contentLength:((p=g.content)==null?void 0:p.length)||0}})}),z.length>0?(Dt([...z]),console.log("[Complete Analysis] Report set with",z.length,"sections")):(console.warn("[Complete Analysis] No sections to display!"),Dt([{title:"هیچ آنالیز انجام نشد",content:"هیچ آنالیز انجام نشد. لطفاً مطمئن شوید که تصاویر مناسب آپلود شده‌اند."}]))}catch(z){console.error("Complete analysis error:",z),D.error("خطا در انجام آنالیز کامل"),Dt([{title:"خطا",content:`خطا در انجام آنالیز: ${z.message||"خطای نامشخص"}
توصیه: لطفاً دوباره تلاش کنید یا با پشتیبانی تماس بگیرید.`}])}finally{va(!1),Qe(0),Ze("")}},[y,Na]);i.useCallback(async()=>{var t;if(y.length===0){alert("ابتدا تصاویر بیمار را آپلود کنید تا AI بتواند آن‌ها را تحلیل کند");return}k(!0);try{const a=await T.post(R.aiDiagnosis,{images:ea,patientInfo:{name:r.name,age:r.age,diagnosis:r.aiDiagnosis||""},analysisType:"intraoral_extraoral"},{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),n=`# تحلیل داخل دهانی و خارج دهانی بیمار

## 📊 تحلیل داخل دهانی (Intraoral Analysis):

### ��ویه‌ها و شرایط فعلی:
- **چیدمان د��دان‌های فوقانی**: بررسی تراز و آلیمنتاسیون دندان‌های فک بالا
- **چیدمان دندان‌های تحتانی**: تحلیل موقعیت نسبی دندان‌های فک پایین
- **روابط اکلوژن**: بررسی تماس دندان‌��ا در موقعیت‌های مختلف
- **فضاهای موجود**: ارزیابی دیاستماها و فضای از دست رفته
- **حرکات غیرطبیعی**: بررسی لاترالیسیون و پروتروزیو

### شاخص‌های کلیدی:
- **کلاس مولار**: ${Math.random()>.5?"کلاس I (طبیعی)":"کلاس II (دومی)"}
- **کلاس کانین**: ${Math.random()>.5?"کلاس I":"کلاس II"}
- **دیستما**: ${Math.random()>.3?"موجود در ناحیه تحتانی":"وجود ندارد"}
- **کراودینگ**: ${Math.floor(Math.random()*5)+Math.random()>.5?"ملایم":"متوسط"}

## 👀 تحلیل خارج دهانی (Extraoral Analysis):

### ویژگی‌های صورت:
- **تقارن صورتی**: ${Math.random()>.7?"قرینگی مناسب":"تقارن نسبی"}
- **پروفایل**: ${Math.random()>.6?"پروفایل مستقیم":"پروفایل کن��کس"}
- **زاویه‌های صورت**: ارزیابی زاویه‌های مسر و مرکز
- **لب‌ها**: وضعیت لب بالایی و تحتانی در حالت rest
- **چانه**: ارزیابی پرومیننس چانه از طرفین

### شاخص‌های زیبایی‌شناسی:
- **خط افقی چشم**: ارزیابی موقعی�� چشم نسبت به چهره
- **زاویه نهاری**: ${Math.floor(Math.random()*30)+90} درجه
- **نسبت طلایی**: ارزیابی نسبت چهره از دید زیبایی‌شناسی
- **لبخند**: تحلیل شکل و عرض لبخند بیمار

## 🦷 تحلیل جامع شرایط فعلی:

### شرایط عمومی بیمار:
- سن بیمار: ${(r==null?void 0:r.age)||"N/A"} سال
- جنسیت: ${(t=r==null?void 0:r.name)!=null&&t.split(" ")[0]?"تعیین شده":"N/A"}
- وضعیت عمومی: عالی برای شروع درمان

### اقدامات پیشنهادی کوتاه‌مدت:
۱. ویزیت تخصصی برای بر��سی دقیق‌تر
۲. تهیه رادیوگرافی‌های تکمیلی در صورت نیاز
۳. ارزیاب�� نیاز به درمان‌های تخصصی‌تر

📋 **نتیجه**: تحلیل اولیه نشان‌دهنده نیاز به ارزیابی تخصصی بیشتر دارد.`;let o="";if(ht!==""){const u=await T.post(R.aiDiagnosis,{images:ea.filter(h=>h.includes("lateral")||h.includes("radiology")||h.includes("ceph")||h.includes("opg")),patientInfo:{name:r.name,age:r.age},analysisType:"radiology_cephalography",aiModel:ht},{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}});o=`
## 🩻 تحلیل رادیولوژی و سفالوگرافی (به کمک ${ht==="gpt-4o"?"GPT-4o":ht==="claude-3.5"?"Claude 3.5 Sonnet":"مدل محلی"}):

### تحلیل رادیولوژیک:
- **OPG یافته‌ها**: تحلیل پانوراما برای ارزیابی استخوان‌ها و دندان‌ها
- **مشکلات پریودنتال**: ارزیابی وضعیت بافت نگهدارنده دندان
- **تغییرات استخوانی**: بررسی مشکلات cysts، tumors، یا impacted teeth
- **تراکم استخوانی**: ارزیابی کیفیت استخوان فکی

### تحلیل سفالومتریک:
- **آنالیز استاینر**: ارزیابی پارامترهای SNA=${82+Math.floor(Math.random()*10)}, SNB=${78+Math.floor(Math.random()*8)}
- **زاویه‌های کلیدی**: MP/SN=${32+Math.floor(Math.random()*8)}°, FMA=${25+Math.floor(Math.random()*10)}°
- **روابط اسکلتال**: کلاس ${Math.random()>.5?"I":"II"} اسکلتال
- **پروفایل بافت نرم**: تحلیل موقعیت لب و چانه

### اقدامات تشخیصی مورد نیاز:
۱. Cephalometric Analysis کامل برای برنامه‌ریزی درمان
۲. CBCT در صورت نیاز برای ارزیابی سه‌بعدی
۳. ارزیابی بیمارستانی برای درمان‌های تخصصی‌تر در صورت لزوم

---

**⚠️ توجه**: این تحلیل اولیه بوده و نیاز به تأیید متخصص رادیولوژی و ارتودنتیست دارد.`}const d=n+o;M({...r,aiDiagnosis:d,softTissue:a.data.softTissueAnalysis||r.softTissue,cephalometric:a.data.cephalometricAnalysis||r.cephalometric}),se(!0),setTimeout(()=>se(!1),3e3)}catch(a){console.error("AI Diagnosis error:",a),alert("��طا در تحلیل تصاویر با AI. دوباره تلاش کنید.")}finally{k(!1)}},[y,ea,r,ht,s==null?void 0:s.accessToken]);const $a=i.useCallback(async(t={},a=null)=>{if(!r&&!a)return;_e.current&&clearTimeout(_e.current);const n=a||r;if(t.silent){try{const o={cephalometricAnalysis:n.cephalometric||"",cephalometricTableData:n.cephalometricTable?JSON.stringify(n.cephalometricTable):null,cephalometricRawData:n.cephalometricRawData?JSON.stringify(n.cephalometricRawData):null,cephalometricLandmarks:n.cephalometricLandmarks?JSON.stringify(n.cephalometricLandmarks):null};await T.put(`${R.patients}/${c}`,o,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),console.log("💾 Cephalometric data auto-saved successfully",{hasTableData:!!o.cephalometricTableData,hasRawData:!!o.cephalometricRawData,hasLandmarks:!!o.cephalometricLandmarks})}catch(o){console.error("Auto-save error:",o)}return}k(!0);try{const o={cephalometricAnalysis:n.cephalometric||"",cephalometricTableData:n.cephalometricTable?JSON.stringify(n.cephalometricTable):null,cephalometricRawData:n.cephalometricRawData?JSON.stringify(n.cephalometricRawData):null,cephalometricLandmarks:n.cephalometricLandmarks?JSON.stringify(n.cephalometricLandmarks):null};console.log("💾 Saving cephalometric data:",{hasTableData:!!o.cephalometricTableData,hasRawData:!!o.cephalometricRawData,hasLandmarks:!!o.cephalometricLandmarks,rawDataKeys:n.cephalometricRawData?Object.keys(n.cephalometricRawData).length:0,landmarksKeys:n.cephalometricLandmarks?Object.keys(n.cephalometricLandmarks).length:0}),await T.put(`${R.patients}/${c}`,o,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),D.success("پارامترهای سفالومتری با موفقیت ذخیره شد")}catch(o){console.error("Save error:",o),D.error("خطا در ذخیره پارامترهای سفالومتری")}finally{k(!1)}},[r,c,s==null?void 0:s.accessToken]),[ta,La]=i.useState(0),[Et,cn]=i.useState(10);i.useCallback((t,a)=>{M(n=>{const o=n!=null&&n.cephalometricTable?{...n.cephalometricTable}:{};o[t]={...o[t],measured:a||""};const d={...n,cephalometricTable:o};if(a&&a!==""){const u=parseFloat(a);isNaN(u)||(d.cephalometricRawData={...(n==null?void 0:n.cephalometricRawData)||{},[t]:u})}return d}),_e.current&&clearTimeout(_e.current),_e.current=setTimeout(()=>{$a({silent:!0})},2e3)},[$a]);const Ga=i.useCallback((t,a,n)=>{if(!t||t===""||!a||a===""||!n||n==="")return"تعریف نشده";const o=parseFloat(t),d=parseFloat(a),u=parseFloat(n);if(isNaN(o)||isNaN(d)||isNaN(u))return"تعریف نشده";const h=d+u,m=d-u;return o>h?"بالا":o<m?"پایین":"نرمال"},[]);i.useMemo(()=>r!=null&&r.cephalometricTable?Object.values(r.cephalometricTable).map(t=>{const n=String((t==null?void 0:t.mean)||"").trim().match(/^([\d.]+)/);if(!n)return null;const o=parseFloat(n[1]);return isNaN(o)?null:Math.min(o,125)}):[],[r==null?void 0:r.cephalometricTable]),i.useMemo(()=>{if(!(r!=null&&r.cephalometricTable)||!(r!=null&&r.cephalometricRawData))return null;const t=r.cephalometricRawData,a=r.cephalometricTable,n=O=>{var W;if(t[O]!==void 0&&t[O]!==null&&t[O]!=="")return parseFloat(t[O]);if((W=a[O])!=null&&W.measured){const K=parseFloat(a[O].measured);return isNaN(K)?null:K}return null},o=O=>{const W=a[O];if(!(W!=null&&W.mean)||!(W!=null&&W.sd))return null;const K=parseFloat(W.mean),ne=parseFloat(W.sd);return isNaN(K)||isNaN(ne)?null:{mean:K,sd:ne,upper:K+ne,lower:K-ne}},d=[],u=n("SNA"),h=o("SNA");u!==null&&h&&(u>h.upper?d.push("ماگزیلا در موقعیت قدامی قرار دارد"):u<h.lower&&d.push("ماگزیلا در موقعیت خلفی قرار دارد"));const m=n("SNB"),x=o("SNB");m!==null&&x&&(m>x.upper?d.push("مندیبل در موقعیت قدامی قرار دارد"):m<x.lower&&d.push("مندیبل در موقعیت خلفی قرار دارد"));const v=n("ANB"),j=o("ANB");v!==null&&j&&(v>j.upper?d.push("کلاس II اسکلتی"):v<j.lower?d.push("کلاس III اسکلتی"):d.push("کلاس I اسکلتی"));const l=n("FMA"),f=o("FMA");l!==null&&f&&(l>f.upper?d.push("الگوی رشد عمودی"):l<f.lower&&d.push("الگوی رشد افقی"));const G=n("IMPA"),$=o("IMPA");return G!==null&&$&&(G>$.upper?d.push("دندان‌های قدامی پایین به سمت جلو"):G<$.lower&&d.push("دندان‌های قدامی پایین به سمت عقب")),d.length===0?{summary:"بر اساس نتایج آنالیز سفالومتری، پارامترهای اصلی در محدوده نرمال قرار دارند. توصیه می‌شود بررسی دقیق‌تر با متخصص ارتودنسی انجام شود.",sections:[]}:{summary:`بر اساس نتایج آنالیز سفالومتری:

${d.join(`
`)}

توصیه می‌شود برای بررسی دقیق‌تر و تعیین طرح درمان مناسب با متخصص ارتودنسی مشورت شود.`,sections:[{title:"📊 خلاصه نتایج آنالیز",issues:d}]}},[r==null?void 0:r.cephalometricTable,r==null?void 0:r.cephalometricRawData]);const Pa=i.useMemo(()=>!(r!=null&&r.cephalometricTable)||typeof r.cephalometricTable!="object"?[]:Object.entries(r.cephalometricTable).map(([t,a])=>{const n=(a==null?void 0:a.measured)||"",o=(a==null?void 0:a.mean)||"",d=(a==null?void 0:a.sd)||"",u=Ga(n,o,d);let h=n;if(n&&n!==""&&n!=="undefined"&&n!=="null"){const m=parseFloat(n);isNaN(m)||(h=m.toFixed(1),h.includes(".")&&(h=h.replace(/\.?0+$/,"")))}return{parameter:t,mean:o,sd:d,meanDisplay:d?`${o} ± ${d}`:o||"-",measured:h,severity:u,note:(a==null?void 0:a.note)||"-"}}),[r==null?void 0:r.cephalometricTable,Ga]);i.useCallback((t,a)=>{La(a)},[]),i.useCallback(t=>{cn(parseInt(t.target.value,10)),La(0)},[]),i.useMemo(()=>Pa.slice(ta*Et,ta*Et+Et),[Pa,ta,Et]);const dn=i.useCallback(async()=>{if(r){k(!0);try{await T.put(`${R.patients}/${c}`,{treatmentPlan:r.treatmentPlan||""},{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),se(!0),te.current&&clearTimeout(te.current),te.current=setTimeout(()=>se(!1),3e3)}catch(t){console.error("Save error:",t),alert("خطا در ذخیره طرح درمان")}finally{k(!1)}}},[r,c,s==null?void 0:s.accessToken]),mn=i.useCallback(async()=>{if(r){k(!0);try{await T.put(`${R.patients}/${c}`,{summary:r.summary||""},{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),se(!0),te.current&&clearTimeout(te.current),te.current=setTimeout(()=>se(!1),3e3)}catch(t){console.error("Save error:",t),alert("خطا در ذخیره خلاصه")}finally{k(!1)}}},[r,c,s==null?void 0:s.accessToken]);i.useCallback(()=>{ha(!0),kt("profile"),Vt([])},[]);const aa=i.useCallback(()=>{ha(!1),kt("profile"),Vt([])},[]),na=i.useCallback(t=>{t&&(it(t),Ke(t.category||"general"),st(!0))},[]),hn=i.useCallback(async()=>{var t,a;if(!Z||!c){D.error("خطا در اطلاعات تصویر یا بیمار"),st(!1),setTimeout(()=>{it(null),Ke("general")},200);return}if(Z.category===Mt){D.info("نوع تصویر تغییر نکرده است"),st(!1),setTimeout(()=>{it(null),Ke("general")},200);return}try{k(!0);const n=ue(Z.path);let o;try{const h=await fetch(n);if(!h.ok)throw new Error(`Failed to fetch image: ${h.status} ${h.statusText}`);const m=await h.blob();o=new File([m],Z.originalName||`image-${Z.id}.png`,{type:Z.mimeType||m.type||"image/png"})}catch{D.error("خطا در دانلود تصویر. لطفاً دوباره تلاش کنید.");return}try{await T.delete(`${R.patients}/${c}/images`,{data:{imageId:Z.id},headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`,"Content-Type":"application/json"}})}catch{D.warning("خطا در حذف تصویر قدیمی، اما آپلود ادامه خواهد یافت")}const d=new FormData;d.append("images",o),d.append("category",Mt),await T.post(`${R.patients}/${c}/images`,d,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`,"Content-Type":"multipart/form-data"}}),D.success("نوع تصویر با موفقیت ویرایش شد");const u=await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}});S(u.data.images||[])}catch(n){const o=((a=(t=n.response)==null?void 0:t.data)==null?void 0:a.message)||n.message||"خطا در ویرایش نوع تصویر";throw D.error(o),n}finally{k(!1),st(!1),setTimeout(()=>{it(null),Ke("general")},200)}},[c,s==null?void 0:s.accessToken,Z,Mt]),Ra=i.useCallback(()=>{st(!1),setTimeout(()=>{it(null),Ke("general")},200)},[]),[un,ra]=i.useState(null),[Fa,gt]=i.useState(!1);i.useEffect(()=>{if(Z&&Jt){gt(!1);const t=document.createElement("img"),a=ue(Z.path);t.src=a,t.onload=()=>{ra(t.src),gt(!0)},t.onerror=()=>{ra(null),gt(!1)}}else{const t=setTimeout(()=>{ra(null),gt(!1)},200);return()=>clearTimeout(t)}},[Z,Jt]);const gn=i.useCallback(async t=>{try{const a=ue(t.path);pa({meta:t,src:a}),ga(!0)}catch{D.error("خطا در بارگذاری تصویر برای برش")}},[]),Ea=i.useCallback(()=>{ga(!1),pa(null)},[]),pn=async(t,a,n)=>{if(!(!Xe||!n))try{k(!0);const o=await new Promise(m=>n.toBlob(m,"image/png"));if(!o)throw new Error("crop failed");const d=new File([o],`cropped-${Date.now()}.png`,{type:"image/png"}),u=new FormData;u.append("images",d),u.append("category",Xe.meta.category),await T.post(`${R.patients}/${c}/images`,u,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}}),await T.delete(`${R.patients}/${c}/images`,{data:{imageId:Xe.meta.id},headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`,"Content-Type":"application/json"}});const h=await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}});S(h.data.images||[]),Ea(),D.success("تصویر با موفقیت برش داده شد")}catch(o){console.error(o),D.error("خطا در ذخیره برش تصویر")}finally{k(!1)}},fn=async()=>{if(ot.length===0){alert("لطفا حداقل یک فایل انتخاب کنید");return}try{await Ft(ot,Nt),aa(),se(!0),setTimeout(()=>se(!1),3e3)}catch(t){console.error("Upload error:",t)}},yn=rt.memo(({title:t,category:a,patientImages:n,onImageUpload:o,onImageDelete:d})=>{const u=i.useMemo(()=>(n==null?void 0:n[a])||[],[n,a]),h=i.useMemo(()=>u.map(l=>{var O;const f=ue(l.path),G=l.originalName||l.name||`image-${l.id}.jpg`,$=l.size||l.fileSize||((O=l.file)==null?void 0:O.size);return{name:G,size:$&&$>0?$:void 0,path:f,preview:f,type:l.mimeType||"image/jpeg",_imageId:l.id}}),[u]),m=i.useMemo(()=>{const l=new Map;return h.forEach(f=>{l.set(f.path,f._imageId),l.set(f.name,f._imageId)}),l},[h]),x=i.useCallback(async l=>{l&&l.length>0&&await o(l,a)},[a,o]),v=i.useCallback(async l=>{let f;if(typeof l=="number"){const G=u[l];f=G==null?void 0:G.id}else l!=null&&l._imageId?f=l._imageId:l!=null&&l.path?f=m.get(l.path):l!=null&&l.name?f=m.get(l.name):typeof l=="string"&&(f=m.get(l));f&&await d(f)},[u,m,d]),j=h;return t?e.jsxs(xe,{sx:{p:3},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:t}),e.jsx(b,{sx:{minHeight:u.length>0?"auto":200,position:"relative"},children:e.jsx(_t,{multiple:!0,value:j,onDrop:x,onRemove:v,accept:{"image/*":[".jpg",".jpeg",".png"]},sx:{minHeight:u.length>0?"auto":200}})})]}):e.jsx(_t,{multiple:!0,value:j,onDrop:x,onRemove:v,accept:{"image/*":[".jpg",".jpeg",".png"]}})},(t,a)=>t.title===a.title&&t.category===a.category&&t.patientImages===a.patientImages&&t.onImageUpload===a.onImageUpload&&t.onImageDelete===a.onImageDelete),Ie=i.useCallback((t,a,n=3)=>e.jsx(yn,{title:t,category:a,patientImages:r==null?void 0:r.images,onImageUpload:Ft,onImageDelete:Da}),[r==null?void 0:r.images,Ft,Da]),xn=t=>({profile:"پروفایل",frontal:"فرونتال",panoramic:"پانورامیک",lateral:"لترال سفالومتری","occlusal-upper":"اکلوزال بالا","occlusal-lower":"اکلوزال پایین","lateral-intraoral":"لترال راست دهان","lateral-intraoral-left":"لترال چپ دهان","frontal-intraoral":"فرونتال داخل دهان",occlusal:"اکلوزال",intraoral:"داخل دهانی",general:"کلی",cephalometric:"سفالومتری",cephalometry:"سفالومتری",intra:"داخل دهانی",opg:"OPG"})[t]||t||"نامشخص",bn=i.useMemo(()=>!y||y.length===0?[]:y.filter(t=>{const{category:a}=t;return a==="intraoral"||a==="intra"||a==="occlusal-upper"||a==="occlusal-lower"||a==="occlusal"||a==="lateral-intraoral"||a==="lateral-intraoral-left"||a==="frontal-intraoral"}),[y]),he=i.useMemo(()=>({"& .MuiInputBase-input":{fontSize:"0.75rem"},"& .MuiInputLabel-root":{fontSize:"0.75rem"},"& .MuiSelect-select":{fontSize:"0.75rem"}}),[]),pt=i.useMemo(()=>({MenuProps:{PaperProps:{sx:{"& .MuiMenuItem-root":{fontSize:"0.75rem"}}}}}),[]);return fe?e.jsx(sa,{maxWidth:"xl",children:e.jsxs(b,{sx:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",gap:2},children:[e.jsx(za,{size:48}),e.jsx(w,{variant:"body2",color:"text.secondary",children:"در حال بارگیری اطلاعات بیمار..."})]})}):r?e.jsxs(sa,{maxWidth:"xl",children:[e.jsxs(b,{className:"tab-content-container",sx:{mt:3,position:"relative",overflow:"hidden",minHeight:400,willChange:"contents",contain:"layout style"},children:[e.jsx(b,{sx:{display:N==="general"?"block":"none"},children:e.jsx("div",{className:`tab-content ${N==="general"?"active":""}`,style:{willChange:"transform, opacity",minHeight:"400px"},children:e.jsx(X,{spacing:3,children:e.jsxs(St,{container:!0,spacing:3,children:[e.jsx(St,{item:!0,xs:12,md:4,children:e.jsxs(xe,{sx:{p:3,height:"100%"},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"اطلاعات بیمار"}),e.jsxs(X,{spacing:2,children:[e.jsx(De,{fullWidth:!0,label:"نام و نام خانوادگی",value:r.name,onChange:t=>M({...r,name:t.target.value}),sx:he}),e.jsx(De,{fullWidth:!0,label:"سن",type:"number",value:r.age,onChange:t=>M({...r,age:t.target.value}),sx:he}),e.jsx(De,{fullWidth:!0,label:"شماره تماس",value:r.phone,onChange:t=>M({...r,phone:t.target.value}),sx:he}),e.jsxs(De,{fullWidth:!0,select:!0,label:"جنسیت",value:r.gender||"",onChange:t=>M({...r,gender:t.target.value}),sx:he,SelectProps:pt,children:[e.jsx(C,{value:"MALE",children:"مرد"}),e.jsx(C,{value:"FEMALE",children:"زن"}),e.jsx(C,{value:"OTHER",children:"سایر"})]}),e.jsx(Bn,{label:"تاریخ شروع درمان",value:r.startDate,onChange:t=>M(a=>({...a,startDate:t})),slotProps:{textField:{fullWidth:!0,sx:he}}}),e.jsx(zn,{label:"ویزیت بعدی",value:r.nextVisit,onChange:t=>M(a=>({...a,nextVisit:t})),slotProps:{textField:{fullWidth:!0,sx:he}}}),e.jsx(J,{variant:"contained",onClick:sn,disabled:E||!r.nextVisit,sx:{transition:"all 0.1s ease-in-out !important","&:active":{transform:"scale(0.98)"}},children:"ثبت نوبت"})]}),e.jsx(kn,{sx:{my:3}}),e.jsx(w,{variant:"h6",gutterBottom:!0,children:"وضعیت درمان"}),e.jsxs(X,{spacing:2,children:[e.jsxs(De,{fullWidth:!0,select:!0,label:"وضعیت",value:r.status,onChange:t=>M({...r,status:t.target.value}),sx:he,SelectProps:pt,children:[e.jsx(C,{value:"PENDING",children:"شروع درمان"}),e.jsx(C,{value:"IN_TREATMENT",children:"در حال درمان"}),e.jsx(C,{value:"COMPLETED",children:"اتمام درمان"}),e.jsx(C,{value:"CANCELLED",children:"متوقف شده"})]}),e.jsx(De,{fullWidth:!0,multiline:!0,rows:4,label:"یادداشت‌ها",value:r.notes,onChange:t=>M({...r,notes:t.target.value}),sx:he}),da&&e.jsx(_a,{severity:"success",sx:{mt:2},children:"اطلاعات با موفقیت ذخیره شد!"}),e.jsx(J,{variant:"contained",color:"primary",fullWidth:!0,onClick:on,disabled:E,sx:{mt:2,transition:"transform 0.1s ease-in-out","&:active":{transform:"scale(0.99)"}},children:E?"در حال ذخیره...":"ذخیره اطلاعات"})]})]})}),e.jsx(St,{item:!0,xs:12,md:8,children:e.jsxs(xe,{sx:{p:3},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"تصاویر بیمار"}),e.jsxs(X,{spacing:3,children:[e.jsx(xe,{sx:{pt:2},children:e.jsxs(X,{spacing:2,children:[e.jsxs(Ha,{fullWidth:!0,children:[e.jsx(Va,{sx:{fontSize:"0.75rem"},children:"نوع تصویر"}),e.jsxs(Ja,{value:Nt,label:"نوع تصویر",onChange:t=>kt(t.target.value),sx:he,MenuProps:pt.MenuProps,children:[e.jsx(C,{value:"profile",children:"پروفایل"}),e.jsx(C,{value:"frontal",children:"فرونتال"}),e.jsx(C,{value:"panoramic",children:"پانورامیک"}),e.jsx(C,{value:"lateral",children:"لترال سفالومتری"}),e.jsx(C,{value:"occlusal-upper",children:"اکلوزال بالا"}),e.jsx(C,{value:"occlusal-lower",children:"اکلوزال پایین"}),e.jsx(C,{value:"lateral-intraoral",children:"لترال راست دهان"}),e.jsx(C,{value:"lateral-intraoral-left",children:"لترال چپ دهان"}),e.jsx(C,{value:"frontal-intraoral",children:"فرونتال داخل دهان"})]})]}),e.jsxs(b,{sx:{mt:2},children:[e.jsx(w,{variant:"subtitle2",gutterBottom:!0,children:"آپلود فایل جدید"}),e.jsx(_t,{multiple:!0,hideFileList:!0,onDrop:t=>{t&&t.length>0&&Ft(t,Nt)},accept:{"image/*":[".jpg",".jpeg",".png"]},sx:{width:"100%",minHeight:120}})]})]})}),y.length>0&&e.jsxs(b,{sx:{mt:3},children:[e.jsxs(w,{variant:"subtitle2",sx:{mb:1},children:["فایل‌های آپلود شده (",y.length,")"]}),e.jsx(X,{spacing:0,children:y.map(t=>e.jsx(Qa,{item:t,onEdit:na,onDelete:Qt,getCategoryLabel:xn},t.id))})]}),e.jsx(b,{sx:{mt:3,display:"flex",justifyContent:"center",width:"100%"},children:e.jsxs(b,{sx:{position:"relative",width:"100%",borderRadius:1,display:"flex",alignItems:"center",justifyContent:"center"},children:[e.jsx(En,{animate:{duration:12,distance:40,color:[I.vars.palette.primary.main,I.vars.palette.warning.main],outline:`135deg, ${Ua(I.vars.palette.primary.mainChannel,.04)}, ${Ua(I.vars.palette.primary.mainChannel,.04)}`},sx:{width:1,height:1,position:"absolute",top:0,left:0,zIndex:2,pointerEvents:"none"}}),e.jsx(J,{fullWidth:!0,size:"large",variant:"contained",color:"primary",onClick:ln,disabled:Ye||y.length===0,sx:{mb:"0",position:"relative",zIndex:1,backgroundColor:I.vars.palette.primary.main,"&:hover":{backgroundColor:I.vars.palette.primary.dark},"&.Mui-disabled":{backgroundColor:I.vars.palette.action.disabledBackground}},startIcon:Ye?e.jsx(za,{size:16,sx:{color:"inherit"}}):e.jsx(re,{icon:"solar:scan-bold",width:20}),children:Ye?"در حال پردازش":"آنالیز"})]})}),Ye&&e.jsxs(b,{sx:{mt:3,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",py:4,width:"100%"},children:[e.jsxs(b,{sx:{width:48,height:48,display:"flex",alignItems:"center",justifyContent:"center",color:"primary.main",mb:3},children:[e.jsx("svg",{width:"32",height:"32",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",style:{animation:"spin 1s linear infinite"},children:e.jsx("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeDasharray:"31.416",strokeDashoffset:"23.562",fill:"none",opacity:"0.5"})}),e.jsx("style",{children:`
                          @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                          }
                        `})]}),e.jsxs(b,{sx:{width:"100%",maxWidth:400,mb:2},children:[e.jsx(Mn,{variant:"determinate",value:Aa,sx:{height:8,borderRadius:1,bgcolor:"grey.200","& .MuiLinearProgress-bar":{borderRadius:1}}}),e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",mt:1},children:[e.jsx(w,{variant:"caption",color:"text.secondary",children:en}),e.jsxs(w,{variant:"caption",color:"text.secondary",sx:{fontWeight:600},children:[Math.round(Aa),"%"]})]})]}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mt:1},children:"در حال انجام آنالیز کامل..."}),e.jsx(w,{variant:"caption",color:"text.secondary",sx:{mt:1},children:"لطفاً منتظر بمانید"})]}),(()=>{const t=q&&Array.isArray(q)&&q.length>0&&!Ye;return console.log("[Render] TypingReport visibility check:",{hasReport:!!q,isArray:Array.isArray(q),length:(q==null?void 0:q.length)||0,isRunning:Ye,shouldShow:t}),t?e.jsx(b,{sx:{mt:3},children:e.jsx(On,{sections:q,onComplete:()=>{console.log("Complete analysis finished")}},JSON.stringify(q.map(a=>({title:a.title,content:a.content}))))}):null})()]})]})})]})})},"general")}),e.jsxs(_n,{anchorReference:"anchorPosition",anchorPosition:$t?{top:$t.top,left:$t.left}:void 0,open:!!$t,onClose:Se,children:[e.jsxs(C,{onClick:()=>{if(ve){const t=ue(ve.path);window.open(t,"_blank")}Se()},children:[e.jsx(Ct,{children:e.jsx(re,{icon:"solar:eye-bold",width:18})}),e.jsx(At,{children:"مشاهده"})]}),e.jsxs(C,{onClick:()=>{ve&&na(ve),Se()},children:[e.jsx(Ct,{children:e.jsx(re,{icon:"solar:pen-bold",width:18})}),e.jsx(At,{children:"تغییر نوع"})]}),e.jsxs(C,{onClick:()=>{ve&&an(ve),Se()},children:[e.jsx(Ct,{children:e.jsx(re,{icon:"eva:arrow-circle-down-fill",width:18})}),e.jsx(At,{children:"دانلود"})]}),e.jsxs(C,{onClick:()=>{ve&&gn(ve),Se()},children:[e.jsx(Ct,{children:e.jsx(re,{icon:"solar:crop-linear",width:18})}),e.jsx(At,{children:"برش"})]}),e.jsxs(C,{onClick:()=>{ve&&Qt(ve)},children:[e.jsx(Ct,{children:e.jsx(re,{icon:"solar:trash-bin-trash-bold",width:18})}),e.jsx(At,{children:"حذف"})]})]}),e.jsxs(zt,{open:Xt,onClose:()=>{dt(!1),setTimeout(()=>{mt(null)},300)},maxWidth:"xs",fullWidth:!0,TransitionComponent:Tn,TransitionProps:{timeout:{enter:300,exit:200}},slotProps:{backdrop:{sx:{backgroundColor:"rgba(0, 0, 0, 0.5)"}}},sx:{"& .MuiDialog-container":{paddingRight:"var(--scrollbar-width, 0px)"}},children:[e.jsx(Ut,{children:"حذف تصویر"}),e.jsx(Ot,{children:e.jsx(w,{sx:{color:"text.secondary"},children:"آیا از حذف این تصویر مطمئن هستید؟ این عمل غیرقابل بازگشت است."})}),e.jsxs(Wt,{children:[e.jsx(J,{onClick:()=>{dt(!1),setTimeout(()=>{mt(null)},300)},color:"inherit",variant:"outlined",children:"انصراف"}),e.jsx(J,{onClick:tn,color:"error",variant:"contained",disabled:E,autoFocus:!0,children:E?"در حال حذف...":"حذف"})]})]}),e.jsx(b,{sx:{display:N==="images"?"block":"none"},children:e.jsx("div",{className:`tab-content ${N==="images"?"active":""}`,style:{willChange:"transform, opacity",minHeight:"400px"},children:e.jsxs(X,{spacing:3,children:[Ie("پروفایل","profile",3),Ie("فرونتال","frontal",3),Ie("پانورامیک","panoramic",2),Ie("لترال سفالومتری","lateral",2),Ie("اکلوزال بالا","occlusal-upper",5),Ie("اکلوزال پایین","occlusal-lower",5),Ie("لترال راست دهان","lateral-intraoral",5),Ie("لترال چپ دهان","lateral-intraoral-left",5),Ie("فرونتال داخل دهان","frontal-intraoral",5),e.jsx(xe,{sx:{p:3},children:e.jsxs(X,{spacing:2,children:[e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center"},children:[e.jsx(w,{variant:"h6",children:"تصاویر قدیمی (برای سازگاری)"}),e.jsx(J,{variant:"outlined",startIcon:e.jsx(re,{icon:"solar:magic-stick-3-bold"}),onClick:async()=>{var a;const t=((a=r==null?void 0:r.images)==null?void 0:a.general)||[];if(t.length===0){D.info("تصویر general برای تقسیم وجود ندارد");return}be(!0);try{const n=await Promise.all(t.map(async m=>{try{const x=ue(m.path),j=await(await fetch(x)).blob(),l=new File([j],m.originalName,{type:m.mimeType}),f=await ka(l);return{image:m,detectedCategory:f.category||"general",confidence:f.confidence||0,file:l}}catch(x){return console.error(`Error processing image ${m.id}:`,x),null}})),o={intraoral:[],lateral:[],profile:[],general:[]};n.forEach(m=>{if(!m)return;const{image:x,detectedCategory:v,confidence:j,file:l}=m;let f=j>=.3?v:"general";f==="frontal"&&(f="profile"),o[f]?o[f].push({image:x,file:l}):o.general.push({image:x,file:l})});for(const[m,x]of Object.entries(o)){if(x.length===0)continue;for(const{image:j}of x)try{await T.delete(`${R.patients}/${c}/images`,{data:{imageId:j.id},headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`,"Content-Type":"application/json"}})}catch(l){console.error(`Error deleting image ${j.id}:`,l)}const v=new FormData;x.forEach(({file:j})=>{v.append("images",j)}),v.append("category",m),await T.post(`${R.patients}/${c}/images`,v,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}})}const d=await T.get(`${R.patients}/${c}/images`,{headers:{Authorization:`Bearer ${s==null?void 0:s.accessToken}`}});S(d.data.images||[]);const u=d.data.images||[],h={profile:u.filter(m=>m.category==="profile"||m.category==="frontal"),lateral:u.filter(m=>m.category==="lateral"||m.category==="cephalometric"||m.category==="cephalometry"),intraoral:u.filter(m=>m.category==="intraoral"||m.category==="intra"),general:u.filter(m=>m.category==="general"||m.category==="opg"||m.category==="panoramic")};M(m=>({...m,images:h})),D.success(`تعداد ${n.length} تصویر با موفقیت تقسیم شدند`)}catch(n){console.error("Error auto-categorizing images:",n),D.error("خطا در تقسیم خودکار تصاویر")}finally{be(!1)}},disabled:$e||!((Ba=r==null?void 0:r.images)!=null&&Ba.general)||r.images.general.length===0,children:"تقسیم خودکار تصاویر general"})]}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"تصاویر general شامل انواع مختلف تصاویر است. با کلیک روی دکمه بالا، تصاویر به صورت خودکار در دسته‌های مناسب قرار می‌گیرند."}),e.jsx(J,{variant:"outlined",color:"primary",startIcon:e.jsx(re,{icon:"solar:scissors-square-bold"}),onClick:()=>{Tt(!0),ze(null),ct([]),Le(new Set)},sx:{mb:2},children:"تقسیم تصویر کلی (Composite Image)"}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"اگر یک تصویر کلی دارید که شامل چندین عکس است (مثلاً 3x3 grid)، از این دکمه استفاده کنید تا تصویر به بخش‌های ��جزا تقسیم شود."})]})})]})},"images")}),e.jsx(b,{sx:{display:N==="intra-oral"?"block":"none"},children:e.jsx("div",{className:`tab-content ${N==="intra-oral"?"active":""}`,style:{willChange:"transform, opacity",minHeight:"400px"},children:e.jsx(b,{sx:{"& .MuiContainer-root":{maxWidth:"100%",px:0}},children:e.jsx(rt.Suspense,{fallback:null,children:e.jsx(Hn,{initialImages:bn,onEditCategory:na,onDeleteImage:Qt,patientId:c})})})},"intra-oral")}),e.jsx(b,{sx:{display:N==="treatment"?"block":"none"},children:e.jsx("div",{className:`tab-content ${N==="treatment"?"active":""}`,style:{willChange:"transform, opacity",minHeight:"400px"},children:e.jsxs(X,{spacing:3,children:[(r==null?void 0:r.cephalometricTable)&&Object.keys(r.cephalometricTable).length>0&&(()=>{const t={};return Object.entries(r.cephalometricTable).forEach(([a,n])=>{if(n!=null&&n.measured&&n.measured!==""&&n.measured!=="undefined"&&n.measured!=="null"){const o=parseFloat(n.measured);isNaN(o)||(t[a]=o)}}),Object.keys(t).length>0?e.jsxs(xe,{sx:{p:3},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"جدول پارامترهای سفالومتری"}),e.jsx(ca,{measurements:t})]}):null})(),e.jsxs(xe,{sx:{p:3},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"طرح درمان"}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"طرح درمان به کمک AI پیشنهاد می‌شود"}),e.jsx(De,{fullWidth:!0,multiline:!0,rows:8,label:"طرح درمان پیشنهادی",value:r.treatmentPlan,onChange:t=>M({...r,treatmentPlan:t.target.value}),sx:he}),e.jsxs(X,{direction:"row",spacing:2,sx:{mt:2},children:[e.jsx(J,{variant:"outlined",startIcon:e.jsx(re,{icon:"solar:refresh-bold"}),children:"تولید مجدد AI"}),e.jsx(J,{variant:"contained",color:"primary",onClick:dn,sx:{transition:"transform 0.1s ease-in-out","&:active":{transform:"scale(0.99)"}},children:"ذخیره تغییرات"})]})]})]})},"treatment")}),e.jsx(b,{sx:{display:N==="summary"?"block":"none"},children:e.jsx("div",{className:`tab-content ${N==="summary"?"active":""}`,style:{willChange:"transform, opacity",minHeight:"400px"},children:e.jsxs(xe,{sx:{p:3},children:[e.jsx(w,{variant:"h6",gutterBottom:!0,children:"خلاصه پرونده بیمار"}),e.jsx(De,{fullWidth:!0,multiline:!0,rows:6,label:"خلاصه پرونده",value:r.summary,sx:he,onChange:t=>M({...r,summary:t.target.value})}),e.jsxs(X,{direction:"row",spacing:2,sx:{mt:2},children:[e.jsx(J,{variant:"outlined",startIcon:e.jsx(re,{icon:"solar:printer-bold"}),children:"پرینت خلاصه"}),e.jsx(J,{variant:"contained",color:"primary",onClick:mn,sx:{transition:"transform 0.1s ease-in-out","&:active":{transform:"scale(0.99)"}},children:"ذخیره تغییرات"})]})]})},"summary")})]}),ma&&e.jsx(i.Suspense,{fallback:null,children:e.jsxs(zt,{open:ma,onClose:aa,maxWidth:"md",fullWidth:!0,children:[e.jsx(Ut,{children:"آپلود تصویر بیمار"}),e.jsx(Ot,{children:e.jsxs(X,{spacing:3,sx:{pt:1,px:{xs:1.5,sm:3},pb:1},children:[e.jsxs(De,{select:!0,label:"نوع تصویر",value:Nt,onChange:t=>kt(t.target.value),fullWidth:!0,sx:he,SelectProps:pt,children:[e.jsx(C,{value:"profile",children:"پروفایل"}),e.jsx(C,{value:"frontal",children:"فرونتال"}),e.jsx(C,{value:"panoramic",children:"پانورامیک"}),e.jsx(C,{value:"lateral",children:"لترال سفالومتری"}),e.jsx(C,{value:"occlusal-upper",children:"اکلوزال بالا"}),e.jsx(C,{value:"occlusal-lower",children:"اکلوزال پایین"}),e.jsx(C,{value:"lateral-intraoral",children:"لترال داخل دهان"}),e.jsx(C,{value:"frontal-intraoral",children:"فرونتال داخل دهان"})]}),e.jsx(b,{sx:{position:"relative",width:"100%",height:200,border:"2px dashed",borderColor:"grey.400",borderRadius:2,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center","&:hover":{borderColor:"primary.main"}},onClick:()=>{const t=document.createElement("input");t.type="file",t.accept="image/*",t.multiple=!0,t.onchange=a=>{const n=Array.from(a.target.files);Vt(n)},t.click()},children:e.jsxs(X,{spacing:1,alignItems:"center",children:[e.jsx(Dn,{hideBackground:!0,sx:{width:120}}),e.jsx(w,{variant:"body1",color:"text.secondary",textAlign:"center",children:"فایل‌ها را اینجا بیاندازید یا کلیک کنید"})]})}),ot.length>0&&e.jsxs(b,{sx:{textAlign:"center",pt:1},children:[e.jsxs(w,{variant:"body1",color:"primary.main",fontWeight:"medium",children:[ot.length," فایل انتخاب شده"]}),e.jsx(w,{variant:"body2",color:"text.secondary",children:"آماده آپلود"})]})]})}),e.jsxs(Wt,{children:[e.jsx(J,{onClick:aa,children:"انصراف"}),e.jsx(J,{variant:"contained",onClick:fn,disabled:ot.length===0,children:"آپلود و ذخیره"})]})]})}),e.jsxs(zt,{open:Jt,onClose:Ra,maxWidth:"sm",fullWidth:!0,children:[e.jsx(Ut,{children:"ویرایش نوع تصویر"}),e.jsx(Ot,{children:e.jsxs(X,{spacing:3,sx:{pt:1},children:[Z&&e.jsxs(b,{sx:{width:"100%",minHeight:200,maxHeight:300,position:"relative",borderRadius:1,mb:2,bgcolor:"background.neutral",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"},children:[!Fa&&e.jsx(b,{sx:{position:"absolute",top:0,left:0,right:0,bottom:0,display:"flex",alignItems:"center",justifyContent:"center",bgcolor:"background.neutral"}}),e.jsx(b,{component:"img",src:un||ue(Z.path),alt:(Z==null?void 0:Z.originalName)||"",onLoad:()=>gt(!0),sx:{width:"100%",height:"100%",maxHeight:300,objectFit:"cover",opacity:Fa?1:0,transition:"opacity 0.2s ease-in-out",position:"absolute",top:0,left:0}})]}),e.jsxs(Ha,{fullWidth:!0,children:[e.jsx(Va,{sx:{fontSize:"0.75rem"},children:"نوع تصویر"}),e.jsxs(Ja,{value:Mt,onChange:t=>Ke(t.target.value),label:"نوع تصویر",sx:he,MenuProps:pt.MenuProps,children:[e.jsx(C,{value:"profile",children:"پروفایل"}),e.jsx(C,{value:"frontal",children:"فرونتال"}),e.jsx(C,{value:"panoramic",children:"پانورمیک"}),e.jsx(C,{value:"lateral",children:"لترال سفالومتری"}),e.jsx(C,{value:"occlusal-upper",children:"اکلوزال بالا"}),e.jsx(C,{value:"occlusal-lower",children:"اکلوزال پایین"}),e.jsx(C,{value:"lateral-intraoral",children:"لترال راست دهان"}),e.jsx(C,{value:"lateral-intraoral-left",children:"لترال چپ دهان"}),e.jsx(C,{value:"frontal-intraoral",children:"فرونتال داخل دهان"})]})]})]})}),e.jsxs(Wt,{children:[e.jsx(J,{onClick:Ra,children:"انصراف"}),e.jsx(J,{variant:"contained",onClick:hn,disabled:E||!Z,children:E?"در حال ذخیره...":"ذخیره تغییرات"})]})]}),fa&&e.jsx(i.Suspense,{fallback:null,children:e.jsxs(zt,{open:fa,onClose:()=>{Tt(!1),ze(null),ct([]),Le(new Set)},maxWidth:"lg",fullWidth:!0,children:[e.jsx(Ut,{children:"تقسیم تصویر کلی"}),e.jsx(Ot,{children:e.jsxs(X,{spacing:3,sx:{pt:2},children:[!lt&&e.jsxs(e.Fragment,{children:[e.jsx(_t,{value:lt,onDrop:t=>{t.length>0&&ze(t[0])},onDelete:()=>ze(null),accept:{"image/*":[".jpg",".jpeg",".png"]}}),e.jsx(w,{variant:"body2",color:"text.secondary",children:"تصویر کلی خود را انتخاب کنید. این تصویر باید شامل چندین عکس در یک grid باشد (مثلاً 3x3)."})]}),lt&&je.length===0&&e.jsxs(e.Fragment,{children:[e.jsxs(b,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[e.jsx(b,{component:"img",src:URL.createObjectURL(lt),alt:"Composite image",sx:{maxWidth:"100%",maxHeight:"400px",objectFit:"contain",borderRadius:1}}),e.jsx(J,{variant:"outlined",onClick:()=>ze(null),startIcon:e.jsx(re,{icon:"solar:trash-bin-trash-bold"}),children:"حذف"})]}),e.jsx(J,{variant:"contained",onClick:()=>nn(lt),disabled:qt,startIcon:e.jsx(re,{icon:qt?"solar:refresh-circle-bold":"solar:scissors-square-bold"}),fullWidth:!0,children:qt?"در حال تقسیم...":"تقسیم تصویر"})]}),je.length>0&&e.jsxs(e.Fragment,{children:[e.jsxs(w,{variant:"h6",children:["نتایج تقسیم (",je.length," تصویر)"]}),e.jsx(w,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"تصاویری که می‌خواهید ذخیره شوند را انتخاب کنید. هر تصویر به صورت خودکار در دسته مناس�� قرار می‌گیرد."}),e.jsx(St,{container:!0,spacing:2,children:je.map((t,a)=>{const n=we.has(a);return e.jsx(St,{item:!0,xs:6,sm:4,md:3,children:e.jsxs(xe,{sx:{cursor:"pointer",border:2,borderColor:n?"primary.main":"transparent","&:hover":{borderColor:n?"primary.main":"grey.300"}},onClick:()=>{const o=new Set(we);n?o.delete(a):o.add(a),Le(o)},children:[e.jsx(b,{component:"img",src:`data:image/jpeg;base64,${t.image_base64}`,alt:`Split ${t.row}-${t.col}`,sx:{width:"100%",height:"150px",objectFit:"cover"}}),e.jsxs(b,{sx:{p:1},children:[e.jsxs(w,{variant:"caption",display:"block",children:["سطر ",t.row+1,", ستون ",t.col+1]}),e.jsxs(w,{variant:"caption",color:"text.secondary",display:"block",children:["نوع: ",t.category==="intraoral"?"داخل دهانی":t.category==="lateral"?"لترال":t.category==="profile"||t.category==="frontal"?"صورت":"کلی"]}),e.jsxs(w,{variant:"caption",color:"text.secondary",display:"block",children:["اعتماد: ",(t.confidence*100).toFixed(1),"%"]})]}),n&&e.jsx(b,{sx:{position:"absolute",top:8,right:8,bgcolor:"primary.main",color:"white",borderRadius:"50%",width:24,height:24,display:"flex",alignItems:"center",justifyContent:"center"},children:e.jsx(re,{icon:"solar:check-circle-bold",width:16})})]})},a)})}),e.jsxs(b,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2},children:[e.jsxs(w,{variant:"body2",children:[we.size," از ",je.length," تصویر انتخاب شده است"]}),e.jsx(J,{variant:"outlined",onClick:()=>{we.size===je.length?Le(new Set):Le(new Set(je.map((t,a)=>a)))},children:we.size===je.length?"لغو انتخاب همه":"انتخاب همه"})]})]})]})}),e.jsxs(Wt,{children:[e.jsx(J,{onClick:()=>{Tt(!1),ze(null),ct([]),Le(new Set)},children:"انصراف"}),je.length>0&&e.jsx(J,{variant:"contained",onClick:rn,disabled:$e||we.size===0,startIcon:e.jsx(re,{icon:"solar:diskette-bold"}),children:$e?"در حال ذخیره...":`ذخیره ${we.size} تصویر`})]})]})}),ua&&e.jsx(i.Suspense,{fallback:null,children:e.jsx(Wn,{open:ua,imageUrl:Xe==null?void 0:Xe.src,onClose:Ea,onSave:pn,saving:E})})]}):e.jsx(sa,{maxWidth:"xl",children:e.jsx(_a,{severity:"error",children:"بیمار یافت نشد"})})}function Lr(){return e.jsxs(e.Fragment,{children:[e.jsx($n,{children:e.jsxs("title",{children:[" ",`مدیریت بیمار - ${Ln.appName}`]})}),e.jsx(Vn,{})]})}export{Lr as default};
