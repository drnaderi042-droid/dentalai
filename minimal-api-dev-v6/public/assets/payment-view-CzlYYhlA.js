import{j as e,S as l,T as n,r as j,aC as I,aK as E,I as v,B as f,ar as g,df as T,dg as A,p as w,e as R,G as b,d as D,dh as $,di as z}from"./index-BSItzkt3.js";import{P as i}from"./index-b5NUrSMh.js";import{C as _}from"./Card-BqWDE3fr.js";const N=[{value:"zarinpal",label:"زرین‌پال",description:"پرداخت با کارت‌های بانکی ایرانی",logo:"/payment-icons/zarinpal.avif",icon:"mdi:credit-card-outline"},{value:"zibal",label:"زیبال",description:"پرداخت با کارت‌های بانکی ایرانی",logo:"/payment-icons/zibal.svg",icon:"mdi:credit-card-outline"},{value:"nowpayments",label:"NowPayments",description:"پرداخت با ارزهای دیجیتال",logo:"/payment-icons/40f189daa5c0279718484ca5f5569f78-crypto-icon.webp",icon:"cryptocurrency:btc"}];function S({onSelectGateway:c,selectedGateway:o,exchangeRate:s,amount:r}){const p=()=>!s||!r?null:(r/s.usd_to_irr).toFixed(2);return e.jsxs(l,{spacing:3,children:[e.jsx(n,{variant:"h6",children:"روش پرداخت"}),e.jsx(l,{spacing:2,children:N.map(t=>e.jsx(P,{gateway:t,selected:o===t.value,onClick:()=>c(t.value),amountInUSD:t.value==="nowpayments"?p():null},t.value))})]})}S.propTypes={onSelectGateway:i.func.isRequired,selectedGateway:i.string,exchangeRate:i.object,amount:i.number};function P({gateway:c,selected:o,onClick:s,amountInUSD:r}){const{value:p,label:t,description:y,logo:h,icon:a}=c,[m,u]=j.useState(!1);return e.jsx(I,{variant:"outlined",onClick:s,sx:{p:2.5,cursor:"pointer",...o&&{boxShadow:d=>`0 0 0 2px ${d.vars.palette.text.primary}`}},children:e.jsx(E,{primary:e.jsxs(l,{direction:"row",alignItems:"center",children:[e.jsx(v,{icon:o?"eva:checkmark-circle-2-fill":"eva:radio-button-off-fill",width:24,sx:{mr:2,color:o?"primary.main":"text.secondary"}}),e.jsx(f,{component:"span",sx:{flexGrow:1},children:t}),e.jsx(f,{sx:{width:80,height:32,display:"flex",alignItems:"center",justifyContent:"center"},children:m?e.jsx(v,{icon:a,width:32,sx:{color:"text.secondary"}}):e.jsx(f,{component:"img",src:h,alt:t,onError:()=>u(!0),sx:{maxWidth:"100%",maxHeight:"100%",objectFit:"contain"}})})]}),secondary:e.jsxs(l,{spacing:.5,sx:{mt:1},children:[e.jsx(n,{variant:"body2",color:"text.secondary",component:"div",children:y}),p==="nowpayments"&&r&&e.jsxs(n,{variant:"caption",color:"text.secondary",component:"div",children:["معادل: $",r," USD"]})]}),primaryTypographyProps:{typography:"subtitle2",component:"div"},secondaryTypographyProps:{component:"div"}})})}P.propTypes={gateway:i.object.isRequired,selected:i.bool,onClick:i.func,amountInUSD:i.string};function C({amount:c,currency:o,type:s,selectedGateway:r,exchangeRate:p}){const t=x=>new Intl.NumberFormat("fa-IR").format(x),y=()=>r==="zarinpal"?"زرین‌پال":r==="nowpayments"?"NowPayments":"انتخاب نشده",h=()=>s==="wallet_charge"?"شارژ کیف پول":"پرداخت",a=()=>!p||!c?null:(c/p.usd_to_irr).toFixed(2),m=()=>!r||!c?0:Math.round(c*(r==="zarinpal"?.01:.005)),u=()=>c+m(),d=m();return e.jsx(_,{sx:{p:3,position:"sticky",top:100},children:e.jsxs(l,{spacing:3,children:[e.jsx(n,{variant:"h6",children:"خلاصه سفارش"}),e.jsx(g,{sx:{borderStyle:"dashed"}}),e.jsxs(l,{spacing:2,children:[e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"نوع تراکنش"}),e.jsx(n,{variant:"subtitle2",children:h()})]}),e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"درگاه پرداخت"}),e.jsx(n,{variant:"subtitle2",color:r?"text.primary":"text.disabled",children:y()})]}),e.jsx(g,{sx:{borderStyle:"dashed"}}),e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"مبلغ"}),e.jsxs(n,{variant:"subtitle2",children:[t(c)," ",o]})]}),r&&d>0&&e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"کارمزد درگاه"}),e.jsxs(n,{variant:"subtitle2",color:"text.secondary",children:[t(d)," ",o]})]}),r==="nowpayments"&&p&&e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(n,{variant:"body2",color:"text.secondary",children:"معادل USD"}),e.jsxs(n,{variant:"subtitle2",color:"info.main",children:["$",a()]})]}),e.jsx(g,{sx:{borderStyle:"dashed"}}),e.jsxs(l,{direction:"row",justifyContent:"space-between",children:[e.jsx(n,{variant:"subtitle1",children:"مبلغ کل"}),e.jsxs(n,{variant:"h5",color:"error.main",children:[t(u())," ",o]})]})]})]})})}C.propTypes={amount:i.number.isRequired,currency:i.string.isRequired,type:i.string,selectedGateway:i.string,exchangeRate:i.object};function F(){const c=T(),o=A(),[s,r]=j.useState(""),[p,t]=j.useState(null),[y,h]=j.useState(!1),a=c.state||{amount:0,type:"wallet_charge",currency:"تومان"};j.useEffect(()=>{(async()=>{try{const x=await(await fetch("http://localhost:7272/api/exchange-rate")).json();x.success?t({usd_to_irr:x.data.usd_to_irr,eur_to_irr:x.data.eur_to_irr,last_updated:x.data.fetched_at}):t({usd_to_irr:7e4,eur_to_irr:75e3,last_updated:new Date().toISOString()})}catch(d){console.error("Error fetching exchange rate:",d),t({usd_to_irr:7e4,eur_to_irr:75e3,last_updated:new Date().toISOString()})}})()},[]),j.useEffect(()=>{a.amount||o(w.dashboard.wallet)},[a.amount,o]);const m=async()=>{if(!s){alert("لطفاً یک درگاه پرداخت انتخاب کنید");return}h(!0);try{const u=await $.post(z.invoice.create,{amount:a.amount,type:a.type,paymentGateway:s,description:`شارژ کیف پول به مبلغ ${a.amount.toLocaleString("fa-IR")} تومان`,items:[{description:"شارژ کیف پول",quantity:1,unitPrice:a.amount,totalPrice:a.amount}]});if(u.data.success){const d=u.data.data;console.log("Invoice created:",d),alert(`صورت‌حساب ${d.invoiceNumber} با موفقیت ایجاد شد!

در حال انتقال به درگاه ${s==="zarinpal"?"زرین‌پال":"NowPayments"}...`),o(`${w.dashboard.invoice}/${d.id}`,{state:{invoice:d}})}else throw new Error(u.data.error||"خطا در ایجاد صورت‌حساب")}catch(u){console.error("Payment error:",u),alert(u.message||"خطا در پردازش تراکنش. لطفاً دوباره تلاش کنید.")}finally{h(!1)}};return e.jsxs(R,{sx:{pt:5,pb:10},children:[e.jsx(n,{variant:"h3",align:"center",sx:{mb:2},children:"پرداخت"}),e.jsxs(b,{container:!0,spacing:3,children:[e.jsx(b,{xs:12,md:8,children:e.jsxs(_,{sx:{p:4},children:[e.jsx(S,{onSelectGateway:r,selectedGateway:s,exchangeRate:p,amount:a.amount}),e.jsx(D,{variant:"contained",size:"large",fullWidth:!0,onClick:m,disabled:!s||y,sx:{mt:4},children:y?"در حال پردازش...":"پرداخت"})]})}),e.jsx(b,{xs:12,md:4,children:e.jsx(C,{amount:a.amount,currency:a.currency,type:a.type,selectedGateway:s,exchangeRate:p})})]})]})}export{F as P};
