import{r as E,j as n,B as he,S as q,cV as Ze,o as Ce,I as Le,T as H,i as jt,dh as We,di as ze,dA as $e,e as It,cI as Pt,d as xt,aE as At,aC as Dt,bc as lt,bt as kt,A as Et,C as St,H as Ct}from"./index-BH9ijvcg.js";import{g as ct,c as Vt}from"./url-helpers-CUK1i57f.js";import{U as Nt}from"./upload-BVxhxEL6.js";import"./image-CxkC95SJ.js";import{P as re}from"./index-DVaqB1VX.js";import{D as Wt}from"./DialogTitle-BFho6EhL.js";import{D as zt}from"./DialogContent-CtzR1nPJ.js";import{D as $t}from"./dialogTitleClasses-CSmkbKpM.js";import{C as Be}from"./Card-CwEGl0A2.js";import{C as qe}from"./CardContent-Bbr3YBl8.js";import{T as Bt}from"./TableContainer-Bh7RL936.js";import{a as Ot,c as Ht,T as Lt,b as Gt}from"./TableHead-CgILorvc.js";import{T as be}from"./TableCell-C_iRAQPi.js";import{C as Ut}from"./Chip-CWilL4Fh.js";import{T as Xt}from"./TablePagination-B44FLsH8.js";import{F as wt}from"./FormControl-rHOkSiGz.js";import{I as vt}from"./InputLabel-OzeQogzC.js";import{S as Ft}from"./Select-fMsy-Lkz.js";import"./preview-multi-file--Yn4-mQ8.js";import"./format-number-z67FV_-O.js";import"./file-thumbnail-GgYbZAeX.js";import"./FormHelperText-CAGzEAMm.js";import"./LastPage-DkhatgKI.js";import"./FormLabel-Cn8enUsF.js";import"./Menu-C7S9TApF.js";function Re(t,e){const o=e.x-t.x,r=e.y-t.y;return Math.sqrt(o*o+r*r)}const Jt={chin_center:8,chin:8,chin_left:0,chin_right:16,jaw_left:0,jaw_right:16,right_eyebrow_outer:17,right_eyebrow_inner:21,left_eyebrow_inner:22,left_eyebrow_outer:26,glabella:27,nose_tip:30,nose_bridge_top:27,nose_bridge_bottom:30,nose_left:31,nose_right:35,subnasale:33,right_eye_outer:36,right_eye_inner:39,right_eye_top:37,right_eye_bottom:41,right_pupil:68,left_eye_inner:42,left_eye_outer:45,left_eye_top:43,left_eye_bottom:47,left_pupil:69,mouth_left:48,mouth_right:54,mouth_top:51,mouth_bottom:57,mouth_center_top:51,mouth_center_bottom:57,upper_lip_top:51,upper_lip_bottom:62,lower_lip_top:63,lower_lip_bottom:57,pogonion:8,menton:8},Yt={left_eye_inner:133,left_eye:33,left_eye_outer:7,left_eye_top:159,left_eye_bottom:145,left_eye_corner:33,left_eye_1:7,left_eye_2:133,right_eye_inner:362,right_eye:263,right_eye_outer:249,right_eye_top:386,right_eye_bottom:374,right_eye_corner:263,right_eye_1:249,right_eye_2:362,nose_tip:1,nose_bridge_top:6,nose_bridge_1:6,nose_bridge_4:19,nose_left:131,nose_right:360,nose_bottom:2,nose:1,nose_tip_1:1,nose_tip_2:131,nose_tip_4:360,mouth_left:61,mouth_right:291,mouth_top:13,mouth_bottom:14,mouth_center_top:13,mouth_center_bottom:14,mouth_outer_1:61,mouth_outer_3:13,mouth_outer_5:291,mouth_outer_9:14,mouth_left_corner:61,mouth_right_corner:291,chin:175,chin_center:175,chin_8:175,chin_left:172,chin_right:397,chin_1:172,chin_17:397,pogonion:175,menton:175,forehead:10,face_left:172,face_right:397,glabella:9,left_cheek:116,right_cheek:345,subnasale:2,jaw_left:172,jaw_right:397,upper_lip_top:13,upper_lip_bottom:14,lower_lip_top:14,lower_lip_bottom:14};function d(t,e){Array.isArray(e)||(e=[e]);for(const r of e){const a=t.find(c=>{if(!c.name)return!1;const g=c.name.toLowerCase(),l=r.toLowerCase();return g===l||g.includes(l)||l.includes(g)||g.replace(/_/g,"")===l.replace(/_/g,"")});if(a)return a}if(t.some(r=>r.name&&r.name.startsWith("landmark_"))&&t.length>0){const r=t.length,a=r===68,c=r>=400;for(const g of e){const l=g.toLowerCase();let _=null;if(a){if(_=Jt[l],a&&(l==="left_pupil"||l==="right_pupil")){if(l==="left_pupil"){const y=t.filter(b=>{var w;const R=b.index!==void 0?b.index:b.name?parseInt(((w=b.name.match(/landmark_(\d+)/))==null?void 0:w[1])||"-1",10):-1;return R>=42&&R<=47});if(y.length>0){const b=y.reduce((w,D)=>w+D.x,0)/y.length,R=y.reduce((w,D)=>w+D.y,0)/y.length;return{x:b,y:R,index:69,name:"left_pupil"}}}else if(l==="right_pupil"){const y=t.filter(b=>{var w;const R=b.index!==void 0?b.index:b.name?parseInt(((w=b.name.match(/landmark_(\d+)/))==null?void 0:w[1])||"-1",10):-1;return R>=36&&R<=41});if(y.length>0){const b=y.reduce((w,D)=>w+D.x,0)/y.length,R=y.reduce((w,D)=>w+D.y,0)/y.length;return{x:b,y:R,index:68,name:"right_pupil"}}}}if(c&&(l==="left_pupil"||l==="right_pupil")){if(l==="left_pupil"){const y=t.filter(b=>{var w;const R=b.index!==void 0?b.index:b.name?parseInt(((w=b.name.match(/landmark_(\d+)/))==null?void 0:w[1])||"-1",10):-1;return R===33||R===7||R===133||R===159||R===145});if(y.length>0){const b=y.reduce((w,D)=>w+D.x,0)/y.length,R=y.reduce((w,D)=>w+D.y,0)/y.length;return{x:b,y:R,index:469,name:"left_pupil"}}}else if(l==="right_pupil"){const y=t.filter(b=>{var w;const R=b.index!==void 0?b.index:b.name?parseInt(((w=b.name.match(/landmark_(\d+)/))==null?void 0:w[1])||"-1",10):-1;return R===263||R===249||R===362||R===386||R===374});if(y.length>0){const b=y.reduce((w,D)=>w+D.x,0)/y.length,R=y.reduce((w,D)=>w+D.y,0)/y.length;return{x:b,y:R,index:468,name:"right_pupil"}}}}}if(_==null&&c&&(_=Yt[l]),_!=null){const y=t.find(b=>{if(b.index!==void 0&&b.index===_)return!0;if(b.name){const R=b.name.match(/landmark_(\d+)/);if(R)return parseInt(R[1],10)===_}return!1});if(y)return console.log(`[Facial Beauty] Found landmark "${g}" at index ${_}:`,y),y;console.warn(`[Facial Beauty] Could not find landmark "${g}" at index ${_}`)}}}return null}function Kt(t){if(!t||t.length===0)return null;const e=d(t,["left_eye","left_eye_inner","left_eye_corner","left_eye_1","left_eye_outer"]),o=d(t,["right_eye","right_eye_inner","right_eye_corner","right_eye_1","right_eye_outer"]),r=d(t,["nose_tip","nose","nose_tip_1"]),a=d(t,["mouth_left","mouth_left_corner"]),c=d(t,["mouth_right","mouth_right_corner"]);if(d(t,["chin_center","chin","chin_8"]),!e||!o||!r)return null;const g={x:r.x,y:r.y},l=Math.abs(e.x-g.x),_=Math.abs(o.x-g.x),y=a?Math.abs(a.x-g.x):0,b=c?Math.abs(c.x-g.x):0,R=100-Math.abs(l-_)/Math.max(l,_)*100,w=a&&c?100-Math.abs(y-b)/Math.max(y,b)*100:100,D=(R+w)/2;return{overall:Math.max(0,Math.min(100,D)),eyes:Math.max(0,Math.min(100,R)),mouth:Math.max(0,Math.min(100,w))}}function Zt(t){var D,N;if(!t||t.length===0)return null;const e=d(t,["glabella","nose_bridge_top","forehead"]),o=d(t,["subnasale","nose_bottom"]),r=d(t,["pogonion","chin_center","chin"]);if(!e||!o||!r)return null;const a=(e.x+o.x+r.x)/3,c=Math.abs(e.x-a),g=Math.abs(o.x-a),l=Math.abs(r.x-a),_=(c+g+l)/3,y=Math.abs((((D=d(t,["face_right","chin_right"]))==null?void 0:D.x)||r.x*2)-(((N=d(t,["face_left","chin_left"]))==null?void 0:N.x)||0))||1,b=_/y*100,R=1.5,w=Math.max(0,100-(b-R)/R*100);return{deviation:_.toFixed(2),deviationPercent:b.toFixed(2),score:w.toFixed(1),grade:b<=2?"Ideal":b<=5?"Acceptable":"Needs Review"}}function qt(t){if(!t||t.length===0)return null;const e=d(t,["left_pupil","left_eye"]),o=d(t,["right_pupil","right_eye"]);if(!e||!o)return null;const r=o.x-e.x,a=o.y-e.y,c=Math.atan2(Math.abs(a),Math.abs(r))*180/Math.PI,l=Math.abs(c-0),_=Math.max(0,100-l*5);return{angle:c.toFixed(2),angleDeviation:l.toFixed(2),score:_.toFixed(1),grade:l<=1?"Ideal":l<=3?"Acceptable":"Needs Review"}}function Qt(t){if(!t||t.length===0)return null;const e=d(t,["mouth_left","mouth_outer_1"]),o=d(t,["mouth_right","mouth_outer_5"]),r=d(t,["left_pupil","left_eye"]),a=d(t,["right_pupil","right_eye"]);if(!e||!o)return null;const c=o.x-e.x,g=o.y-e.y,l=Math.atan2(Math.abs(g),Math.abs(c))*180/Math.PI;let _=0;if(r&&a){const R=a.x-r.x,w=a.y-r.y;_=Math.atan2(Math.abs(w),Math.abs(R))*180/Math.PI}const y=Math.abs(l-_),b=Math.max(0,100-y*10);return{angle:l.toFixed(2),angleDifference:y.toFixed(2),pupillaryAngle:r&&a?_.toFixed(2):null,score:b.toFixed(1),grade:y<=1?"Ideal":y<=3?"Acceptable":"Needs Review"}}function ei(t){var w,D;if(!t||t.length===0)return null;const e=d(t,["glabella","nose_bridge_top"]),o=d(t,["subnasale","nose_bottom"]),r=d(t,["pogonion","chin_center","chin"]),a=d(t,["nose_tip"]);if(d(t,["mouth_top","mouth_center_top","upper_lip_top"]),!e||!o||!r||!a)return null;const c=(e.x+o.x+r.x)/3,g=a.x,l=Math.abs(g-c),_=Math.abs((((w=d(t,["face_right","chin_right"]))==null?void 0:w.x)||r.x*2)-(((D=d(t,["face_left","chin_left"]))==null?void 0:D.x)||0))||1,y=l/_*100,b=1,R=Math.max(0,100-(y-b)/b*100);return{deviation:l.toFixed(2),deviationPercent:y.toFixed(2),score:R.toFixed(1),grade:y<=2?"Ideal":y<=5?"Acceptable":"Needs Review"}}function ti(t){if(!t||t.length===0)return null;const e=d(t,["glabella","nose_bridge_top","forehead"]),o=d(t,["subnasale","nose_bottom"]),r=d(t,["menton","chin","chin_center","pogonion"]);if(!e||!o||!r)return null;const a={};(e.y>=o.y||o.y>=r.y)&&console.warn("[Vertical Proportions] Invalid landmark order:",{glabella:{y:e.y,name:e.name},subnasale:{y:o.y,name:o.name},menton:{y:r.y,name:r.name}});const c=o.y-e.y;a.middleThirdHeight=Math.abs(c).toFixed(1);const g=r.y-o.y;a.lowerThirdHeight=Math.abs(g).toFixed(1);const l=Math.abs(c),_=Math.abs(g);if(_>0){const b=l/_;a.middleToLowerRatio=b.toFixed(2);const R=l+_;if(R>0){a.middleThirdRatio=(l/R*100).toFixed(1),a.lowerThirdRatio=(_/R*100).toFixed(1),console.log("[Vertical Proportions] Calculations:",{glabella:{y:e.y,name:e.name},subnasale:{y:o.y,name:o.name},menton:{y:r.y,name:r.name},middleSection:l,lowerSection:_,totalHeight:R,ratio:b,middleThirdRatio:a.middleThirdRatio,lowerThirdRatio:a.lowerThirdRatio});const w=50,D=Math.abs(parseFloat(a.middleThirdRatio)-w),N=Math.abs(parseFloat(a.lowerThirdRatio)-w);a.middleThirdDeviation=D.toFixed(1),a.lowerThirdDeviation=N.toFixed(1);const W=Math.abs(b-1),X=(D+N)/2;let Q=100;W>.05&&(Q=Math.max(0,100-W*100)),X>5&&(Q=Math.max(0,Q-X*2)),a.score=Math.max(0,Math.min(100,Q)).toFixed(1);const se=parseFloat(a.score);se>=90?a.grade="Ideal":se>=75?a.grade="Good":se>=60?a.grade="Fair":a.grade="Needs Improvement"}(b<.7||b>1.3)&&(a.warning=!0,a.warningMessage=b<.7?"بخش میانی صورت خیلی کوتاه‌تر از بخش پایینی است":"بخش پایینی صورت خیلی کوتاه‌تر از بخش میانی است")}a.upperThirdRatio=null,a.upperThirdHeight=null,a.upperThirdDeviation=null,d(t,["upper_lip_top","mouth_top","mouth_center_top"]);const y=d(t,["upper_lip_bottom","mouth_center_bottom"]);if(d(t,["lower_lip_bottom","mouth_bottom"]),o&&y&&r){const b=Math.abs(y.y-o.y),R=Math.abs(r.y-y.y),w=b+R;if(console.log("[Vertical Proportions] Lower face calculations:",{subnasale:{y:o.y,name:o.name},upperLipBottom:y?{y:y.y,name:y.name}:null,menton:{y:r.y,name:r.name},upperLipHeight:b,lowerLipChinHeight:R,lowerFaceHeight:w}),w>0){a.upperLipRatio=(b/w*100).toFixed(1),a.lowerLipChinRatio=(R/w*100).toFixed(1);const D=33.3,N=66.7;a.upperLipDeviation=Math.abs(parseFloat(a.upperLipRatio)-D).toFixed(1),a.lowerLipChinDeviation=Math.abs(parseFloat(a.lowerLipChinRatio)-N).toFixed(1);const W=(parseFloat(a.upperLipDeviation)+parseFloat(a.lowerLipChinDeviation))/2;a.lowerFaceScore=Math.max(0,100-W*2).toFixed(1)}}return Object.keys(a).length>0?a:null}function ii(t){if(!t||t.length===0)return null;const e=d(t,["glabella","nose_bridge_top","nasion"]),o=d(t,["menton","chin","chin_center","pogonion"]),r=d(t,["face_left","chin_left"]),a=d(t,["face_right","chin_right"]);if(!e||!o)return null;const c=Math.abs(o.y-e.y);let g=0;if(r&&a)g=Math.abs(a.x-r.x);else{const l=d(t,["left_eye_outer","left_eye"]),_=d(t,["right_eye_outer","right_eye"]);l&&_&&(g=Math.abs(_.x-l.x)*1.75)}if(c>0&&g>0){const l=c/g,y=Math.abs(l-1.3),b=Math.max(0,100-y/.1*10);return{facialIndex:l.toFixed(2),faceHeight:c.toFixed(1),faceWidth:g.toFixed(1),deviation:y.toFixed(2),score:b.toFixed(1),grade:l>=1.2&&l<=1.4?"Normal":l>1.4?"Long Face":"Short Face"}}return null}function oi(t){if(!t||t.length===0)return null;const e={},o=d(t,["left_eye_inner","left_eye"]),r=d(t,["right_eye_inner","right_eye"]),a=d(t,["nose_left"]),c=d(t,["nose_right"]);if(o&&r){const N=Math.abs(r.x-o.x);if(e.intercanthalDistance=N.toFixed(1),a&&c){const W=Math.abs(c.x-a.x);e.alarWidth=W.toFixed(1);const X=W/N;e.alarToIntercanthalRatio=X.toFixed(2);const se=Math.abs(X-1);e.alarToIntercanthalScore=Math.max(0,100-se*50).toFixed(1)}}const g=d(t,["mouth_left","mouth_outer_1"]),l=d(t,["mouth_right","mouth_outer_5"]),_=d(t,["left_pupil","left_eye"]),y=d(t,["right_pupil","right_eye"]);if(g&&l){const N=Math.abs(l.x-g.x);if(e.mouthWidth=N.toFixed(1),_&&y){const W=Math.abs(y.x-_.x);e.pupillaryDistance=W.toFixed(1);const X=N/W;e.mouthToPupillaryRatio=X.toFixed(2);const se=Math.abs(X-1);e.mouthToPupillaryScore=Math.max(0,100-se*50).toFixed(1)}}const b=d(t,["nose_left"]),R=d(t,["nose_right"]),w=d(t,["mouth_left","mouth_outer_1"]),D=d(t,["mouth_right","mouth_outer_5"]);if(b&&R&&w&&D){const N=Math.abs(R.x-b.x),W=Math.abs(D.x-w.x);if(N>0){const X=W/N;e.noseToMouthWidthRatio=X.toFixed(2);const Q=1.3,se=Math.abs(X-Q);e.noseToMouthWidthScore=Math.max(0,100-se/Q*100).toFixed(1)}}return Object.keys(e).length>0?e:null}function ni(t){if(!t||t.length===0)return null;const e={},o=d(t,["subnasale","nose_bottom"]),r=d(t,["upper_lip_bottom","mouth_center_bottom","mouth_bottom"]);if(o&&r){const c=Math.abs(r.y-o.y);e.upperLipLength=c.toFixed(1);const g=c*.26;e.upperLipLengthMM=g.toFixed(1);const _=Math.abs(g-21);e.upperLipLengthScore=Math.max(0,100-_*5).toFixed(1)}const a=d(t,["menton","chin","chin_center","pogonion"]);if(d(t,["lower_lip_top","mouth_center_bottom"]),r&&a){const c=Math.abs(a.y-r.y);e.lowerLipChinLength=c.toFixed(1);const g=c*.26;e.lowerLipChinLengthMM=g.toFixed(1);const _=Math.abs(g-42);e.lowerLipChinLengthScore=Math.max(0,100-_*2.5).toFixed(1)}if(e.upperLipLength&&e.lowerLipChinLength){const c=parseFloat(e.lowerLipChinLength)/parseFloat(e.upperLipLength);e.upperToLowerLipRatio=c.toFixed(2);const l=Math.abs(c-2);e.upperToLowerLipScore=Math.max(0,100-l*25).toFixed(1)}return Object.keys(e).length>0?e:null}function ai(t){if(!t||t.length===0)return null;const e=d(t,["nose_tip","nose","nose_tip_1"]),o=d(t,["chin_center","chin","chin_8"]),r=d(t,["left_eye","left_eye_inner","left_eye_corner"]),a=d(t,["right_eye","right_eye_inner","right_eye_corner"]);if(d(t,["mouth_center_top","mouth_top"]),!e||!o||!r||!a)return null;const c={},g=d(t,["glabella","nose_bridge_top"]);if(g&&e&&o){Math.abs(o.y-g.y);const w=Math.abs(e.y-g.y),D=Math.abs(o.y-e.y);if(w>0&&D>0){const N=w/D,W=1.618,X=Math.abs(N-W)/W;c.verticalRatio={ratio:N.toFixed(2),deviation:(X*100).toFixed(1),score:Math.max(0,100-X*100)}}}(r.x+a.x)/2;const l=Math.abs(a.x-r.x),_=d(t,["chin_left","face_left","chin_1"]),y=d(t,["chin_right","face_right","chin_17"]);if(_&&y){const w=Math.abs(y.x-_.x);if(l>0){const D=w/l,N=1.618,W=Math.abs(D-N)/N;c.horizontalRatio={ratio:D.toFixed(2),deviation:(W*100).toFixed(1),score:Math.max(0,100-W*100)}}}const b=d(t,["nose_left","nose_tip_2"]),R=d(t,["nose_right","nose_tip_4"]);if(b&&R&&l>0){const w=Math.abs(R.x-b.x),D=l/w,N=1.618,W=Math.abs(D-N)/N;c.eyeToNoseRatio={ratio:D.toFixed(2),deviation:(W*100).toFixed(1),score:Math.max(0,100-W*100)}}return c}function ri(t){const e=d(t,["left_eye","left_eye_inner","left_eye_corner"]),o=d(t,["right_eye","right_eye_inner","right_eye_corner"]),r=d(t,["left_eye_inner","left_eye_2","left_eye"]),a=d(t,["right_eye_inner","right_eye_2","right_eye"]),c=d(t,["left_eye_outer","left_eye_1","left_eye"]),g=d(t,["right_eye_outer","right_eye_1","right_eye"]);if(!e||!o)return null;const l={};if(r&&a){const _=Re(r,a);l.eyeDistance=_.toFixed(1)}if(c&&r){const _=Re(c,r);l.leftEyeWidth=_.toFixed(1)}if(g&&a){const _=Re(g,a);l.rightEyeWidth=_.toFixed(1)}if(l.leftEyeWidth&&l.rightEyeWidth){const _=100-Math.abs(parseFloat(l.leftEyeWidth)-parseFloat(l.rightEyeWidth))/Math.max(parseFloat(l.leftEyeWidth),parseFloat(l.rightEyeWidth))*100;l.eyeSymmetry=Math.max(0,Math.min(100,_)).toFixed(1)}return l}function si(t){const e=d(t,["nose_tip","nose","nose_tip_1"]),o=d(t,["nose_bridge_top","nose_bridge_1"]);d(t,["nose_bridge_bottom","nose_bridge_4"]);const r=d(t,["nose_left","nose_tip_2"]),a=d(t,["nose_right","nose_tip_4"]);if(!e)return null;const c={};if(o&&e){const g=Re(o,e);c.noseHeight=g.toFixed(1)}if(r&&a){const g=Re(r,a);c.noseWidth=g.toFixed(1)}if(c.noseHeight&&c.noseWidth){const g=parseFloat(c.noseHeight)/parseFloat(c.noseWidth);c.noseRatio=g.toFixed(2);const l=1.75,_=Math.abs(g-l)/l;c.noseRatioScore=Math.max(0,100-_*100).toFixed(1)}return c}function li(t){const e=d(t,["mouth_left","mouth_left_corner","mouth_outer_1"]),o=d(t,["mouth_right","mouth_right_corner","mouth_outer_5"]),r=d(t,["mouth_top","mouth_outer_3"]),a=d(t,["mouth_bottom","mouth_outer_9"]);if(d(t,["mouth_center_top","mouth_top"]),d(t,["mouth_center_bottom","mouth_bottom"]),!e||!o)return null;const c={},g=Re(e,o);if(c.mouthWidth=g.toFixed(1),r&&a){const l=Re(r,a);c.mouthHeight=l.toFixed(1)}if(c.mouthWidth&&c.mouthHeight){const l=parseFloat(c.mouthWidth)/parseFloat(c.mouthHeight);c.mouthRatio=l.toFixed(2)}return c}function ci(t){if(!t||t.length===0)return null;const e={},o=d(t,["glabella","nose_bridge_top"]),r=d(t,["nose_tip","nose"]),a=d(t,["chin_center","chin","chin_8"]),c=d(t,["chin_left","face_left","chin_1"]),g=d(t,["chin_right","face_right","chin_17"]);if(o&&r&&a){const R=Math.abs(a.y-o.y),w=Math.abs(r.y-o.y),D=Math.abs(a.y-r.y);if(R>0){e.glabellaToNoseRatio=(w/R*100).toFixed(1),e.noseToChinRatio=(D/R*100).toFixed(1);const N=50;e.glabellaToNoseDeviation=Math.abs(parseFloat(e.glabellaToNoseRatio)-N).toFixed(1),e.noseToChinDeviation=Math.abs(parseFloat(e.noseToChinRatio)-N).toFixed(1)}}const l=d(t,["left_eye","left_eye_outer","left_eye_1"]),_=d(t,["right_eye","right_eye_outer","right_eye_1"]);let y=0;c&&g?y=Math.abs(g.x-c.x):l&&_&&(y=Math.abs(_.x-l.x)*1.75);let b=0;if(o&&a&&(b=Math.abs(a.y-o.y)),y>0&&b>0){e.widthToHeightRatio=(y/b).toFixed(2);const R=.825,w=Math.abs(parseFloat(e.widthToHeightRatio)-R)/R;e.widthToHeightScore=Math.max(0,100-w*100).toFixed(1)}return Object.keys(e).length>0?e:null}function hi(t){if(!t||t.length===0)return null;const e={},o=d(t,["chin_left","face_left","chin_1"]),r=d(t,["chin_right","face_right","chin_17"]);if(!o||!r)return null;const a=(o.x+r.x)/2,c=Math.abs(r.x-o.x),g=d(t,["nose_tip","nose"]);if(g&&c>0){const w=Math.abs(g.x-a),D=c/2;e.noseDeviation=w.toFixed(1),e.noseDeviationPercent=(w/D*100).toFixed(1),e.noseDeviationGrade=parseFloat(e.noseDeviationPercent)<2?"Normal":parseFloat(e.noseDeviationPercent)<5?"Mild":parseFloat(e.noseDeviationPercent)<10?"Moderate":"Severe"}const l=d(t,["chin_center","chin","chin_8"]);if(l&&c>0){const w=Math.abs(l.x-a),D=c/2;e.chinDeviation=w.toFixed(1),e.chinDeviationPercent=(w/D*100).toFixed(1),e.chinDeviationGrade=parseFloat(e.chinDeviationPercent)<2?"Normal":parseFloat(e.chinDeviationPercent)<5?"Mild":parseFloat(e.chinDeviationPercent)<10?"Moderate":"Severe"}const _=d(t,["left_eye","left_eye_inner","left_eye_corner"]),y=d(t,["right_eye","right_eye_inner","right_eye_corner"]),b=d(t,["mouth_left","mouth_left_corner"]),R=d(t,["mouth_right","mouth_right_corner"]);if(_&&y&&b&&R){const w=Math.abs(_.x-a),D=Math.abs(y.x-a),N=Math.abs(b.x-a),W=Math.abs(R.x-a),X=Math.abs(w-D),Q=Math.abs(N-W);c>0?(e.eyeAsymmetry=X.toFixed(1),e.eyeAsymmetryPercent=(X/c*100).toFixed(1),e.mouthAsymmetry=Q.toFixed(1),e.mouthAsymmetryPercent=(Q/c*100).toFixed(1),e.overallAsymmetry=((X+Q)/2).toFixed(1),e.overallAsymmetryPercent=((parseFloat(e.eyeAsymmetryPercent)+parseFloat(e.mouthAsymmetryPercent))/2).toFixed(1)):(e.eyeAsymmetry=X.toFixed(1),e.mouthAsymmetry=Q.toFixed(1),e.overallAsymmetry=((X+Q)/2).toFixed(1))}return Object.keys(e).length>0?e:null}function di(t){if(!t||t.length===0)return null;const e={},o=d(t,["nose_tip","nose"]),r=d(t,["chin_center","chin","chin_8"]),a=d(t,["mouth_top","mouth_center_top"]);if(d(t,["mouth_bottom","mouth_center_bottom"]),o&&a&&(e.middleFaceHeight=Math.abs(a.y-o.y).toFixed(1)),a&&r&&(e.lowerFaceHeight=Math.abs(r.y-a.y).toFixed(1)),e.middleFaceHeight&&e.lowerFaceHeight){const c=parseFloat(e.middleFaceHeight),g=parseFloat(e.lowerFaceHeight);if(g>0){e.mfhToLfhRatio=(c/g).toFixed(2);const l=.65,_=Math.abs(parseFloat(e.mfhToLfhRatio)-l)/l;e.mfhToLfhScore=Math.max(0,100-_*100).toFixed(1)}}return Object.keys(e).length>0?e:null}function ui(t){if(!t||t.length===0)return null;const e={},o=d(t,["glabella","nose_bridge_top"]);d(t,["nose_bridge_top","nose_bridge_1"]);const r=d(t,["nose_tip","nose"]),a=d(t,["upper_lip","mouth_top","mouth_center_top"]),c=d(t,["lower_lip","mouth_bottom","mouth_center_bottom"]),g=d(t,["chin_center","chin","chin_8"]);if(r&&g&&a){const l=ht(a,r,g);if(o){const _=Mt(o,r,g);e.profileAngle=_.toFixed(1),l>5?(e.profileType="Convex",e.profileDescription="پروفایل محدب (پیش آمدگی)"):l<-5?(e.profileType="Concave",e.profileDescription="پروفایل مقعر (پس رفتگی)"):(e.profileType="Straight",e.profileDescription="پروفایل مستقیم")}else l>5?(e.profileType="Convex",e.profileDescription="پروفایل محدب (پیش آمدگی)"):l<-5?(e.profileType="Concave",e.profileDescription="پروفایل مقعر (پس رفتگی)"):(e.profileType="Straight",e.profileDescription="پروفایل مستقیم")}if(a&&c&&g){const l=Mt(a,c,g);e.lipAngle=l.toFixed(1)}if(r&&a&&g){const l=ht(a,r,g);e.lipProminence=l.toFixed(1),l>5?(e.lipProminenceType="Protrusion",e.lipProminenceDescription="لب برجسته (پیش آمدگی)"):l<-5?(e.lipProminenceType="Retrusion",e.lipProminenceDescription="لب پس رفته (پس رفتگی)"):(e.lipProminenceType="Normal",e.lipProminenceDescription="لب طبیعی")}return Object.keys(e).length>0?e:null}function gi(t){if(!t||t.length===0)return null;const e={},o=d(t,["upper_lip","mouth_top","mouth_center_top"]),r=d(t,["lower_lip","mouth_bottom","mouth_center_bottom"]),a=d(t,["mouth_left","mouth_left_corner"]),c=d(t,["mouth_right","mouth_right_corner"]),g=d(t,["nose_tip","nose"]),l=d(t,["chin_center","chin","chin_8"]);if(o&&g&&l){const _=ht(o,g,l);e.upperLipProminence=_.toFixed(1),_>3?e.upperLipType="Protrusion":_<-3?e.upperLipType="Retrusion":e.upperLipType="Normal"}if(r&&g&&l){const _=ht(r,g,l);e.lowerLipProminence=_.toFixed(1),_>3?e.lowerLipType="Protrusion":_<-3?e.lowerLipType="Retrusion":e.lowerLipType="Normal"}if(a&&c&&(e.lipWidth=Re(a,c).toFixed(1)),o&&r&&(e.lipHeight=Math.abs(r.y-o.y).toFixed(1)),o&&r){const _=Math.abs(r.y-o.y);e.lipIncompetence=_>5?"Yes":"No",e.lipIncompetenceDistance=_.toFixed(1)}return Object.keys(e).length>0?e:null}function fi(t){if(!t||t.length===0)return null;const e={},o=d(t,["chin_center","chin","chin_8"]);return d(t,["jaw_line","chin_left","chin_1"]),o&&(e.chinPosition={x:o.x,y:o.y}),Object.keys(e).length>0?e:null}function pi(t){if(!t||t.length===0)return null;const e={},o=d(t,["nose_left","nose_tip_2"]),r=d(t,["nose_right","nose_tip_4"]),a=d(t,["mouth_left","mouth_left_corner"]),c=d(t,["mouth_right","mouth_right_corner"]);if(o&&a){const g=Math.atan2(a.y-o.y,a.x-o.x)*180/Math.PI;e.leftNasolabialAngle=g.toFixed(1)}if(r&&c){const g=Math.atan2(c.y-r.y,c.x-r.x)*180/Math.PI;e.rightNasolabialAngle=g.toFixed(1)}if(e.leftNasolabialAngle&&e.rightNasolabialAngle){const g=Math.abs(parseFloat(e.leftNasolabialAngle)-parseFloat(e.rightNasolabialAngle));e.nasolabialAsymmetry=g.toFixed(1),e.nasolabialSymmetry=g<5?"Symmetric":"Asymmetric"}return Object.keys(e).length>0?e:null}function mi(t){if(!t||t.length===0)return null;const e={},o=d(t,["upper_lip","mouth_top","mouth_center_top"]),r=d(t,["lower_lip","mouth_bottom","mouth_center_bottom"]);if(d(t,["mouth_top","mouth_center_top"]),d(t,["mouth_bottom","mouth_center_bottom"]),o&&r){const g=Math.abs(r.y-o.y);e.restLipDistance=g.toFixed(1),g<3?e.restIncisorShow="Normal":e.restIncisorShow="Excessive"}const a=d(t,["mouth_left","mouth_left_corner"]),c=d(t,["mouth_right","mouth_right_corner"]);if(a&&c){const g=Re(a,c);e.smileWidth=g.toFixed(1)}return Object.keys(e).length>0?e:null}function yi(t){if(!t||t.length===0)return null;const e={},o=d(t,["upper_lip","mouth_top","mouth_center_top"]),r=d(t,["mouth_top","mouth_center_top"]);if(o&&r){const a=Math.abs(o.y-r.y);e.lipToMouthDistance=a.toFixed(1),a>5?e.gingivalShow="Possible":e.gingivalShow="Normal"}return Object.keys(e).length>0?e:null}function xi(t){if(!t||t.length===0)return null;const e={},o=d(t,["mouth_left","mouth_left_corner"]),r=d(t,["mouth_right","mouth_right_corner"]),a=d(t,["mouth_top","mouth_center_top"]),c=d(t,["mouth_bottom","mouth_center_bottom"]);if(o&&r&&a&&c){const g=o.y,l=r.y,_=a.y,y=(g+l)/2,b=Math.abs(_-y),R=3;_<y-R?(e.smileArcType="Consonant",e.smileArcDescription="قوس هماهنگ (طبیعی)"):_>y+R?(e.smileArcType="Reverse",e.smileArcDescription="قوس معکوس"):(e.smileArcType="Flat",e.smileArcDescription="قوس صاف"),e.smileArcHeight=b.toFixed(1)}return Object.keys(e).length>0?e:null}function _i(t){if(!t||t.length===0)return null;const e={},o=d(t,["mouth_left","mouth_left_corner"]),r=d(t,["mouth_right","mouth_right_corner"]),a=d(t,["chin_left","face_left","chin_1"]),c=d(t,["chin_right","face_right","chin_17"]);if(o&&r&&(e.smileWidth=Re(o,r).toFixed(1)),o&&r&&a&&c){const g=Math.abs(c.x-a.x);Math.abs(c.x-r.x)+Math.abs(o.x-a.x);const l=Math.abs(o.x-a.x),_=Math.abs(c.x-r.x),y=(l+_)/2;if(g>0){const b=y/g*100;e.buccalCorridorRatio=b.toFixed(1),b<10?(e.buccalCorridorType="Wide Smile",e.buccalCorridorDescription="لبخند عریض (راهروهای کوچک)"):b>15?(e.buccalCorridorType="Narrow Smile",e.buccalCorridorDescription="لبخند باریک (راهروهای بزرگ)"):(e.buccalCorridorType="Ideal",e.buccalCorridorDescription="لبخند ایده‌آل")}}return Object.keys(e).length>0?e:null}function Mt(t,e,o){const r={x:t.x-e.x,y:t.y-e.y},a={x:o.x-e.x,y:o.y-e.y},c=r.x*a.x+r.y*a.y,g=Math.sqrt(r.x*r.x+r.y*r.y),l=Math.sqrt(a.x*a.x+a.y*a.y);return Math.acos(c/(g*l))*180/Math.PI}function ht(t,e,o){const r=t.x-e.x,a=t.y-e.y,c=o.x-e.x,g=o.y-e.y,l=r*c+a*g,_=c*c+g*g;let y=-1;_!==0&&(y=l/_);let b,R;y<0?(b=e.x,R=e.y):y>1?(b=o.x,R=o.y):(b=e.x+y*c,R=e.y+y*g);const w=t.x-b,D=t.y-R;return Math.sqrt(w*w+D*D)*(t.y>R?1:-1)}function _t(t){if(!t||t.length===0)return{success:!1,error:"No landmarks provided"};const e=Kt(t),o=ai(t),r=ri(t),a=si(t),c=li(t),g=ci(t),l=hi(t),_=di(t),y=ui(t),b=gi(t),R=fi(t),w=pi(t),D=mi(t),N=yi(t),W=xi(t),X=_i(t),Q=Zt(t),se=qt(t),J=Qt(t),de=ei(t),Ve=ti(t),me=ii(t),Fe=oi(t),we=ni(t);let ge=0,fe=0;e&&(ge+=e.overall,fe+=1),o&&(o.verticalRatio&&(ge+=o.verticalRatio.score,fe+=1),o.horizontalRatio&&(ge+=o.horizontalRatio.score,fe+=1),o.eyeToNoseRatio&&(ge+=o.eyeToNoseRatio.score,fe+=1)),a!=null&&a.noseRatioScore&&(ge+=parseFloat(a.noseRatioScore),fe+=1),g!=null&&g.widthToHeightScore&&(ge+=parseFloat(g.widthToHeightScore),fe+=1),_!=null&&_.mfhToLfhScore&&(ge+=parseFloat(_.mfhToLfhScore),fe+=1);const ee=fe>0?(ge/fe).toFixed(1):null;let le="N/A";if(ee!==null){const ie=parseFloat(ee);ie>=90?le="عالی":ie>=80?le="خیلی خوب":ie>=70?le="خوب":ie>=60?le="متوسط":ie>=50?le="نیاز به بهبود":le="نیاز به اصلاح"}return{success:!0,overallScore:ee?parseFloat(ee):null,beautyGrade:le,symmetry:e,goldenRatio:o,eyes:r,nose:a,mouth:c,facialProportions:g,facialAsymmetry:l,faceHeight:_,profile:y,lipDetails:b,throat:R,nasolabialFold:w,incisorShow:D,gingivalShow:N,smileArc:W,smileWidth:X,midfacialLineDeviation:Q,interpupillaryLineAngle:se,commissuralLineAngle:J,dentalMidlineDeviation:de,verticalProportions:Ve,facialIndex:me,transverseProportions:Fe,lipProportions:we,recommendations:bi(e,o,a,ee,l,y,W)}}function bi(t,e,o,r,a,c,g){const l=[];return t&&t.overall<70&&l.push("تقارن صورت نیاز به بهبود دارد. ممکن است به درمان ارتودنسی یا جراحی نیاز باشد."),a&&((a.noseDeviationGrade==="Severe"||a.noseDeviationGrade==="Moderate")&&l.push(`انحراف بینی ${a.noseDeviationGrade} تشخیص داده شد. مشاوره با متخصص ارتودنسی یا جراح توصیه می‌شود.`),(a.chinDeviationGrade==="Severe"||a.chinDeviationGrade==="Moderate")&&l.push(`انحراف چانه ${a.chinDeviationGrade} تشخیص داده شد.`)),e&&e.verticalRatio&&parseFloat(e.verticalRatio.score)<70&&l.push("نسبت عمودی صورت از نسبت طلایی فاصله دارد."),c&&(c.profileType==="Convex"?l.push("پروفایل محدب تشخیص داده شد. ممکن است نیاز به درمان ارتودنسی یا جراحی باشد."):c.profileType==="Concave"&&l.push("پروفایل مقعر تشخیص داده شد. مشاوره با متخصص ارتودنسی توصیه می‌شود."),c.lipProminenceType==="Protrusion"?l.push("لب برجسته (Protrusion) تشخیص داده شد."):c.lipProminenceType==="Retrusion"&&l.push("لب پس رفته (Retrusion) تشخیص داده شد.")),o&&o.noseRatioScore&&parseFloat(o.noseRatioScore)<70&&l.push("نسبت بینی نیاز به بررسی دارد."),g&&(g.smileArcType==="Reverse"?l.push("قوس لبخند معکوس تشخیص داده شد. این ممکن است نیاز به درمان داشته باشد."):g.smileArcType==="Flat"&&l.push("قوس لبخند صاف تشخیص داده شد.")),r&&parseFloat(r)>=80&&l.push("صورت شما دارای نسبت‌های زیبایی خوبی است!"),l.length===0&&l.push("آنالیز اولیه انجام شد. برای نتیجه دقیق‌تر با متخصص ارتودنسی یا جراح مشورت کنید."),l}const Li=[{category:"Macro-Esthetics",parameter:"نسبت عرض به ارتفاع صورت",idealValue:"0.70 - 0.75",description:"نسبت ایده‌آل عرض صورت به ارتفاع آن. نسبت‌های بالاتر نشان‌دهنده صورت عریض‌تر است.",getValue:t=>{var e;return(e=t.facialProportions)==null?void 0:e.widthToHeightRatio},getScore:t=>{var e;return(e=t.facialProportions)==null?void 0:e.widthToHeightScore}},{category:"Macro-Esthetics",parameter:"نسبت Glabella به Nose Tip (از Glabella)",idealValue:"50%",description:"نسبت ارتفاع از Glabella تا نوک بینی به ارتفاع کل از Glabella تا چانه. چون لندمارک بالای پیشانی در دسترس نیست، از Glabella به عنوان نقطه شروع استفاده می‌شود.",getValue:t=>{var e;return(e=t.facialProportions)!=null&&e.glabellaToNoseRatio?`${t.facialProportions.glabellaToNoseRatio}%`:null}},{category:"Macro-Esthetics",parameter:"نسبت Nose Tip به Chin (از Glabella)",idealValue:"50%",description:"نسبت ارتفاع از نوک بینی تا چانه به ارتفاع کل از Glabella تا چانه.",getValue:t=>{var e;return(e=t.facialProportions)!=null&&e.noseToChinRatio?`${t.facialProportions.noseToChinRatio}%`:null}},{category:"Macro-Esthetics",parameter:"انحراف بینی",idealValue:"< 2%",description:"انحراف بینی از خط مرکزی صورت. انحراف بیش از 5% نیاز به بررسی دارد.",getValue:t=>{var e;return(e=t.facialAsymmetry)!=null&&e.noseDeviationPercent?`${t.facialAsymmetry.noseDeviationPercent}%`:null},getGrade:t=>{var e;return(e=t.facialAsymmetry)==null?void 0:e.noseDeviationGrade}},{category:"Macro-Esthetics",parameter:"انحراف چانه",idealValue:"< 2%",description:"انحراف چانه از خط مرکزی صورت. انحراف زیاد ممکن است نشان‌دهنده عدم تقارن باشد.",getValue:t=>{var e;return(e=t.facialAsymmetry)!=null&&e.chinDeviationPercent?`${t.facialAsymmetry.chinDeviationPercent}%`:null},getGrade:t=>{var e;return(e=t.facialAsymmetry)==null?void 0:e.chinDeviationGrade}},{category:"Macro-Esthetics",parameter:"نسبت MFH/LFH (Middle/Lower Face Height)",idealValue:"0.60 - 0.70",description:"نسبت ارتفاع صورت میانی (از نوک بینی تا بالای دهان) به ارتفاع صورت پایینی (از بالای دهان تا چانه). این نسبت به جای LFH/UFH استفاده می‌شود چون لندمارک بالای پیشانی در دسترس نیست.",getValue:t=>{var e;return(e=t.faceHeight)==null?void 0:e.mfhToLfhRatio},getScore:t=>{var e;return(e=t.faceHeight)==null?void 0:e.mfhToLfhScore}},{category:"Macro-Esthetics",parameter:"نوع پروفایل",idealValue:"Straight",description:"پروفایل مستقیم ایده‌آل است. پروفایل محدب (Convex) نشان‌دهنده پیش آمدگی و پروفایل مقعر (Concave) نشان‌دهنده پس رفتگی است.",getValue:t=>{var e;return(e=t.profile)==null?void 0:e.profileDescription},getGrade:t=>{var e,o;return((e=t.profile)==null?void 0:e.profileType)==="Straight"?"Ideal":(o=t.profile)==null?void 0:o.profileType}},{category:"Macro-Esthetics",parameter:"برجستگی لب",idealValue:"Normal",description:"برجستگی طبیعی لب ایده‌آل است. Protrusion (پیش آمدگی) یا Retrusion (پس رفتگی) نیاز به بررسی دارد.",getValue:t=>{var e;return(e=t.profile)==null?void 0:e.lipProminenceDescription},getGrade:t=>{var e;return(e=t.profile)==null?void 0:e.lipProminenceType}},{category:"Macro-Esthetics",parameter:"عدم بسته شدن لب (Incompetence)",idealValue:"No",description:"در حالت استراحت، لب‌ها باید به هم برسند. عدم بسته شدن ممکن است نیاز به درمان داشته باشد.",getValue:t=>{var e;return(e=t.lipDetails)==null?void 0:e.lipIncompetence},getGrade:t=>{var e;return((e=t.lipDetails)==null?void 0:e.lipIncompetence)==="No"?"Normal":"Abnormal"}},{category:"Macro-Esthetics",parameter:"تقارن چین نازولابیال",idealValue:"Symmetric",description:"چین نازولابیال باید متقارن باشد. عدم تقارن ممکن است نشان‌دهنده مشکلات ساختاری باشد.",getValue:t=>{var e;return(e=t.nasolabialFold)==null?void 0:e.nasolabialSymmetry}},{category:"Mini-Esthetics",parameter:"نمایش دندان پیشین در استراحت",idealValue:"Normal",description:"در حالت استراحت، مقدار کمی از دندان‌های پیشین بالا باید قابل مشاهده باشد (2-4mm).",getValue:t=>{var e;return(e=t.incisorShow)==null?void 0:e.restIncisorShow}},{category:"Mini-Esthetics",parameter:"نمایش لثه",idealValue:"Normal",description:"نمایش بیش از حد لثه (Gummy Smile) ممکن است نیاز به درمان داشته باشد.",getValue:t=>{var e;return(e=t.gingivalShow)==null?void 0:e.gingivalShow}},{category:"Mini-Esthetics",parameter:"قوس لبخند",idealValue:"Consonant",description:"قوس هماهنگ (Consonant) ایده‌آل است. قوس صاف (Flat) یا معکوس (Reverse) ممکن است نیاز به درمان داشته باشد.",getValue:t=>{var e;return(e=t.smileArc)==null?void 0:e.smileArcDescription},getGrade:t=>{var e,o;return((e=t.smileArc)==null?void 0:e.smileArcType)==="Consonant"?"Ideal":(o=t.smileArc)==null?void 0:o.smileArcType}},{category:"Mini-Esthetics",parameter:"راهروهای گونه‌ای (Buccal Corridors)",idealValue:"10-15%",description:"فاصله بین گوشه دهان و کنار صورت در حالت لبخند. راهروهای باریک (کمتر از 10%) یا عریض (بیش از 15%) ایده‌آل نیستند.",getValue:t=>{var e;return(e=t.smileWidth)!=null&&e.buccalCorridorRatio?`${t.smileWidth.buccalCorridorRatio}%`:null},getGrade:t=>{var e,o;return((e=t.smileWidth)==null?void 0:e.buccalCorridorType)==="Ideal"?"Ideal":(o=t.smileWidth)==null?void 0:o.buccalCorridorType}},{category:"Basic Analysis",parameter:"تقارن کلی صورت",idealValue:"> 90%",description:"تقارن کلی صورت باید بالای 90% باشد. تقارن پایین‌تر ممکن است نیاز به درمان داشته باشد.",getValue:t=>{var e;return(e=t.symmetry)!=null&&e.overall?`${t.symmetry.overall.toFixed(1)}%`:null}},{category:"Basic Analysis",parameter:"تقارن چشم‌ها",idealValue:"> 90%",description:"چشم‌ها باید متقارن باشند. عدم تقارن ممکن است نشان‌دهنده مشکلات ساختاری باشد.",getValue:t=>{var e;return(e=t.symmetry)!=null&&e.eyes?`${t.symmetry.eyes.toFixed(1)}%`:null}},{category:"Basic Analysis",parameter:"نسبت طلایی عمودی",idealValue:"1.618",description:"نسبت طلایی (Golden Ratio) برای تقسیم‌بندی عمودی صورت. نسبت 1:1.618 ایده‌آل است.",getValue:t=>{var e,o;return(o=(e=t.goldenRatio)==null?void 0:e.verticalRatio)==null?void 0:o.ratio},getScore:t=>{var e,o;return(o=(e=t.goldenRatio)==null?void 0:e.verticalRatio)==null?void 0:o.score}},{category:"Basic Analysis",parameter:"نسبت طلایی افقی",idealValue:"1.618",description:"نسبت طلایی برای تقسیم‌بندی افقی صورت.",getValue:t=>{var e,o;return(o=(e=t.goldenRatio)==null?void 0:e.horizontalRatio)==null?void 0:o.ratio},getScore:t=>{var e,o;return(o=(e=t.goldenRatio)==null?void 0:e.horizontalRatio)==null?void 0:o.score}},{category:"Basic Analysis",parameter:"نسبت بینی",idealValue:"1.5 - 2.0",description:"نسبت ارتفاع به عرض بینی. نسبت 1.5-2.0 ایده‌آل است.",getValue:t=>{var e;return(e=t.nose)==null?void 0:e.noseRatio},getScore:t=>{var e;return(e=t.nose)==null?void 0:e.noseRatioScore}},{category:"Frontal Analysis",parameter:"انحراف خط میانی صورت (Midfacial Line)",idealValue:"≤ 2%",description:"خط میانی صورت باید از Glabella → Subnasale → Pogonion عبور کند. انحراف بیش از 2% نیاز به بررسی دارد.",getValue:t=>{var e;return(e=t.midfacialLineDeviation)!=null&&e.deviationPercent?`${t.midfacialLineDeviation.deviationPercent}%`:null},getScore:t=>{var e;return(e=t.midfacialLineDeviation)==null?void 0:e.score},getGrade:t=>{var e;return(e=t.midfacialLineDeviation)==null?void 0:e.grade}},{category:"Frontal Analysis",parameter:"زاویه خط بین مردمک‌ها (Interpupillary Line)",idealValue:"0° (افقی)",description:"خط بین مردمک‌ها باید کاملاً افقی و موازی با زمین باشد. انحراف بیش از 3 درجه نیاز به بررسی دارد.",getValue:t=>{var e;return(e=t.interpupillaryLineAngle)!=null&&e.angleDeviation?`${t.interpupillaryLineAngle.angleDeviation}°`:null},getScore:t=>{var e;return(e=t.interpupillaryLineAngle)==null?void 0:e.score},getGrade:t=>{var e;return(e=t.interpupillaryLineAngle)==null?void 0:e.grade}},{category:"Frontal Analysis",parameter:"زاویه خط دهان (Commissural Line)",idealValue:"موازی با Interpupillary Line",description:"خط بین گوشه‌های دهان باید موازی با خط بین مردمک‌ها باشد. تفاوت بیش از 3 درجه نیاز به بررسی دارد.",getValue:t=>{var e;return(e=t.commissuralLineAngle)!=null&&e.angleDifference?`${t.commissuralLineAngle.angleDifference}°`:null},getScore:t=>{var e;return(e=t.commissuralLineAngle)==null?void 0:e.score},getGrade:t=>{var e;return(e=t.commissuralLineAngle)==null?void 0:e.grade}},{category:"Frontal Analysis",parameter:"انحراف خط دندانی از خط میانی صورت",idealValue:"≤ 2%",description:"خط دندانی باید با خط میانی صورت منطبق باشد. انحراف بیش از 2% نیاز به بررسی دارد.",getValue:t=>{var e;return(e=t.dentalMidlineDeviation)!=null&&e.deviationPercent?`${t.dentalMidlineDeviation.deviationPercent}%`:null},getScore:t=>{var e;return(e=t.dentalMidlineDeviation)==null?void 0:e.score},getGrade:t=>{var e;return(e=t.dentalMidlineDeviation)==null?void 0:e.grade}},{category:"Vertical Proportions",parameter:"نسبت بخش میانی به پایینی صورت (Glabella–Subnasale : Subnasale–Menton)",idealValue:"1:1 (50% : 50%)",description:"نسبت بخش میانی صورت (از Glabella تا Subnasale) به بخش پایینی (از Subnasale تا Menton) باید تقریباً برابر باشد. اگر اختلاف زیادی وجود داشته باشد، نشان‌دهنده عدم تعادل در نسبت‌های صورت است.",getValue:t=>{var e,o,r;return(e=t.verticalProportions)!=null&&e.middleToLowerRatio?`${parseFloat(t.verticalProportions.middleToLowerRatio).toFixed(2)}:1`:(o=t.verticalProportions)!=null&&o.middleThirdRatio&&((r=t.verticalProportions)!=null&&r.lowerThirdRatio)?`${t.verticalProportions.middleThirdRatio}% : ${t.verticalProportions.lowerThirdRatio}%`:null},getScore:t=>{var e;return(e=t.verticalProportions)==null?void 0:e.score},getGrade:t=>{var e;return(e=t.verticalProportions)==null?void 0:e.grade}},{category:"Vertical Proportions",parameter:"نسبت بخش میانی صورت (Glabella–Subnasale)",idealValue:"50%",description:"بخش میانی صورت باید تقریباً 50% از ارتفاع کل (از Glabella تا Menton) باشد.",getValue:t=>{var e;return(e=t.verticalProportions)!=null&&e.middleThirdRatio?`${t.verticalProportions.middleThirdRatio}%`:null},getScore:t=>{var e;return(e=t.verticalProportions)==null?void 0:e.score}},{category:"Vertical Proportions",parameter:"نسبت بخش پایینی صورت (Subnasale–Menton)",idealValue:"50%",description:"بخش پایینی صورت باید تقریباً 50% از ارتفاع کل (از Glabella تا Menton) باشد.",getValue:t=>{var e;return(e=t.verticalProportions)!=null&&e.lowerThirdRatio?`${t.verticalProportions.lowerThirdRatio}%`:null},getScore:t=>{var e;return(e=t.verticalProportions)==null?void 0:e.score}},{category:"Vertical Proportions",parameter:"نسبت لب بالا به بخش پایینی صورت",idealValue:"33.3%",description:"لب بالا باید یک سوم بخش پایینی صورت باشد (نسبت 1:2 با لب پایین + چانه).",getValue:t=>{var e;return(e=t.verticalProportions)!=null&&e.upperLipRatio?`${t.verticalProportions.upperLipRatio}%`:null},getScore:t=>{var e;return(e=t.verticalProportions)==null?void 0:e.lowerFaceScore}},{category:"Vertical Proportions",parameter:"نسبت لب پایین + چانه به بخش پایینی صورت",idealValue:"66.7%",description:"لب پایین + چانه باید دو سوم بخش پایینی صورت باشد.",getValue:t=>{var e;return(e=t.verticalProportions)!=null&&e.lowerLipChinRatio?`${t.verticalProportions.lowerLipChinRatio}%`:null}},{category:"Facial Index",parameter:"نسبت قدامی-تحتانی (Facial Index)",idealValue:"1.3 ± 0.1",description:"نسبت ارتفاع صورت به عرض صورت. نرمال: 1.3 ± 0.1. بالاتر → صورت کشیده (Long Face)، پایین‌تر → صورت پهن (Short Face).",getValue:t=>{var e;return(e=t.facialIndex)==null?void 0:e.facialIndex},getScore:t=>{var e;return(e=t.facialIndex)==null?void 0:e.score},getGrade:t=>{var e;return(e=t.facialIndex)==null?void 0:e.grade}},{category:"Transverse Proportions",parameter:"نسبت عرض بینی به فاصله بین چشم‌ها",idealValue:"≈ 1:1",description:"عرض بینی (Alar width) باید تقریباً برابر با فاصله بین گوشه داخلی چشم‌ها (Intercanthal distance) باشد.",getValue:t=>{var e;return(e=t.transverseProportions)==null?void 0:e.alarToIntercanthalRatio},getScore:t=>{var e;return(e=t.transverseProportions)==null?void 0:e.alarToIntercanthalScore}},{category:"Transverse Proportions",parameter:"نسبت عرض دهان به فاصله بین مردمک‌ها",idealValue:"≈ 1:1",description:"عرض دهان باید تقریباً برابر با فاصله بین مردمک‌ها باشد.",getValue:t=>{var e;return(e=t.transverseProportions)==null?void 0:e.mouthToPupillaryRatio},getScore:t=>{var e;return(e=t.transverseProportions)==null?void 0:e.mouthToPupillaryScore}},{category:"Transverse Proportions",parameter:"نسبت عرض دهان به عرض بینی",idealValue:"1.3",description:"عرض دهان باید تقریباً 1.3 برابر عرض بینی باشد.",getValue:t=>{var e;return(e=t.transverseProportions)==null?void 0:e.noseToMouthWidthRatio},getScore:t=>{var e;return(e=t.transverseProportions)==null?void 0:e.noseToMouthWidthScore}},{category:"Lip Proportions",parameter:"طول لب بالا (Sn–Stm)",idealValue:"20-22 mm",description:"طول لب بالا باید بین 20 تا 22 میلی‌متر باشد.",getValue:t=>{var e;return(e=t.lipProportions)!=null&&e.upperLipLengthMM?`${t.lipProportions.upperLipLengthMM} mm`:null},getScore:t=>{var e;return(e=t.lipProportions)==null?void 0:e.upperLipLengthScore}},{category:"Lip Proportions",parameter:"طول لب پایین + چانه (Stm–Me)",idealValue:"40-44 mm",description:"طول لب پایین + چانه باید بین 40 تا 44 میلی‌متر باشد.",getValue:t=>{var e;return(e=t.lipProportions)!=null&&e.lowerLipChinLengthMM?`${t.lipProportions.lowerLipChinLengthMM} mm`:null},getScore:t=>{var e;return(e=t.lipProportions)==null?void 0:e.lowerLipChinLengthScore}},{category:"Lip Proportions",parameter:"نسبت لب پایین به لب بالا",idealValue:"2.0 (1:2)",description:"نسبت طول لب پایین به لب بالا باید 2:1 باشد (لب پایین دو برابر لب بالا).",getValue:t=>{var e;return(e=t.lipProportions)==null?void 0:e.upperToLowerLipRatio},getScore:t=>{var e;return(e=t.lipProportions)==null?void 0:e.upperToLowerLipScore}}],Ee={glabella:27,subnasale:33,pogonion:8,nose_tip:30,chin:8,menton:8,right_eye_start:36,right_eye_end:41,right_eye_inner:39,right_eye_outer:36,right_eye_top:37,right_eye_bottom:41,left_eye_start:42,left_eye_end:47,left_eye_inner:42,left_eye_outer:45,left_eye_top:43,left_eye_bottom:47,jaw_left:0,jaw_right:16,chin_left:0,chin_right:16,mouth_left:48,mouth_right:54,mouth_top:51,mouth_bottom:57},bt={left_eye_inner:133,left_eye:33,left_eye_outer:7,left_eye_top:159,left_eye_bottom:145,left_eye_corner:33,right_eye_inner:362,right_eye:263,right_eye_outer:249,right_eye_top:386,right_eye_bottom:374,right_eye_corner:263,nose_tip:1,nose_bridge_top:6,nose_bridge_1:6,nose_bridge_4:19,nose_left:131,nose_right:360,nose_bottom:2,subnasale:2,mouth_left:61,mouth_right:291,mouth_top:13,mouth_bottom:14,mouth_center_top:13,mouth_center_bottom:14,mouth_outer_1:61,mouth_outer_3:13,mouth_outer_5:291,mouth_outer_9:14,chin:175,chin_center:175,chin_8:175,chin_left:172,chin_right:397,pogonion:175,menton:175,forehead:10,face_left:172,face_right:397,glabella:9,left_cheek:116,right_cheek:345,jaw_left:172,jaw_right:397},Rt={0:"Jaw-L",1:"Jaw",2:"Jaw",3:"Jaw",4:"Jaw",5:"Jaw",6:"Jaw",7:"Jaw",8:"Chin",9:"Jaw",10:"Jaw",11:"Jaw",12:"Jaw",13:"Jaw",14:"Jaw",15:"Jaw",16:"Jaw-R",17:"Eyebrow-R-Outer",18:"Eyebrow-R",19:"Eyebrow-R",20:"Eyebrow-R",21:"Eyebrow-R-Inner",22:"Eyebrow-L-Inner",23:"Eyebrow-L",24:"Eyebrow-L",25:"Eyebrow-L",26:"Eyebrow-L-Outer",27:"Glabella",28:"Nose-Bridge",29:"Nose-Bridge",30:"Nose-Tip",31:"Nose-L",32:"Nose",33:"Subnasale",34:"Nose",35:"Nose-R",36:"Eye-R-Outer",37:"Eye-R-Top",38:"Eye-R",39:"Eye-R-Inner",40:"Eye-R",41:"Eye-R-Bottom",42:"Eye-L-Inner",43:"Eye-L-Top",44:"Eye-L",45:"Eye-L-Outer",46:"Eye-L",47:"Eye-L-Bottom",48:"Mouth-L",49:"Mouth-Outer",50:"Mouth-Outer",51:"Mouth-Top",52:"Mouth-Outer",53:"Mouth-Outer",54:"Mouth-R",55:"Mouth-Outer",56:"Mouth-Outer",57:"Mouth-Bottom",58:"Mouth-Outer",59:"Mouth-Outer",60:"Mouth-Outer",61:"Mouth-Outer",62:"Upper-Lip",63:"Lower-Lip",64:"Mouth-Outer",65:"Mouth-Outer",66:"Mouth-Outer",67:"Mouth-Outer"},Oe={1:"Nose-Tip",2:"Subnasale",6:"Nose-Bridge-Top",19:"Nose-Bridge",131:"Nose-L",360:"Nose-R",9:"Glabella",10:"Forehead",7:"Eye-L-Outer",33:"Eye-L",133:"Eye-L-Inner",145:"Eye-L-Bottom",159:"Eye-L-Top",249:"Eye-R-Outer",263:"Eye-R",362:"Eye-R-Inner",374:"Eye-R-Bottom",386:"Eye-R-Top",13:"Mouth-Top",14:"Mouth-Bottom",61:"Mouth-L",291:"Mouth-R",172:"Face-L",175:"Chin",397:"Face-R",0:"Face-Outline",11:"Face-Outline",12:"Face-Outline",116:"Cheek-L",345:"Cheek-R"};function Tt({imageUrl:t,landmarks:e=[],showLandmarks:o=!0,onShowLandmarksChange:r,showOutlines:a=!1,onShowOutlinesChange:c,showProfileLines:g=!1,onShowProfileLinesChange:l,showFrontalLines:_=!1,onShowFrontalLinesChange:y,showLandmarkNames:b=!0,onShowLandmarkNamesChange:R,onImageError:w,onImageLoad:D}){const N=E.useRef(null),W=E.useRef(null),X=E.useRef(null),[Q,se]=E.useState({width:0,height:0}),[J,de]=E.useState({width:800,height:600}),[Ve,me]=E.useState(!1),[Fe,we]=E.useState(null),[ge,fe]=E.useState(0),[ee,le]=E.useState(!1),[ie,je]=E.useState(1),[Ne,He]=E.useState({x:0,y:0}),[Qe,Ie]=E.useState(!1),[Me,et]=E.useState({x:0,y:0}),[Pe,dt]=E.useState(o),[Ae,De]=E.useState(a),[Ge,tt]=E.useState(g),[Ue,Xe]=E.useState(_),[Se,ce]=E.useState(b),Te=E.useCallback(()=>{if(!X.current||!W.current)return;const C=X.current,i=W.current.getBoundingClientRect(),te=i.width,G=i.height,p=te/C.width,h=G/C.height,M=Math.min(p,h,1);de({width:C.width*M,height:C.height*M})},[]),it=E.useCallback((C,i)=>{const te=N.current;if(!te)return null;const G=te.getBoundingClientRect();return{x:C-G.left,y:i-G.top}},[]),ot=E.useCallback(()=>{t&&(fe(0),le(!1),we(null),me(!1),setTimeout(()=>{fe(C=>C+1)},50))},[t]),nt=E.useCallback(C=>C.startsWith("blob:")?new Promise(i=>{const te=new Image,G=setTimeout(()=>{console.warn("[Landmark Visualizer] Blob URL validation timeout"),te.dispatchEvent(new Event("error"))},3e3);te.onload=()=>{clearTimeout(G),console.log("[Landmark Visualizer] Blob URL validation successful"),i(!0)},te.onerror=()=>{clearTimeout(G),console.error("[Landmark Visualizer] Blob URL validation failed"),i(!1)},te.src=C}):Promise.resolve(!0),[]);E.useEffect(()=>{if(!t){console.warn("[Landmark Visualizer] No imageUrl provided"),X.current=null,se({width:0,height:0}),me(!1),we("No image URL provided"),w&&w("No image URL provided");return}me(!1),we(null),le(!1),console.log("[Landmark Visualizer] Loading image:",{url:t==null?void 0:t.substring(0,100),isBlobUrl:t.startsWith("blob:"),timestamp:new Date().toISOString()}),(async()=>{try{t.startsWith("blob:")&&(console.log("[Landmark Visualizer] Validating blob URL before loading..."),await nt(t)||(console.error("[Landmark Visualizer] Blob URL is invalid or expired:",t),console.warn("[Landmark Visualizer] Blob URL validation failed, but proceeding with load attempt")));const i=new window.Image;i.crossOrigin="anonymous";let te=null;t.startsWith("blob:")?te=setTimeout(()=>{const G="Blob URL loading timeout - URL may be invalid";console.warn(`[Landmark Visualizer] ${G}:`,t==null?void 0:t.substring(0,100)),i.onerror(new Error(G))},5e3):te=setTimeout(()=>{const G="Image loading timeout";console.warn(`[Landmark Visualizer] ${G}:`,t==null?void 0:t.substring(0,100)),i.onerror(new Error(G))},15e3),i.onload=()=>{te&&clearTimeout(te),console.log("[Landmark Visualizer] Image loaded successfully:",{width:i.width,height:i.height,naturalWidth:i.naturalWidth,naturalHeight:i.naturalHeight,complete:i.complete,isBlobUrl:t.startsWith("blob:"),attempt:ge+1}),X.current=i,se({width:i.width,height:i.height}),me(!0),fe(0),le(!1),we(null),D&&D({success:!0,width:i.width,height:i.height,isBlobUrl:t.startsWith("blob:")}),setTimeout(()=>{Te()},100)},i.onerror=G=>{te&&clearTimeout(te);const p=(G==null?void 0:G.message)||"Failed to load image";console.error("[Landmark Visualizer] Error loading image:",{error:p,imageUrl:t==null?void 0:t.substring(0,100),isBlobUrl:t.startsWith("blob:"),attempt:ge+1,timestamp:new Date().toISOString()}),X.current=null,se({width:0,height:0}),me(!1),we(p),le(!1),w&&w(p)},i.src=t}catch(i){console.error("[Landmark Visualizer] Unexpected error during image load:",i),we("Unexpected error occurred"),w&&w("Unexpected error occurred")}})()},[t,Te,w,D,nt,ge]),E.useEffect(()=>{const C=()=>{Te()};return window.addEventListener("resize",C),()=>window.removeEventListener("resize",C)},[Te]),E.useEffect(()=>{var K;const C=N.current;if(!C||!W.current){console.warn("[Landmark Visualizer] Canvas or container not ready");return}if(!X.current){console.warn("[Landmark Visualizer] Image not loaded yet");const k=C.getContext("2d"),O=W.current.getBoundingClientRect();C.width=O.width,C.height=O.height,k.clearRect(0,0,C.width,C.height),k.fillStyle="rgba(0, 0, 0, 0.5)",k.fillRect(0,0,C.width,C.height),k.fillStyle="white",k.font="16px Arial",k.textAlign="center",Fe?(k.fillText(`خطا در بارگذاری تصویر: ${Fe}`,C.width/2,C.height/2),ee&&(k.font="14px Arial",k.fillText("در حال تلاش مجدد...",C.width/2,C.height/2+25))):ee?k.fillText("در حال تلاش مجدد...",C.width/2,C.height/2):k.fillText("در حال بارگذاری تصویر...",C.width/2,C.height/2);return}const i=C.getContext("2d"),te=W.current.getBoundingClientRect();C.width=te.width,C.height=te.height,i.clearRect(0,0,C.width,C.height);const G=X.current;if(!G.complete||G.naturalWidth===0){console.warn("[Landmark Visualizer] Image not fully loaded:",{complete:G.complete,naturalWidth:G.naturalWidth,naturalHeight:G.naturalHeight,src:(K=G.src)==null?void 0:K.substring(0,100)});return}const h=Math.min(te.width/G.width,te.height/G.height,1)*ie,M=G.width*h,S=G.height*h,j=(C.width-M)/2+Ne.x,x=(C.height-S)/2+Ne.y;try{i.drawImage(G,j,x,M,S),console.log("[Landmark Visualizer] Image drawn:",{imageSize:{width:G.width,height:G.height},canvasSize:{width:C.width,height:C.height},scaledSize:{width:M,height:S},position:{x:j,y:x},landmarksCount:e.length})}catch(k){console.error("[Landmark Visualizer] Error drawing image:",k)}const L=k=>{Array.isArray(k)||(k=[k]);for(const A of k){const u=e.find(V=>{if(!V.name)return!1;const F=V.name.toLowerCase(),m=A.toLowerCase();return F===m||F.includes(m)||m.includes(F)});if(u)return u}const O=e.length,z=O===68,P=O>=400;if((z||P)&&e.some(A=>A.name&&A.name.startsWith("landmark_")))for(const A of k){const u=A.toLowerCase();let V=null;if(z?(V=Ee[u],V===void 0&&u.includes("eye")&&u.includes("inner")&&(u.includes("left")||u.includes("l")?V=Ee.left_eye_inner:(u.includes("right")||u.includes("r"))&&(V=Ee.right_eye_inner))):P&&(V=bt[u],V===void 0&&u.includes("eye")&&u.includes("inner")&&(u.includes("left")||u.includes("l")?V=bt.left_eye_inner:(u.includes("right")||u.includes("r"))&&(V=bt.right_eye_inner))),V!=null){const m=e.find(s=>{var T;return(s.index!==void 0?s.index:s.name?parseInt(((T=s.name.match(/landmark_(\d+)/))==null?void 0:T[1])||"-1",10):-1)===V});if(m)return console.log(`[Landmark Visualizer] Found ${P?"MediaPipe":"dlib"} landmark "${A}" at index ${V}`),m}const F=u.match(/landmark[_\s]?(\d+)/);if(F){const m=parseInt(F[1],10),s=e.find(v=>{var I;return(v.index!==void 0?v.index:v.name?parseInt(((I=v.name.match(/landmark_(\d+)/))==null?void 0:I[1])||"-1",10):-1)===m});if(s)return s}if(z){if(u==="left_pupil"){const m=e.filter(s=>{var T;const v=s.index!==void 0?s.index:s.name?parseInt(((T=s.name.match(/landmark_(\d+)/))==null?void 0:T[1])||"-1",10):-1;return v>=Ee.left_eye_start&&v<=Ee.left_eye_end});if(m.length>0){const s=m.reduce((T,I)=>T+I.x,0)/m.length,v=m.reduce((T,I)=>T+I.y,0)/m.length;return{x:s,y:v,index:69,name:"left_pupil"}}}else if(u==="right_pupil"){const m=e.filter(s=>{var T;const v=s.index!==void 0?s.index:s.name?parseInt(((T=s.name.match(/landmark_(\d+)/))==null?void 0:T[1])||"-1",10):-1;return v>=Ee.right_eye_start&&v<=Ee.right_eye_end});if(m.length>0){const s=m.reduce((T,I)=>T+I.x,0)/m.length,v=m.reduce((T,I)=>T+I.y,0)/m.length;return{x:s,y:v,index:68,name:"right_pupil"}}}}else if(P){if(u==="left_pupil"){const m=e.filter(s=>{var T;const v=s.index!==void 0?s.index:s.name?parseInt(((T=s.name.match(/landmark_(\d+)/))==null?void 0:T[1])||"-1",10):-1;return v===33||v===7||v===133||v===159||v===145});if(m.length>0){const s=m.reduce((T,I)=>T+I.x,0)/m.length,v=m.reduce((T,I)=>T+I.y,0)/m.length;return{x:s,y:v,index:469,name:"left_pupil"}}}else if(u==="right_pupil"){const m=e.filter(s=>{var T;const v=s.index!==void 0?s.index:s.name?parseInt(((T=s.name.match(/landmark_(\d+)/))==null?void 0:T[1])||"-1",10):-1;return v===263||v===249||v===362||v===386||v===374});if(m.length>0){const s=m.reduce((T,I)=>T+I.x,0)/m.length,v=m.reduce((T,I)=>T+I.y,0)/m.length;return{x:s,y:v,index:468,name:"right_pupil"}}}}}return null};if(Ge){i.strokeStyle="rgba(255, 255, 255, 0.8)",i.lineWidth=1;const k=L(["nose_bridge_top","forehead","nose_bridge_1"]),O=L(["nose_tip","nose"]),z=L(["chin_center","chin","chin_8"]),P=L(["chin_left","face_left","chin_1"]),A=L(["chin_right","face_right","chin_17"]),u=L(["left_eye_outer","left_eye_1"]),V=L(["left_eye_inner","left_eye_2"]),F=L(["right_eye_inner","right_eye_2"]),m=L(["right_eye_outer","right_eye_1"]);if(k&&O&&z&&P&&A){const s=k.y*h+x,v=z.y*h+x,T=P.x*h+j,I=A.x*h+j,B=v-s,U=I-T,Y=s+B/3,ne=s+B*2/3;i.beginPath(),i.moveTo(T,Y),i.lineTo(I,Y),i.stroke(),i.beginPath(),i.moveTo(T,ne),i.lineTo(I,ne),i.stroke();const ae=T+U/5,oe=T+U*2/5,ye=T+U*3/5,ve=T+U*4/5;if(i.beginPath(),i.moveTo(ae,s),i.lineTo(ae,v),i.stroke(),i.beginPath(),i.moveTo(oe,s),i.lineTo(oe,v),i.stroke(),i.beginPath(),i.moveTo(ye,s),i.lineTo(ye,v),i.stroke(),i.beginPath(),i.moveTo(ve,s),i.lineTo(ve,v),i.stroke(),u&&V&&F&&m){const ue=u.x*h+j,pe=V.x*h+j,xe=F.x*h+j,_e=m.x*h+j;i.beginPath(),i.moveTo(ue,s),i.lineTo(ue,v),i.stroke(),i.beginPath(),i.moveTo(pe,s),i.lineTo(pe,v),i.stroke(),i.beginPath(),i.moveTo(xe,s),i.lineTo(xe,v),i.stroke(),i.beginPath(),i.moveTo(_e,s),i.lineTo(_e,v),i.stroke()}}}if(Ue){const k=L(["glabella","nose_bridge_top","forehead"]),O=L(["subnasale","nose_bottom"]),z=L(["pogonion","chin_center","chin"]),P=L(["menton","chin"]),u=e.length>=400;let V=null,F=null;u?(V=e.find(f=>{var Z;return(f.index!==void 0?typeof f.index=="number"?f.index:parseInt(f.index,10):f.name?parseInt(((Z=f.name.match(/landmark_(\d+)/))==null?void 0:Z[1])||"-1",10):-1)===133}),F=e.find(f=>{var Z;return(f.index!==void 0?typeof f.index=="number"?f.index:parseInt(f.index,10):f.name?parseInt(((Z=f.name.match(/landmark_(\d+)/))==null?void 0:Z[1])||"-1",10):-1)===362})):(V=L(["left_eye_inner","eye_l_inner","eye-l-inner","left_eye_2","landmark_42"]),F=L(["right_eye_inner","eye_r_inner","eye-r-inner","right_eye_2","landmark_39"])),console.log("[Landmark Visualizer] Eye landmarks search result:",{leftEyeInner:V?{found:!0,x:V.x,y:V.y,name:V.name,index:V.index}:{found:!1},rightEyeInner:F?{found:!0,x:F.x,y:F.y,name:F.name,index:F.index}:{found:!1},landmarksCount:e.length,sampleLandmarks:e.slice(0,10).map(f=>({name:f.name,index:f.index,x:f.x,y:f.y}))});const m=e.length,s=m===68,v=m>=400;let T=L(["jaw_left","chin_left","face_left"]),I=L(["jaw_right","chin_right","face_right"]);if(!T&&e.some(f=>f.name&&f.name.startsWith("landmark_"))){const f=v?172:s?0:null;if(f!==null){const $=e.find(Z=>{var Ke;return(Z.index!==void 0?typeof Z.index=="number"?Z.index:parseInt(Z.index,10):Z.name?parseInt(((Ke=Z.name.match(/landmark_(\d+)/))==null?void 0:Ke[1])||"-1",10):-1)===f});$&&(T=$)}}if(!I&&e.some(f=>f.name&&f.name.startsWith("landmark_"))){const f=v?397:s?16:null;if(f!==null){const $=e.find(Z=>{var Ke;return(Z.index!==void 0?typeof Z.index=="number"?Z.index:parseInt(Z.index,10):Z.name?parseInt(((Ke=Z.name.match(/landmark_(\d+)/))==null?void 0:Ke[1])||"-1",10):-1)===f});$&&(I=$)}}let B=k?k.y*h+x:0,U=P?P.y*h+x:z?z.y*h+x:0;if(!k){const f=L(["forehead","nose_bridge_top"]);f&&(B=f.y*h+x)}if(!P&&!z){const f=L(["chin"]);f&&(U=f.y*h+x)}const Y={midline:"rgba(99, 102, 241, 0.85)",eyeR:"rgba(236, 72, 153, 0.75)",eyeL:"rgba(14, 165, 233, 0.75)",jawR:"rgba(34, 197, 94, 0.75)",jawL:"rgba(251, 146, 60, 0.75)",cheekR:"rgba(168, 85, 247, 0.75)",cheekL:"rgba(59, 130, 246, 0.75)"},ne=2.5,ae=[10,5];if(k&&O&&z){const f=(k.x+O.x+z.x)/3*h+j;i.strokeStyle=Y.midline,i.lineWidth=ne,i.setLineDash([]),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.fillStyle=Y.midline,i.font="bold 12px Arial",i.fillText("Midline",f+8,B-10)}else if(k&&z){const f=(k.x+z.x)/2*h+j;i.strokeStyle=Y.midline,i.lineWidth=ne,i.setLineDash([]),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.fillStyle=Y.midline,i.font="bold 12px Arial",i.fillText("Midline",f+8,B-10)}let oe=F;const ye=e.length,ve=ye===68,ue=ye>=400;if(!oe&&e.some(f=>f.name&&f.name.startsWith("landmark_"))){const f=ue?362:ve?39:null;f!==null&&(oe=e.find($=>{var ke;return($.index!==void 0?typeof $.index=="number"?$.index:parseInt($.index,10):$.name?parseInt(((ke=$.name.match(/landmark_(\d+)/))==null?void 0:ke[1])||"-1",10):-1)===f}),oe?console.log(`[Landmark Visualizer] Found Right Eye Inner by direct index search (${ue?"MediaPipe":"dlib"} index ${f}):`,oe):console.warn(`[Landmark Visualizer] Right Eye Inner not found at index ${f} (${ue?"MediaPipe":"dlib"})`))}if(oe){const f=oe.x*h+j,$=oe.y*h+x;console.log("[Landmark Visualizer] Drawing Eye-R-Inner vertical line:",{landmark:{x:oe.x,y:oe.y,name:oe.name,index:oe.index},canvas:{x:f,y:$},scale:h,offset:{x:j,y:x}}),i.strokeStyle=Y.eyeR,i.lineWidth=ne,i.setLineDash(ae),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.setLineDash([]),i.fillStyle=Y.eyeR,i.beginPath(),i.arc(f,$,5,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(255, 255, 255, 0.9)",i.lineWidth=1.5,i.stroke(),i.fillStyle=Y.eyeR,i.font="bold 11px Arial",i.fillText("Eye-R",f+8,$-15)}else console.error("[Landmark Visualizer] Right Eye Inner NOT FOUND!",{landmarksCount:e.length,sampleLandmarks:e.slice(35,45).map(f=>({name:f.name,index:f.index,x:f.x,y:f.y}))});let pe=V;if(!pe&&e.some(f=>f.name&&f.name.startsWith("landmark_"))){const f=ue?133:ve?42:null;f!==null&&(pe=e.find($=>{var ke;return($.index!==void 0?typeof $.index=="number"?$.index:parseInt($.index,10):$.name?parseInt(((ke=$.name.match(/landmark_(\d+)/))==null?void 0:ke[1])||"-1",10):-1)===f}),pe?console.log(`[Landmark Visualizer] Found Left Eye Inner by direct index search (${ue?"MediaPipe":"dlib"} index ${f}):`,pe):console.warn(`[Landmark Visualizer] Left Eye Inner not found at index ${f} (${ue?"MediaPipe":"dlib"})`))}if(pe){const f=pe.x*h+j,$=pe.y*h+x;console.log("[Landmark Visualizer] Drawing Eye-L-Inner vertical line:",{landmark:{x:pe.x,y:pe.y,name:pe.name,index:pe.index},canvas:{x:f,y:$},scale:h,offset:{x:j,y:x}}),i.strokeStyle=Y.eyeL,i.lineWidth=ne,i.setLineDash(ae),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.setLineDash([]),i.fillStyle=Y.eyeL,i.beginPath(),i.arc(f,$,5,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(255, 255, 255, 0.9)",i.lineWidth=1.5,i.stroke(),i.fillStyle=Y.eyeL,i.font="bold 11px Arial",i.fillText("Eye-L",f+8,$-15)}else console.error("[Landmark Visualizer] Left Eye Inner NOT FOUND!",{landmarksCount:e.length,sampleLandmarks:e.slice(40,50).map(f=>({name:f.name,index:f.index,x:f.x,y:f.y}))});if(I){const f=I.x*h+j;i.strokeStyle=Y.jawR,i.lineWidth=ne,i.setLineDash(ae),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.setLineDash([]),i.fillStyle=Y.jawR,i.font="bold 11px Arial",i.fillText("Jaw-R",f+8,U+15)}if(T){const f=T.x*h+j;i.strokeStyle=Y.jawL,i.lineWidth=ne,i.setLineDash(ae),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.setLineDash([]),i.fillStyle=Y.jawL,i.font="bold 11px Arial",i.fillText("Jaw-L",f+8,U+15)}let xe=null;if(ue?xe=e.find(f=>{var Z;return(f.index!==void 0?typeof f.index=="number"?f.index:parseInt(f.index,10):f.name?parseInt(((Z=f.name.match(/landmark_(\d+)/))==null?void 0:Z[1])||"-1",10):-1)===345}):xe=L(["right_cheek","cheek_right","face_right"]),xe){const f=xe.x*h+j,$=xe.y*h+x;console.log("[Landmark Visualizer] Drawing Cheek-R vertical line:",{landmark:{x:xe.x,y:xe.y,name:xe.name,index:xe.index},canvas:{x:f,y:$}}),i.strokeStyle=Y.cheekR,i.lineWidth=ne,i.setLineDash(ae),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.setLineDash([]),i.fillStyle=Y.cheekR,i.beginPath(),i.arc(f,$,5,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(255, 255, 255, 0.9)",i.lineWidth=1.5,i.stroke(),i.fillStyle=Y.cheekR,i.font="bold 11px Arial",i.fillText("Cheek-R",f+8,$-15)}let _e=null;if(ue?_e=e.find(f=>{var Z;return(f.index!==void 0?typeof f.index=="number"?f.index:parseInt(f.index,10):f.name?parseInt(((Z=f.name.match(/landmark_(\d+)/))==null?void 0:Z[1])||"-1",10):-1)===116}):_e=L(["left_cheek","cheek_left","face_left"]),_e){const f=_e.x*h+j,$=_e.y*h+x;console.log("[Landmark Visualizer] Drawing Cheek-L vertical line:",{landmark:{x:_e.x,y:_e.y,name:_e.name,index:_e.index},canvas:{x:f,y:$}}),i.strokeStyle=Y.cheekL,i.lineWidth=ne,i.setLineDash(ae),i.beginPath(),i.moveTo(f,B-20),i.lineTo(f,U+20),i.stroke(),i.setLineDash([]),i.fillStyle=Y.cheekL,i.beginPath(),i.arc(f,$,5,0,2*Math.PI),i.fill(),i.strokeStyle="rgba(255, 255, 255, 0.9)",i.lineWidth=1.5,i.stroke(),i.fillStyle=Y.cheekL,i.font="bold 11px Arial",i.fillText("Cheek-L",f+8,$-15)}const ft=L(["left_pupil","left_eye"]),pt=L(["right_pupil","right_eye"]),mt=L(["mouth_left","mouth_outer_1"]),yt=L(["mouth_right","mouth_outer_5"]);ft&&pt&&(i.strokeStyle="rgba(245, 101, 101, 0.8)",i.lineWidth=2,i.setLineDash([6,3]),i.beginPath(),i.moveTo(ft.x*h+j,ft.y*h+x),i.lineTo(pt.x*h+j,pt.y*h+x),i.stroke(),i.setLineDash([])),mt&&yt&&(i.strokeStyle="rgba(251, 191, 36, 0.8)",i.lineWidth=2,i.setLineDash([6,3]),i.beginPath(),i.moveTo(mt.x*h+j,mt.y*h+x),i.lineTo(yt.x*h+j,yt.y*h+x),i.stroke(),i.setLineDash([]))}if(Ae){i.strokeStyle="rgba(255, 255, 255, 0.8)",i.lineWidth=2,i.fillStyle="rgba(255, 255, 255, 0.1)";const k=L(["chin_left","face_left","chin_1"]),O=L(["chin_right","face_right","chin_17"]),z=L(["nose_bridge_top","forehead"]),P=L(["chin_center","chin","chin_8"]);if(k&&O&&z&&P){const ve=[{x:k.x*h+j,y:z.y*h+x},{x:O.x*h+j,y:z.y*h+x},{x:O.x*h+j,y:P.y*h+x},{x:k.x*h+j,y:P.y*h+x}];i.beginPath(),i.moveTo(ve[0].x,ve[0].y);for(let ue=1;ue<ve.length;ue++)i.lineTo(ve[ue].x,ve[ue].y);i.closePath(),i.fill(),i.stroke()}const A=L(["left_eye_outer","left_eye_1"]),u=L(["left_eye_inner","left_eye_2"]),V=L(["left_eye_top"]),F=L(["left_eye_bottom"]);A&&u&&V&&F&&(i.beginPath(),i.moveTo(A.x*h+j,V.y*h+x),i.lineTo(u.x*h+j,V.y*h+x),i.lineTo(u.x*h+j,F.y*h+x),i.lineTo(A.x*h+j,F.y*h+x),i.closePath(),i.fill(),i.stroke());const m=L(["right_eye_outer","right_eye_1"]),s=L(["right_eye_inner","right_eye_2"]),v=L(["right_eye_top"]),T=L(["right_eye_bottom"]);m&&s&&v&&T&&(i.beginPath(),i.moveTo(m.x*h+j,v.y*h+x),i.lineTo(s.x*h+j,v.y*h+x),i.lineTo(s.x*h+j,T.y*h+x),i.lineTo(m.x*h+j,T.y*h+x),i.closePath(),i.fill(),i.stroke());const I=L(["nose_tip","nose"]),B=L(["nose_left","nose_tip_2"]),U=L(["nose_right","nose_tip_4"]),Y=L(["nose_bridge_top","nose_bridge_1"]);I&&B&&U&&Y&&(i.beginPath(),i.moveTo(Y.x*h+j,Y.y*h+x),i.lineTo(B.x*h+j,I.y*h+x),i.lineTo(U.x*h+j,I.y*h+x),i.closePath(),i.fill(),i.stroke());const ne=L(["mouth_left","mouth_left_corner"]),ae=L(["mouth_right","mouth_right_corner"]),oe=L(["mouth_top","mouth_center_top"]),ye=L(["mouth_bottom","mouth_center_bottom"]);ne&&ae&&oe&&ye&&(i.beginPath(),i.moveTo(ne.x*h+j,oe.y*h+x),i.lineTo(ae.x*h+j,oe.y*h+x),i.lineTo(ae.x*h+j,ye.y*h+x),i.lineTo(ne.x*h+j,ye.y*h+x),i.closePath(),i.fill(),i.stroke())}Pe&&e.forEach(k=>{const{x:O,y:z,name:P,index:A}=k,u=O*h+j,V=z*h+x,F=e.length>100?2:3;if(i.beginPath(),i.arc(u,V,F,0,2*Math.PI),i.fillStyle="rgba(255, 255, 255, 0.9)",i.fill(),i.strokeStyle="rgba(0, 0, 0, 0.8)",i.lineWidth=1,i.stroke(),Se&&P){const m=e.length,s=m===68,v=m>=400;if(v&&A!==void 0){const I=typeof A=="number"?A:parseInt(A,10);(I===1||I===9||I===175||I===133)&&!isNaN(I)&&console.log("[Landmark Visualizer] MediaPipe landmark check:",{originalIndex:A,indexType:typeof A,parsedIndex:I,name:P,hasInMapping:Oe[I]!==void 0,mappingValue:Oe[I]||null,landmarkCount:m})}let T=!1;if(s)T=!0;else if(v){let I=null;if(A!=null)I=typeof A=="number"?A:parseInt(A,10);else if(P){const B=P.match(/landmark_(\d+)/);B&&(I=parseInt(B[1],10))}I!==null&&!isNaN(I)&&(T=Oe[I]!==void 0,T&&console.log(`[Landmark Visualizer] MediaPipe landmark ${I} (${P}) will be shown as: ${Oe[I]}`))}else T=m<=100;if(T){let I=null;if(A!=null){const B=typeof A=="number"?A:parseInt(A,10);isNaN(B)||(s?I=Rt[B]:v&&(I=Oe[B]))}if(!I){const B=P.match(/landmark_(\d+)/);if(B){const U=parseInt(B[1],10);s?I=Rt[U]:v&&(I=Oe[U]),!I&&s&&(I=`${U}`)}else P.includes("_")?I=P.split("_").map(U=>U.charAt(0).toUpperCase()+U.slice(1)).join(" "):I=P}if(I){const B=e.length>50?9:11;i.font=`bold ${B}px Arial`,i.textAlign="left",i.textBaseline="middle";const Y=i.measureText(I).width,ne=B+2,ae=3,oe=u+F+4,ye=V;i.fillStyle="rgba(0, 0, 0, 0.75)",i.fillRect(oe-ae,ye-ne/2-ae,Y+ae*2,ne+ae*2),i.fillStyle="rgba(255, 255, 255, 1)",i.fillText(I,oe,ye)}}}})},[e,J,ie,Ne,Pe,Ae,Ge,Ue,Se,Ve,Q,Fe,ee]);const at=C=>{const i=it(C.clientX,C.clientY);i&&(Ie(!0),et({x:i.x-Ne.x,y:i.y-Ne.y}))},rt=C=>{const i=it(C.clientX,C.clientY);i&&Qe&&He({x:i.x-Me.x,y:i.y-Me.y})},Je=()=>{Ie(!1)},st=()=>{Ie(!1)},Ye=()=>{je(C=>Math.min(C*1.2,20))},ut=()=>{je(C=>Math.max(C/1.2,.1))},gt=()=>{je(1),He({x:0,y:0})};return n.jsx(he,{sx:{width:"100%",maxWidth:"100%"},children:n.jsxs(q,{spacing:2,children:[n.jsxs(q,{direction:"row",spacing:1,alignItems:"center",justifyContent:"space-between",sx:{flexWrap:"wrap",gap:1},children:[n.jsxs(q,{direction:"row",spacing:1,alignItems:"center",children:[n.jsx(Ze,{title:"Zoom In",children:n.jsx(Ce,{size:"small",onClick:Ye,children:n.jsx(Le,{icon:"carbon:zoom-in"})})}),n.jsx(Ze,{title:"Zoom Out",children:n.jsx(Ce,{size:"small",onClick:ut,children:n.jsx(Le,{icon:"carbon:zoom-out"})})}),n.jsx(Ze,{title:"Reset Zoom",children:n.jsx(Ce,{size:"small",onClick:gt,children:n.jsx(Le,{icon:"carbon:reset"})})}),Fe&&n.jsx(Ze,{title:"تلاش مجدد برای بارگذاری تصویر",children:n.jsx(Ce,{size:"small",onClick:ot,disabled:ee,color:"error",children:n.jsx(Le,{icon:"carbon:retry"})})})]}),n.jsx(q,{direction:"row",spacing:1,alignItems:"center",children:n.jsx(Ze,{title:Se?"مخفی کردن نام لندمارک‌ها":"نمایش نام لندمارک‌ها",children:n.jsx(Ce,{size:"small",onClick:()=>{ce(!Se),R&&R(!Se)},color:Se?"primary":"default",children:n.jsx(Le,{icon:Se?"solar:tag-bold":"solar:tag-linear"})})})})]}),n.jsx(he,{ref:W,sx:{position:"relative",width:"100%",overflow:"hidden",minHeight:400},children:n.jsx(he,{component:"canvas",ref:N,onMouseDown:at,onMouseMove:rt,onMouseUp:Je,onMouseLeave:st,sx:{display:"block",width:"100%",height:"100%",cursor:Qe?"grabbing":"grab"}})}),Fe&&n.jsxs(H,{variant:"body2",sx:{color:"error.main",textAlign:"center",py:1},children:["خطا در بارگذاری تصویر: ",Fe,ee&&" (در حال تلاش مجدد...)",ge>0&&!ee&&` (تعداد تلاش: ${ge})`]}),e.length===0&&!Fe&&n.jsx(H,{variant:"body2",sx:{color:"text.secondary",textAlign:"center",py:2},children:"No landmarks to display"})]})})}Tt.propTypes={imageUrl:re.string,landmarks:re.arrayOf(re.shape({x:re.number.isRequired,y:re.number.isRequired,name:re.string})),showLandmarks:re.bool,onShowLandmarksChange:re.func,showOutlines:re.bool,onShowOutlinesChange:re.func,showProfileLines:re.bool,onShowProfileLinesChange:re.func,showFrontalLines:re.bool,onShowFrontalLinesChange:re.func,showLandmarkNames:re.bool,onShowLandmarkNamesChange:re.func,onImageError:re.func,onImageLoad:re.func};function wi({initialImages:t=[],patientId:e=null}){var C,i,te,G;const{user:o}=jt(),[r,a]=E.useState([]),[c,g]=E.useState(null),[l,_]=E.useState(!1),[y,b]=E.useState(null),[R,w]=E.useState(null),[D,N]=E.useState([]),[W,X]=E.useState(""),[Q,se]=E.useState([]),[J,de]=E.useState(null),[Ve,me]=E.useState(!1),[Fe,we]=E.useState(new Set),[ge,fe]=E.useState(null),[ee,le]=E.useState([]),[ie,je]=E.useState(null),[Ne,He]=E.useState(!1),[Qe,Ie]=E.useState(!1),[Me,et]=E.useState(null),[Pe,dt]=E.useState(!1),Ae=E.useRef(!0),De=E.useRef(!1),Ge=E.useRef(J);E.useEffect(()=>{Ge.current=J},[J]);const[tt,Ue]=E.useState(0),[Xe,Se]=E.useState(5),ce=c!==null&&c<r.length?r[c]:null,Te=(ce==null?void 0:ce.preview)||null,it=E.useCallback(p=>{if(p&&p.length>0){const h=p.map(M=>{const S=URL.createObjectURL(M);return{file:M,preview:S,id:`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,name:M.name,size:M.size,type:M.type}});a(M=>{const S=[...M,...h];return c===null&&h.length>0&&g(M.length),S}),w(null)}},[c]),ot=E.useCallback(async p=>{var h,M,S,j;if(!e||!(p!=null&&p.id)){console.warn("⚠️ [FacialLandmarkView] Cannot delete image: missing patientId or image.id");return}try{await We.delete(`${ze.patients}/${e}/images`,{data:{imageId:p.id},headers:{Authorization:`Bearer ${o==null?void 0:o.accessToken}`,"Content-Type":"application/json"}}),$e.success("تصویر با موفقیت حذف شد")}catch(x){console.error("❌ [FacialLandmarkView] Error deleting image:",x);const L=((M=(h=x.response)==null?void 0:h.data)==null?void 0:M.error)||((j=(S=x.response)==null?void 0:S.data)==null?void 0:j.message)||x.message||"خطای نامشخص";$e.error(`خطا در حذف تصویر: ${L}`)}},[e,o==null?void 0:o.accessToken]),nt=E.useCallback(p=>{a(h=>{let M=-1;if(typeof p=="number"?M=p:(M=h.findIndex(x=>x.file===p),M===-1&&(M=h.findIndex(x=>!!(x.file&&x.file.name===p.name&&x.file.size===p.size)))),M===-1)return h;const S=h[M];S!=null&&S.serverId&&e&&ot({id:S.serverId});const j=h.filter((x,L)=>L!==M);return S!=null&&S.preview&&c!==M&&setTimeout(()=>{try{S.preview.startsWith("blob:")&&(URL.revokeObjectURL(S.preview),console.log("[Facial Landmark] Revoked blob URL for removed file:",S.name))}catch(x){console.warn("[Facial Landmark] Error revoking blob URL:",x)}},100),c===M?j.length>0?g(0):(g(null),b(null),N([]),de(null)):c>M&&g(c-1),j})},[c,e,ot]);E.useCallback(p=>{g(p),b(null),N([]),de(null),w(null)},[]);const at=E.useCallback(p=>{a(h=>{const M=[...h],S=M[p];if(S&&S.file){if(S.preview&&S.preview.startsWith("blob:"))try{URL.revokeObjectURL(S.preview)}catch(x){console.warn("[Facial Landmark] Error revoking old blob URL:",x)}const j=URL.createObjectURL(S.file);M[p]={...S,preview:j},console.log("[Facial Landmark] Refreshed blob URL for file:",S.name),we(x=>{const L=new Set(x);return L.delete(S.id),L})}return M})},[]),rt=E.useCallback(p=>{console.log("[Facial Landmark] Image load error from LandmarkVisualizer:",p),p.isBlobUrl&&c!==null&&r[c]&&(we(h=>new Set([...h,r[c].id])),console.log("[Facial Landmark] Auto-refreshing blob URL due to error..."),setTimeout(()=>{at(c)},1e3)),w(`خطا در بارگذاری تصویر: ${p.error}`)},[c,r,at]),Je=E.useMemo(()=>["mediapipe","face_alignment","dlib"],[]);E.useEffect(()=>{se(Je),(!W||!Je.includes(W))&&X(Je[0])},[]);const st=E.useMemo(()=>(t==null?void 0:t.map(p=>p.path||p.id).join(","))||"",[t]);E.useEffect(()=>{st&&me(!1)},[st]),E.useEffect(()=>{t&&t.length>0&&!Ve?(async()=>{var M,S,j;const h=[];for(const x of t)try{const L=(M=x.path)!=null&&M.startsWith("http")?x.path:ct(x.path);console.log("[Facial Landmark] Loading initial image:",{path:x.path,url:L,originalName:x.originalName||x.name});const K=await fetch(L);if(!K.ok){console.error(`Failed to fetch image ${L}:`,K.status,K.statusText);continue}const k=await K.blob();if(!k||k.size===0){console.error(`Blob is empty for image ${L}`);continue}let O="jpg";if(k.type)k.type.includes("png")?O="png":(k.type.includes("jpeg")||k.type.includes("jpg"))&&(O="jpg");else if(L){const F=(j=(S=L.match(/\.(jpg|jpeg|png)$/i))==null?void 0:S[1])==null?void 0:j.toLowerCase();F&&(O=F==="jpeg"?"jpg":F)}let z=x.originalName||x.name||`image.${O}`;z=`${z.replace(/\.[^/.]+$/,"")}.${O}`;const P=k.type||(O==="png"?"image/png":"image/jpeg");let A=new File([k],z,{type:P});if(!A||A.size===0){console.error(`Failed to create file for image ${L}: file is empty`);continue}if(!A.name||A.name.trim()===""||!A.name.includes(".")){console.error(`Invalid file name for image ${L}:`,A.name);const F=`image-${Date.now()}.${O}`,m=new File([k],F,{type:P});if(m&&m.size>0)A=m,z=F;else{console.error(`Failed to create file with valid name for image ${L}`);continue}}const u=x.id||`${Date.now()}-${Math.random().toString(36).substr(2,9)}`,V=URL.createObjectURL(A);h.push({id:u,file:A,preview:V,name:A.name,size:A.size,type:A.type}),console.log("[Facial Landmark] Successfully loaded image:",{id:u,fileName:A.name,size:A.size,type:A.type,blobSize:k.size,blobType:k.type})}catch(L){console.error(`Error loading image ${x.path}:`,L)}h.length>0?(console.log("[Facial Landmark] Loaded",h.length,"initial images"),a(h),g(0),me(!0)):(console.warn("[Facial Landmark] No images were loaded from initialImages"),me(!0))})():(!t||t.length===0)&&me(!1)},[t,Ve]),E.useEffect(()=>()=>{setTimeout(()=>{r.forEach(p=>{if(p.preview&&p.preview.startsWith("blob:"))try{URL.revokeObjectURL(p.preview),console.log("[Facial Landmark] Cleaned up blob URL on unmount:",p.name)}catch(h){console.warn("[Facial Landmark] Error cleaning up blob URL:",h)}})},500)},[r]);const Ye=E.useCallback(async()=>{var p,h;if(console.log("📚 [FacialLandmarkView] loadAnalysisHistory called for patient:",e),!!e){He(!0);try{console.log("🔍 [FacialLandmarkView] Fetching patient data from API...");const M=await We.get(`${ze.patients}/${e}`,{headers:{Authorization:`Bearer ${o==null?void 0:o.accessToken}`}}),S=((p=M.data)==null?void 0:p.patient)||M.data;console.log("📊 [FacialLandmarkView] Patient data received:",{hasFacialLandmarkAnalysis:!!S.facialLandmarkAnalysis,facialLandmarkAnalysisType:typeof S.facialLandmarkAnalysis,facialLandmarkAnalysisLength:((h=S.facialLandmarkAnalysis)==null?void 0:h.length)||0});let j=[];if(S.facialLandmarkAnalysis)try{const x=S.facialLandmarkAnalysis;if(typeof x=="object")if(Array.isArray(x))j=x;else{const{analyses:L}=x;L&&Array.isArray(L)&&(j=L)}else if(typeof x=="string"){const L=x.trim();if(L.startsWith("{")||L.startsWith("[")){const K=JSON.parse(L);if(Array.isArray(K))j=K;else{const{analyses:k}=K;k&&Array.isArray(k)&&(j=k)}}}}catch(x){console.error("❌ [FacialLandmarkView] Failed to parse facial landmark analysis:",x)}else console.log("⚠️ [FacialLandmarkView] No facialLandmarkAnalysis field in patient data");if(console.log("📋 [FacialLandmarkView] Final analysis history:",j.length,"entries"),le(j),Ae.current&&j.length>0&&ie===null){const x=j.length-1;console.log("🔄 [FacialLandmarkView] Auto-selecting latest analysis on first load (index:",x,")"),je(x),Ae.current=!1}else Ae.current&&(Ae.current=!1)}catch(M){console.error("Failed to load analysis history:",M)}finally{He(!1)}}},[e,o==null?void 0:o.accessToken,ie]);E.useEffect(()=>{Ae.current=!0},[e]),E.useEffect(()=>{e&&(o!=null&&o.accessToken)&&Ye()},[e,o==null?void 0:o.accessToken,Ye]),E.useEffect(()=>{var p,h,M,S,j,x,L,K,k,O;if(ee.length>0&&ie!==null&&ie>=0&&ie<ee.length){const z=ee[ie],P=(p=z==null?void 0:z.analyses)==null?void 0:p[0];if(P){console.log("📥 Loading analysis from history (index:",ie,")"),console.log("📦 [FacialLandmarkView] Analysis data:",{hasResult:!!P.result,hasLandmarks:!!P.landmarks,landmarksInResult:!!((h=P.result)!=null&&h.landmarks),landmarksCount:((M=P.landmarks)==null?void 0:M.length)||((j=(S=P.result)==null?void 0:S.landmarks)==null?void 0:j.length)||0,serverImageId:P.serverImageId,modelId:P.modelId}),P.result&&(b(P.result),P.result.landmarks&&(!P.landmarks||P.landmarks.length===0)&&(console.log("📊 [FacialLandmarkView] Loading landmarks from result"),N(P.result.landmarks||[])));let A=[];if(P.landmarks&&P.landmarks.length>0?(console.log("📊 [FacialLandmarkView] Loading landmarks from firstAnalysis.landmarks"),A=P.landmarks,N(P.landmarks)):(x=P.result)!=null&&x.landmarks&&P.result.landmarks.length>0&&(console.log("📊 [FacialLandmarkView] Loading landmarks from firstAnalysis.result.landmarks"),A=P.result.landmarks,N(P.result.landmarks)),P.beautyAnalysis&&P.beautyAnalysis.success){if(console.log("✅ [FacialLandmarkView] Using saved beauty analysis"),de(P.beautyAnalysis),Array.isArray(A)&&A.length>0)try{const F=A.slice(0,5).map(m=>m&&typeof m=="object"&&("x"in m||"y"in m)?{x:m.x||0,y:m.y||0}:null).filter(Boolean);if(F.length>0){const m=JSON.stringify(F);De.current=m}}catch(F){console.warn("⚠️ [FacialLandmarkView] Error creating landmarks key:",F)}}else if(Array.isArray(A)&&A.length>0){console.log("🔄 [FacialLandmarkView] Recalculating beauty analysis from landmarks (count:",A.length,")");try{const F=_t(A);if(F&&F.success){console.log("✅ [FacialLandmarkView] Beauty analysis recalculated:",{success:F.success,overallScore:F.overallScore}),de(F);try{const m=A.slice(0,5).map(s=>s&&typeof s=="object"&&("x"in s||"y"in s)?{x:s.x||0,y:s.y||0}:null).filter(Boolean);if(m.length>0){const s=JSON.stringify(m);De.current=s}}catch(m){console.warn("⚠️ [FacialLandmarkView] Error creating landmarks key:",m)}}else console.warn("⚠️ [FacialLandmarkView] Beauty analysis calculation returned invalid result:",F),de(null)}catch(F){console.error("❌ [FacialLandmarkView] Error recalculating beauty analysis:",F),de(null)}}else console.warn("⚠️ [FacialLandmarkView] No landmarks found, cannot calculate beauty analysis"),de(null),De.current="";P.modelId&&X(P.modelId);const u=P.serverImageId||((L=P.result)==null?void 0:L.imageId)||((K=P.result)==null?void 0:K.serverImageId);console.log("🔍 [FacialLandmarkView] Looking for image:",{imageIdToLoad:u,initialImagesLength:t.length,imageFilesLength:r.length});let V=!1;if(u&&r.length>0){const F=r.find(m=>m.serverId&&String(m.serverId)===String(u)||m.id&&String(m.id)===String(u)||m.id&&m.id.includes(String(u)));if(F){console.log("✅ [FacialLandmarkView] Found image in imageFiles:",F);const m=r.findIndex(s=>s.serverId&&String(s.serverId)===String(u)||s.id&&String(s.id)===String(u)||s.id&&s.id.includes(String(u)));m>=0&&(g(m),V=!0)}}if(!V&&u&&t.length>0){const F=t.find(m=>String(m.id)===String(u)||String(m.serverId)===String(u));if(F){console.log("✅ [FacialLandmarkView] Found image in initialImages:",F);const m=(k=F.path)!=null&&k.startsWith("http")?F.path:(O=F.path)!=null&&O.startsWith("/uploads/")?`${ct(F.path)}`:`${ct(F.path)}`,s=r.find(v=>v.serverId===F.id||v.serverId&&String(v.serverId)===String(F.id));if(s){if(s.preview&&s.preview.startsWith("blob:")){try{URL.revokeObjectURL(s.preview)}catch(T){console.warn("⚠️ [FacialLandmarkView] Failed to revoke old blob URL:",T)}a(T=>{const I=[...T],B=I.findIndex(U=>U.serverId===F.id||U.serverId&&String(U.serverId)===String(F.id));return B>=0&&(I[B]={...I[B],preview:m}),I})}const v=r.findIndex(T=>T.serverId===F.id||T.serverId&&String(T.serverId)===String(F.id));v>=0&&(g(v),V=!0)}else{const v={file:null,preview:m,id:`server-${F.id}`,serverId:F.id,name:F.originalName||F.name,size:F.size,type:F.mimeType};a(T=>{const I=[...T,v];return g(I.length-1),I}),V=!0}}else console.warn("⚠️ [FacialLandmarkView] Image not found in initialImages:",u)}!V&&r.length>0?(console.log("⚠️ [FacialLandmarkView] Image not found by serverImageId, using first available image"),g(0)):!V&&!u&&console.log("⚠️ [FacialLandmarkView] No serverImageId found in analysis"),console.log("✅ Loaded analysis from history:",{hasResult:!!P.result,landmarksCount:A.length,hasBeauty:!!P.beautyAnalysis,model:P.modelId,serverImageId:u})}}},[ie,ee,t,r]),E.useEffect(()=>{if(!Array.isArray(D))return;let p="";if(D.length>0)try{const M=D.slice(0,5).map(S=>S&&typeof S=="object"&&("x"in S||"y"in S)?{x:S.x||0,y:S.y||0}:null).filter(Boolean);M.length>0&&(p=JSON.stringify(M))}catch(M){console.warn("⚠️ [FacialLandmarkView] Error creating landmarks key:",M)}const h=Ge.current;if(D.length>0&&(!h||!h.success)&&y){const M=De.current;if(M===p&&M!==""&&h)return;console.log("🔄 [FacialLandmarkView] Recalculating beauty analysis from landmarks (useEffect):",{landmarksCount:D.length,hasBeautyAnalysis:!!h,beautyAnalysisSuccess:h==null?void 0:h.success,hasResult:!!y});try{const S=_t(D);S&&S.success?(console.log("✅ [FacialLandmarkView] Beauty analysis recalculated (useEffect):",{success:S.success,overallScore:S.overallScore}),de(S),De.current=p):console.warn("⚠️ [FacialLandmarkView] Beauty analysis calculation returned invalid result:",S)}catch(S){console.error("❌ [FacialLandmarkView] Error recalculating beauty analysis (useEffect):",S)}}else D.length===0&&(De.current="")},[D,y]);const ut=E.useCallback(async(p=null)=>{var j,x,L,K,k,O;if(console.log("🔄 [FacialLandmarkView] saveAnalysis called with:",{patientId:e,hasResults:!!p,hasLandmarks:!!(p!=null&&p.landmarks||y!=null&&y.landmarks),landmarkCount:p!=null&&p.landmarks||y!=null&&y.landmarks?Object.keys((p==null?void 0:p.landmarks)||(y==null?void 0:y.landmarks)).length:0}),!e){console.warn("Cannot save analysis: patientId is missing");return}const h=p||y,M=D,S=J;try{const z=await We.get(`${ze.patients}/${e}`,{headers:{Authorization:`Bearer ${o==null?void 0:o.accessToken}`}}),P=((j=z.data)==null?void 0:j.patient)||z.data;let A=[];if(P.facialLandmarkAnalysis)try{const m=P.facialLandmarkAnalysis;if(typeof m=="object")Array.isArray(m)?A=m:m.analyses&&Array.isArray(m.analyses)&&(A=m.analyses);else if(typeof m=="string"){const s=m.trim();if(s.startsWith("{")||s.startsWith("[")){const v=JSON.parse(s);Array.isArray(v)?A=v:v.analyses&&Array.isArray(v.analyses)&&(A=v.analyses)}}}catch(m){console.error("Failed to parse existing history:",m)}if(!h){console.warn("No analysis results to save");return}let u=(ce==null?void 0:ce.serverId)||null;if(!u&&c!==null&&r[c]&&(u=r[c].serverId||null),!u&&ce&&t.length>0){const m=t.find(s=>{if(ce.preview&&s.path){const v=s.path.startsWith("http")?s.path:ct(s.path);if(ce.preview===v||ce.preview.includes(s.path))return!0}return!!(ce.name&&s.originalName&&(ce.name===s.originalName||ce.name===s.name))});m&&(u=m.id)}console.log("💾 [FacialLandmarkView] Saving analysis with serverImageId:",u);const V={id:`analysis_${Date.now()}`,timestamp:new Date().toISOString(),analyses:[{serverImageId:u,modelId:W,result:h,landmarks:M,beautyAnalysis:S}]},F=[...A,V];await We.put(`${ze.patients}/${e}`,{facialLandmarkAnalysis:JSON.stringify(F)},{headers:{Authorization:`Bearer ${o==null?void 0:o.accessToken}`,"Content-Type":"application/json"}}),console.log("✅ Facial landmark analysis saved to history"),$e.success("✅ نتایج آنالیز ذخیره شد");try{const m=await We.get(`${ze.patients}/${e}`,{headers:{Authorization:`Bearer ${o==null?void 0:o.accessToken}`}}),s=((x=m.data)==null?void 0:x.patient)||m.data;let v=[];if(s.facialLandmarkAnalysis)try{const T=s.facialLandmarkAnalysis;if(typeof T=="object")if(Array.isArray(T))v=T;else{const{analyses:I}=T;I&&Array.isArray(I)&&(v=I)}else if(typeof T=="string"){const I=T.trim();if(I.startsWith("{")||I.startsWith("[")){const B=JSON.parse(I);if(Array.isArray(B))v=B;else{const{analyses:U}=B;U&&Array.isArray(U)&&(v=U)}}}}catch(T){console.error("Failed to parse existing history:",T)}le(v)}catch(m){console.error("Failed to reload history:",m)}}catch(z){console.error("❌ Failed to save facial landmark analysis:",z);const P=((K=(L=z.response)==null?void 0:L.data)==null?void 0:K.error)||((O=(k=z.response)==null?void 0:k.data)==null?void 0:O.message)||z.message||"خطای نامشخص";$e.error(`خطا در ذخیره نتایج آنالیز: ${P}`)}},[e,y,D,J,W,ce,c,r,t,o==null?void 0:o.accessToken]),gt=async()=>{var h,M,S,j,x,L,K,k,O,z;console.log("🚀 [FacialLandmarkView] handleDetect called - starting analysis");let p=ce;if(!p&&r.length>0&&(p=r[0],g(0)),!p){w("لطفاً ابتدا یک تصویر آپلود کنید");return}if(!p.file){w("فایل انتخاب شده معتبر نیست. لطفاً دوباره فایل را آپلود کنید");return}if(!W||Q.length===0){w("لطفاً ابتدا یک مدل انتخاب کنید یا منتظر بمانید تا مدل‌ها بارگذاری شوند");return}_(!0),w(null),b(null);try{const P=St.site.serverUrl||Vt(""),A=new FormData;let{file:u}=p;if(console.log("[Facial Landmark] Preparing file for upload:",{fileToUse:p,file:u,isFile:u instanceof File,isBlob:u instanceof Blob,fileName:u==null?void 0:u.name,fileSize:u==null?void 0:u.size,fileType:u==null?void 0:u.type}),!(u instanceof File))if(u instanceof Blob){let s=p.name&&p.name.trim()!==""?p.name:"image.jpg";if(!s.includes(".")){const T=(h=u.type)!=null&&h.includes("png")?"png":((M=u.type)!=null&&M.includes("jpeg")||(S=u.type)!=null&&S.includes("jpg"),"jpg");s=`${s}.${T}`}const v=u.type||"image/jpeg";u=new File([u],s,{type:v}),console.log("[Facial Landmark] Converted Blob to File:",{fileName:s,fileType:v,size:u.size})}else throw console.error("[Facial Landmark] File is not a File or Blob:",u),new Error("فایل انتخاب شده معتبر نیست. لطفاً فایل را دوباره آپلود کنید");if(!u||u.size===0)throw console.error("[Facial Landmark] File is empty or invalid:",{file:u,size:u==null?void 0:u.size}),new Error("فایل انتخاب شده خالی است. لطفاً فایل را دوباره آپلود کنید");if(!u.name||u.name.trim()===""||!u.name.includes(".")){const s=(j=u.type)!=null&&j.includes("png")?"png":((x=u.type)!=null&&x.includes("jpeg")||(L=u.type)!=null&&L.includes("jpg"),"jpg"),v=p.name&&p.name.trim()!==""?`${p.name}.${s}`:`image.${s}`;u=new File([u],v,{type:u.type||"image/jpeg"}),console.log("[Facial Landmark] Fixed file name:",v)}if(A.append("file",u),console.log("[Facial Landmark Client] File prepared for upload:",{fileName:u.name,fileSize:u.size,fileType:u.type,isFile:u instanceof File,isBlob:u instanceof Blob,fileObject:{name:u.name,size:u.size,type:u.type,lastModified:u.lastModified}}),!u||u.size===0||!u.name||u.name.trim()==="")throw console.error("[Facial Landmark] File validation failed:",{file:u,size:u==null?void 0:u.size,name:u==null?void 0:u.name}),new Error("خطا در آماده‌سازی فایل برای ارسال: فایل خالی یا نام معتبر ندارد");console.log("[Facial Landmark] Sending request to backend:",{url:`${P}/api/ai/facial-landmark?model=${W}`,fileSize:u.size,fileName:u.name,fileType:u.type,model:W});const V=await fetch(`${P}/api/ai/facial-landmark?model=${W}`,{method:"POST",body:A});if(!V.ok){let s=`خطای HTTP: ${V.status}`;try{const v=await V.json();s=v.error||v.message||s}catch{try{const T=await V.text();T&&(s=T)}catch{}}throw new Error(s)}const F=await V.json();if(!F.success)throw new Error(F.error||F.message||"خطا در تشخیص");console.log("✅ [FacialLandmarkView] Detection successful:",{success:F.success,landmarksCount:((K=F.landmarks)==null?void 0:K.length)||0,totalLandmarks:F.total_landmarks,hasLandmarks:!!F.landmarks,landmarksType:typeof F.landmarks,sampleLandmark:(k=F.landmarks)==null?void 0:k[0]}),b(F);const m=F.landmarks||[];if(console.log("📊 [FacialLandmarkView] Setting landmarks:",{count:m.length,sample:m.slice(0,3)}),N(m),m.length>0)try{console.log("[Facial Beauty] Analyzing landmarks:",{count:m.length,sample:m.slice(0,5),firstLandmark:m[0],hasIndex:((O=m[0])==null?void 0:O.index)!==void 0,hasName:((z=m[0])==null?void 0:z.name)!==void 0});const s=_t(m);console.log("[Facial Beauty] Analysis result:",{success:s==null?void 0:s.success,overallScore:s==null?void 0:s.overallScore,hasSymmetry:!!(s!=null&&s.symmetry),hasGoldenRatio:!!(s!=null&&s.goldenRatio),hasEyes:!!(s!=null&&s.eyes),hasNose:!!(s!=null&&s.nose),hasMouth:!!(s!=null&&s.mouth)}),de(s)}catch(s){console.error("خطا در آنالیز زیبایی:",s),console.error("Error stack:",s.stack),de(null)}else console.warn("[Facial Beauty] No landmarks detected, skipping analysis"),de(null);e&&F&&(console.log("💾 [FacialLandmarkView] Saving analysis in background..."),ut(F).catch(s=>{console.error("❌ Background save failed:",s)}))}catch(P){console.error("خطا در تشخیص:",P);let A="خطا در ارتباط با سرور AI";const u=(P==null?void 0:P.message)||String(P||"");u.includes("fetch failed")||u.includes("Failed to fetch")||u.includes("NetworkError")?A="خطا در اتصال به سرور. لطفاً اطمینان حاصل کنید که backend server در حال اجراست.":u.includes("503")||u.includes("not available")?A="سرور AI در دسترس نیست. لطفاً اطمینان حاصل کنید که unified_ai_api_server.py روی پورت 5001 در حال اجراست.":u.includes("CORS")||u.includes("cors")?A="خطای CORS. لطفاً با مدیر سیستم تماس بگیرید.":u&&(A=u),w(A)}finally{_(!1)}};return n.jsx(It,{maxWidth:"xl",sx:{width:"100%",maxWidth:"100%",px:{xs:1,sm:2,md:3}},children:n.jsxs(q,{spacing:3,sx:{width:"100%"},children:[n.jsxs(q,{direction:{xs:"column",sm:"row"},alignItems:{xs:"flex-start",sm:"center"},spacing:2,children:[n.jsx(Le,{icon:"solar:face-smile-bold",width:40}),n.jsx(he,{children:n.jsx(H,{variant:"h6",sx:{fontSize:{xs:"1.25rem",sm:"1.25rem"}},children:"آنالیز صورت"})})]}),n.jsxs(Pt,{open:Qe,onClose:()=>!Pe&&Ie(!1),children:[n.jsx(Wt,{children:"حذف آنالیز لندمارک صورت"}),n.jsxs(zt,{children:[n.jsx(H,{children:"آیا از حذف این آنالیز مطمئن هستید؟ این عمل غیرقابل بازگشت است."}),Me&&n.jsxs(H,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["مدل: ",((te=(i=(C=Me.analysis)==null?void 0:C.analyses)==null?void 0:i[0])==null?void 0:te.modelId)||"نامشخص"]})]}),n.jsxs($t,{children:[n.jsx(xt,{onClick:()=>Ie(!1),color:"inherit",disabled:Pe,children:"انصراف"}),n.jsx(xt,{onClick:async()=>{var p,h,M,S,j;if(!(!Me||!e))try{dt(!0),console.log("🗑️ [FacialLandmarkView] Deleting analysis:",{index:Me.index,historyLength:ee.length,analysisId:(p=Me.analysis)==null?void 0:p.id});const x=ee.filter((L,K)=>K!==Me.index);console.log("📝 [FacialLandmarkView] New history after deletion:",{oldLength:ee.length,newLength:x.length,removedIndex:Me.index}),await We.put(`${ze.patients}/${e}`,{facialLandmarkAnalysis:x.length>0?JSON.stringify(x):null},{headers:{Authorization:`Bearer ${o==null?void 0:o.accessToken}`,"Content-Type":"application/json"}}),console.log("✅ [FacialLandmarkView] Analysis deleted from database"),le(x),await Ye(),console.log("✅ [FacialLandmarkView] History reloaded from server"),setTimeout(()=>{le(L=>(L.length>0?je(0):(je(null),fe(null),b(null),N([]),de(null)),L))},50),$e.success("آنالیز با موفقیت حذف شد"),Ie(!1),et(null)}catch(x){console.error("❌ [FacialLandmarkView] Error deleting analysis:",x);const L=((M=(h=x.response)==null?void 0:h.data)==null?void 0:M.error)||((j=(S=x.response)==null?void 0:S.data)==null?void 0:j.message)||x.message||"خطای نامشخص";$e.error(`خطا در حذف آنالیز: ${L}`)}finally{dt(!1)}},color:"error",variant:"contained",disabled:Pe,startIcon:Pe?n.jsx(Le,{icon:"eva:loader-fill"}):n.jsx(Le,{icon:"solar:trash-bin-trash-bold"}),children:Pe?"در حال حذف...":"حذف"})]})]}),n.jsxs(q,{direction:{xs:"column",lg:"row"},spacing:3,sx:{width:"100%"},children:[n.jsxs(q,{spacing:3,sx:{flex:1,minWidth:0,width:{xs:"100%",lg:"auto"},order:{xs:1,lg:1}},children:[Te&&n.jsx(Be,{children:n.jsx(qe,{children:n.jsxs(q,{spacing:2,children:[n.jsx(H,{variant:"h6",children:"🎨 نمایش لندمارک‌ها"}),D.length>0?n.jsx(Tt,{imageUrl:Te,landmarks:D,showLandmarks:!0,showOutlines:!1,showProfileLines:!1,showFrontalLines:!0,showLandmarkNames:!0,onImageLoadError:rt,retryFailedBlob:!0}):n.jsxs(he,{sx:{position:"relative"},children:[n.jsx(he,{component:"img",src:Te,alt:"Facial image",sx:{width:"100%",height:"auto",maxHeight:600,objectFit:"contain",borderRadius:1,border:"1px solid",borderColor:"divider"},onError:p=>{console.error("[Facial Landmark] Image load error:",p),rt({error:"Failed to load image",isBlobUrl:Te.startsWith("blob:")})}}),!y&&n.jsx(he,{sx:{p:2,textAlign:"center"},children:n.jsx(H,{variant:"body2",color:"text.secondary",children:'برای شناسایی لندمارک‌ها، دکمه "تشخیص لندمارک‌ها" را بزنید'})}),y&&D.length===0&&n.jsxs(he,{sx:{p:2,textAlign:"center"},children:[n.jsx(H,{variant:"body2",color:"text.secondary",children:"لندمارک‌ها شناسایی نشدند"}),n.jsxs(H,{variant:"caption",color:"text.secondary",sx:{mt:1,display:"block"},children:["تعداد لندمارک‌های شناسایی شده: ",y.total_landmarks||0]})]})]})]})})}),y&&n.jsxs(n.Fragment,{children:[J&&J.success&&n.jsx(Be,{children:n.jsx(qe,{children:n.jsxs(q,{spacing:2,children:[n.jsxs(q,{direction:"row",alignItems:"center",spacing:1,children:[n.jsx(Le,{icon:"solar:star-bold",width:24,sx:{color:"primary.main"}}),n.jsx(H,{variant:"h6",children:"آنالیز زیبایی صورت"})]}),n.jsxs(he,{children:[n.jsx(H,{variant:"subtitle2",sx:{mb:1},children:"امتیاز کلی زیبایی"}),n.jsxs(q,{direction:"row",alignItems:"center",spacing:2,children:[n.jsx(he,{sx:{flex:1},children:n.jsx(At,{variant:"determinate",value:J.overallScore||0,sx:{height:8,borderRadius:4,bgcolor:"grey.200","& .MuiLinearProgress-bar":{bgcolor:"primary.main",borderRadius:4}}})}),n.jsxs(H,{variant:"h6",sx:{minWidth:50,textAlign:"right"},children:[((G=J.overallScore)==null?void 0:G.toFixed(1))||0,"%"]})]})]}),J.symmetry&&n.jsxs(he,{children:[n.jsx(H,{variant:"subtitle2",sx:{mb:1},children:"تقارن صورت"}),n.jsxs(q,{spacing:1,children:[n.jsxs(q,{direction:"row",justifyContent:"space-between",children:[n.jsx(H,{variant:"body2",children:"تقارن کلی:"}),n.jsxs(H,{variant:"body2",sx:{fontWeight:600},children:[J.symmetry.overall.toFixed(1),"%"]})]}),n.jsxs(q,{direction:"row",justifyContent:"space-between",children:[n.jsx(H,{variant:"body2",children:"تقارن چشم‌ها:"}),n.jsxs(H,{variant:"body2",sx:{fontWeight:600},children:[J.symmetry.eyes.toFixed(1),"%"]})]}),n.jsxs(q,{direction:"row",justifyContent:"space-between",children:[n.jsx(H,{variant:"body2",children:"تقارن دهان:"}),n.jsxs(H,{variant:"body2",sx:{fontWeight:600},children:[J.symmetry.mouth.toFixed(1),"%"]})]})]})]}),J.goldenRatio&&Object.keys(J.goldenRatio).length>0&&n.jsxs(he,{children:[n.jsx(H,{variant:"subtitle2",sx:{mb:1},children:"نسبت طلایی (1:1.618)"}),n.jsxs(q,{spacing:1,children:[J.goldenRatio.verticalRatio&&n.jsxs(q,{direction:"row",justifyContent:"space-between",children:[n.jsx(H,{variant:"body2",children:"نسبت عمودی:"}),n.jsxs(H,{variant:"body2",sx:{fontWeight:600},children:[J.goldenRatio.verticalRatio.ratio," (",J.goldenRatio.verticalRatio.score,"%)"]})]}),J.goldenRatio.horizontalRatio&&n.jsxs(q,{direction:"row",justifyContent:"space-between",children:[n.jsx(H,{variant:"body2",children:"نسبت افقی:"}),n.jsxs(H,{variant:"body2",sx:{fontWeight:600},children:[J.goldenRatio.horizontalRatio.ratio," (",J.goldenRatio.horizontalRatio.score,"%)"]})]}),J.goldenRatio.eyeToNoseRatio&&n.jsxs(q,{direction:"row",justifyContent:"space-between",children:[n.jsx(H,{variant:"body2",children:"نسبت چشم به بینی:"}),n.jsxs(H,{variant:"body2",sx:{fontWeight:600},children:[J.goldenRatio.eyeToNoseRatio.ratio," (",J.goldenRatio.eyeToNoseRatio.score,"%)"]})]})]})]})]})})}),J&&J.success&&n.jsxs(he,{sx:{width:"100%"},children:[n.jsx(H,{variant:"h6",sx:{mb:2,color:"primary.main"},children:"جدول آنالیز زیبایی صورت"}),(()=>{const p=Li.filter(M=>M.getValue(J)),h=p.slice(tt*Xe,tt*Xe+Xe);return n.jsxs(n.Fragment,{children:[n.jsx(Bt,{component:Dt,sx:{maxHeight:600,overflowX:"auto",overflowY:"auto",borderRadius:"16px","& .MuiTable-root":{minWidth:800}},children:n.jsxs(Ot,{stickyHeader:!0,size:"small",children:[n.jsx(Ht,{children:n.jsxs(Lt,{children:[n.jsx(be,{sx:{fontWeight:"bold",whiteSpace:"nowrap",width:"8%",px:1.5,py:1},children:"دسته‌بندی"}),n.jsx(be,{sx:{fontWeight:"bold",width:"15%",px:1.5,py:1},children:"پارامتر"}),n.jsx(be,{sx:{fontWeight:"bold",whiteSpace:"nowrap",width:"10%",px:1.5,py:1},children:"مقدار فعلی"}),n.jsx(be,{sx:{fontWeight:"bold",whiteSpace:"nowrap",width:"12%",px:1.5,py:1},children:"مقدار ایده‌آل"}),n.jsx(be,{sx:{fontWeight:"bold",whiteSpace:"nowrap",width:"10%",px:1.5,py:1},children:"وضعیت"}),n.jsx(be,{sx:{fontWeight:"bold",width:"45%",px:1.5,py:1},children:"توضیحات"})]})}),n.jsx(Gt,{children:h.map((M,S)=>{var O,z;const j=M.getValue(J),x=(O=M.getScore)==null?void 0:O.call(M,J),L=(z=M.getGrade)==null?void 0:z.call(M,J);let K="نامشخص",k="default";return L&&(L>=90?(K="عالی",k="success"):L>=70?(K="خوب",k="info"):L>=50?(K="متوسط",k="warning"):(K="نیاز به بهبود",k="error")),n.jsxs(Lt,{hover:!0,children:[n.jsx(be,{sx:{whiteSpace:"nowrap",px:1.5,py:.75,width:"8%"},children:M.category}),n.jsx(be,{sx:{px:1.5,py:.75,width:"15%"},children:M.parameter}),n.jsxs(be,{sx:{fontFamily:"monospace",whiteSpace:"nowrap",px:1.5,py:.75,width:"10%"},children:[j,x&&` (${x}%)`]}),n.jsx(be,{sx:{fontFamily:"monospace",color:"text.secondary",whiteSpace:"nowrap",px:1.5,py:.75,width:"12%"},children:M.idealValue}),n.jsx(be,{sx:{whiteSpace:"nowrap",px:1.5,py:.75,width:"10%"},children:n.jsx(Ut,{label:K,size:"small",color:k,sx:{height:20,fontSize:"0.7rem"}})}),n.jsx(be,{sx:{fontSize:"0.85rem",color:"text.secondary",px:1.5,py:.75,width:"45%"},children:M.description})]},S)})})]})}),n.jsx(Xt,{component:"div",count:p.length,page:tt,rowsPerPage:Xe,onPageChange:(M,S)=>Ue(S),rowsPerPageOptions:[5],onRowsPerPageChange:M=>{Se(parseInt(M.target.value,10)),Ue(0)},labelRowsPerPage:"تعداد سطر در هر صفحه:",labelDisplayedRows:({from:M,to:S,count:j})=>`${M}-${S} از ${j}`})]})})()]})]}),!y&&!l&&n.jsx(Be,{children:n.jsx(qe,{children:n.jsx(H,{variant:"body2",sx:{color:"text.secondary",textAlign:"center",py:4},children:"لطفاً یک تصویر صورت آپلود کرده و دکمه تشخیص را بزنید."})})})]}),n.jsxs(q,{spacing:3,sx:{width:{xs:"100%",lg:"400px"},flexShrink:0,order:{xs:2,lg:2}},children:[e&&n.jsx(Be,{sx:{order:{xs:1,lg:1}},children:n.jsx(qe,{children:n.jsxs(q,{spacing:2,children:[n.jsx(H,{variant:"h6",children:"📋 تاریخچه آنالیز"}),n.jsxs(q,{direction:"row",spacing:1,alignItems:"flex-start",children:[n.jsxs(wt,{fullWidth:!0,size:"small",children:[n.jsx(vt,{children:"انتخاب آنالیز از تاریخچه"}),n.jsx(Ft,{value:ie!==null?ie:"",onChange:p=>je(p.target.value!==""?Number(p.target.value):null),label:"انتخاب آنالیز از تاریخچه",disabled:ee.length===0,children:ee.length>0?ee.map((p,h)=>{var M,S;return n.jsx(lt,{value:h,children:n.jsxs(he,{sx:{width:"100%"},children:[n.jsxs(H,{variant:"body2",children:["آنالیز ",h+1," - ",((S=(M=p.analyses)==null?void 0:M[0])==null?void 0:S.modelId)||"مدل نامشخص"]}),n.jsx(H,{variant:"caption",color:"text.secondary",children:p.timestamp?new Date(p.timestamp).toLocaleDateString("fa-IR",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"}):"تاریخ نامشخص"})]})},h)}):n.jsx(lt,{value:"",disabled:!0,children:n.jsx(H,{variant:"body2",color:"text.secondary",children:"هیچ آنالیز ذخیره شده‌ای وجود ندارد"})})})]}),ie!==null&&ee.length>0&&n.jsx(Ce,{color:"error",size:"small",onClick:()=>{const p=ee[ie];p&&(et({index:ie,analysis:p}),Ie(!0))},sx:{mt:1.5},children:n.jsx(Le,{icon:"solar:trash-bin-trash-bold",width:20})})]})]})})}),n.jsx(Be,{sx:{order:{xs:3,lg:2}},children:n.jsx(qe,{children:n.jsxs(q,{spacing:2,children:[n.jsx(H,{variant:"h6",children:"📷 آپلود تصویر صورت"}),n.jsx(Nt,{multiple:!0,onDrop:it,accept:{"image/*":[".jpg",".jpeg",".png"]}}),n.jsxs(wt,{fullWidth:!0,size:"small",children:[n.jsx(vt,{children:"انتخاب مدل"}),n.jsx(Ft,{value:W||"",label:"انتخاب مدل",onChange:p=>X(p.target.value),disabled:Q.length===0,children:Q.length===0?n.jsx(lt,{value:"",disabled:!0,children:"در حال بارگذاری مدل‌ها..."}):Q.map(p=>n.jsxs(lt,{value:p,children:[p==="mediapipe"&&"MediaPipe (468 points - سریع)",p==="dlib"&&"dlib (68 points - کلاسیک)",p==="face_alignment"&&"face-alignment (68 points - دقیق)",p==="retinaface"&&"RetinaFace (5 points - کلیدی)",p==="lab"&&"LAB - Look at Boundary (68 points - دقت بالا)",p==="3ddfa"&&"3DDFA - 3D Dense Face Alignment (68 points - 3D)",!["mediapipe","dlib","face_alignment","retinaface","lab","3ddfa"].includes(p)&&p]},p))})]}),r.length>0&&n.jsxs(he,{children:[n.jsxs(H,{variant:"subtitle2",sx:{mb:1},children:["فایل‌های آپلود شده (",r.length,")"]}),n.jsx(q,{spacing:1,children:r.map((p,h)=>{const M=p.name.length>20?`${p.name.substring(0,20)}...`:p.name;return n.jsx(Be,{sx:{p:1.5,border:1,borderColor:"divider",bgcolor:"background.paper",marginTop:"0 !important"},children:n.jsxs(q,{direction:"row",spacing:1,alignItems:"center",children:[n.jsx(he,{component:"img",src:p.preview,alt:p.name,sx:{width:36,height:36,objectFit:"cover",borderRadius:1}}),n.jsxs(he,{sx:{flex:1,minWidth:0},children:[n.jsx(H,{variant:"body2",noWrap:!0,children:M}),n.jsxs(H,{variant:"caption",color:"text.secondary",children:[(p.size/1024).toFixed(1)," KB"]})]}),n.jsx(Ce,{onClick:S=>{S.stopPropagation(),nt(h)},sx:{width:26,height:26,p:0},children:n.jsx(Le,{icon:"mingcute:close-line",width:16})})]})},p.id)})})]}),n.jsx(xt,{fullWidth:!0,size:"medium",variant:"contained",color:"primary",onClick:gt,disabled:r.length===0||l||!W||Q.length===0,startIcon:l?n.jsx(kt,{size:16,sx:{color:"inherit"}}):n.jsx(Le,{icon:"solar:face-recognition-bold",width:20}),sx:{transition:"all 0.1s ease-in-out !important","&:active":{transform:"scale(0.98)"}},children:l?"در حال پردازش":"تشخیص لندمارک‌ها"}),R&&n.jsx(Et,{severity:"error",children:R})]})})})]})]})]})})}const vi={title:`تشخیص لندمارک‌های صورت | ${St.site.name}`};function Yi(){return n.jsxs(n.Fragment,{children:[n.jsx(Ct,{children:n.jsx("title",{children:vi.title})}),n.jsx(wi,{})]})}export{Yi as default};
