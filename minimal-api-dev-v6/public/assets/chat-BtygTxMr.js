import{r as c,dy as he,fw as Re,dh as X,j as e,B as D,S as u,aV as xe,a_ as Ae,aA as q,I as y,c as Z,h as K,p as U,dp as _,aB as N,aK as G,T as I,ee,i as J,b9 as ue,dl as me,cV as Ne,o as k,ar as pe,bb as ge,bc as V,bt as Te,be as fe,b as je,n as Pe,dq as se,az as be,cI as ye,v as E,k as te,d2 as oe,ef as De,aE as Oe,f1 as $e,fx as Ee,C as ne,fy as Le,cg as Fe,d as Y,dA as W,di as ve,d_ as Me,e5 as We,H as ze}from"./index-BH9ijvcg.js";import{u as H}from"./use-mocked-user-D68DwM9Y.js";import{u as Ce,m as Q}from"./index-BUoyIWvZ.js";import{E as Be}from"./empty-content-CTwJtcn7.js";import{g as T}from"./avatar-url-votlVkc-.js";import{A as we}from"./AvatarGroup-Y5-La42-.js";import{S as A}from"./Skeleton-Mn58_7nY.js";import{T as re}from"./TextField-DgF_8CdY.js";import{C as Ve}from"./ClickAwayListener-Baho8cKO.js";import{D as ke}from"./DialogContent-CtzR1nPJ.js";import{F as Ge}from"./file-thumbnail-GgYbZAeX.js";import{u as He,L as _e}from"./use-light-box-C_gaQz76.js";import{u as le}from"./uuidv4-B4SGT1yQ.js";import{C as Ue}from"./confirm-dialog-U4gI9R8N.js";import{D as qe}from"./DialogTitle-BFho6EhL.js";import{R as Ke,a as Je}from"./RadioGroup-7Oa-Pyj3.js";import{F as Ye}from"./FormControlLabel-CVzZoZzb.js";import{D as Qe}from"./dialogTitleClasses-CSmkbKpM.js";import{A as Xe}from"./Autocomplete-Crt2raTS.js";import{C as Ze}from"./Chip-CWilL4Fh.js";import"./Select-fMsy-Lkz.js";import"./Menu-C7S9TApF.js";import"./InputLabel-OzeQogzC.js";import"./FormLabel-Cn8enUsF.js";import"./FormHelperText-CAGzEAMm.js";import"./FormControl-rHOkSiGz.js";import"./FormGroup-BEVR9nif.js";const z={doctors:"/api/chat/doctors",list:"/api/chat/list",conversation:s=>`/api/chat/${s}`,send:"/api/chat/send"},Se={revalidateIfStale:!0,revalidateOnFocus:!0,revalidateOnReconnect:!0};function es(){const{conversations:s,conversationsLoading:n,conversationsError:i,conversationsValidating:t}=Ie();return c.useMemo(()=>{const l=new Set,a=[];return s!=null&&s.byId&&Object.values(s.byId).forEach(o=>{o.otherParticipant&&!l.has(o.otherParticipant.id)&&(l.add(o.otherParticipant.id),a.push({id:o.otherParticipant.id,name:o.otherParticipant.name,firstName:o.otherParticipant.firstName,lastName:o.otherParticipant.lastName,email:o.otherParticipant.email,specialty:o.otherParticipant.specialty,phone:o.otherParticipant.phone,isVerified:o.otherParticipant.isVerified,lastActivity:new Date(o.updatedAt).toISOString().split("T")[0],avatarUrl:o.otherParticipant.avatarUrl||null,status:"offline"}))}),{contacts:a,contactsLoading:n,contactsError:i,contactsValidating:t,contactsEmpty:!n&&!a.length}},[s,n,i,t])}function Ie(){const s=z.list,{data:n,isLoading:i,error:t,isValidating:r}=Ce(s,he,Se);return c.useMemo(()=>{const a=(n==null?void 0:n.chats)||[],o=a.length?Re(a,"id"):{},d=Object.keys(o);return{conversations:{byId:o,allIds:d},conversationsLoading:i,conversationsError:t,conversationsValidating:r,conversationsEmpty:!i&&!d.length}},[n==null?void 0:n.chats,t,i,r])}function ss(s){const n=s?z.conversation(s):null,{data:i,isLoading:t,error:r,isValidating:l}=Ce(n,he,Se);return c.useMemo(()=>({conversation:i==null?void 0:i.chat,conversationLoading:t,conversationError:r,conversationValidating:l}),[i==null?void 0:i.chat,r,t,l])}async function ts(s,n){var a,o;const i={recipientId:n.recipientId||null,content:n.content},t=await X.post(z.send,i),r=(a=t.data)==null?void 0:a.message,l=(o=t.data)==null?void 0:o.chatId;return l&&(Q(z.conversation(l)),Q(z.list)),{message:r,chatId:l}}async function os(s){Q(z.list)}function ns({slots:s,sx:n,...i}){const t=e.jsx(D,{display:"flex",flexDirection:"column",children:s.nav}),r=e.jsx(u,{direction:"row",alignItems:"center",sx:{py:1,pr:1,pl:2.5,height:72,flexShrink:0,borderBottom:a=>`solid 1px ${a.vars.palette.divider}`},children:s.header}),l=e.jsx(u,{sx:{flex:"1 1 auto",minWidth:0},children:s.main});return e.jsxs(u,{direction:"row",sx:n,...i,children:[t,e.jsxs(u,{sx:{flex:"1 1 auto",minWidth:0},children:[r,e.jsx(u,{direction:"row",sx:{flex:"1 1 auto",minHeight:0},children:l})]})]})}const ae=xe(({selected:s,children:n,disabled:i,...t})=>e.jsxs(q,{disabled:i,...t,children:[n,e.jsx(y,{width:16,icon:(!s||i)&&"eva:arrow-ios-forward-fill"||"eva:arrow-ios-downward-fill"})]}))(({theme:s})=>({...s.typography.overline,height:40,paddingLeft:s.spacing(2.5),justifyContent:"space-between",paddingRight:s.spacing(1.5),color:s.vars.palette.text.secondary,backgroundColor:s.vars.palette.background.neutral})),rs=xe(Ae)(({theme:s})=>({top:84,left:0,zIndex:9,width:32,height:32,position:"absolute",borderRadius:"0 12px 12px 0",boxShadow:s.customShadows.primary,color:s.vars.palette.primary.contrastText,backgroundColor:s.vars.palette.primary.main,transition:s.transitions.create(["all"],{duration:s.transitions.duration.shorter}),"&:hover":{backgroundColor:s.vars.palette.primary.darker}}));function as({currentUserId:s,conversation:n}){const i=n&&n.messages||(n&&n.lastMessage?[n.lastMessage]:[])||[],t=n&&n.participants;let r=[];Array.isArray(t)&&t.length?typeof t[0]=="object"?r=t.filter(x=>String(x.id)!==String(s)):n.otherParticipant?r=[n.otherParticipant]:r=[]:n&&n.otherParticipant?r=[n.otherParticipant]:r=[];const l=i.length?i[i.length-1]:null,a=r.length>1,o=r.map(x=>x.name||`${x.firstName||""} ${x.lastName||""}`.trim()).filter(Boolean).join(", "),d=a?r.some(x=>(x.status||"").toLowerCase()==="online"):!1;let f="";if(l){const x=String(l.senderId)===String(s)?"You: ":"",g=l.content??l.body??"",h=l.contentType&&l.contentType==="image"||!!l.attachments&&l.attachments.length>0&&!g?"Sent a photo":g;f=`${x}${h}`}return{group:a,displayName:o,displayText:f,participants:r,lastActivity:l?l.createdAt:null,hasOnlineInGroup:d}}function is({selected:s,collapse:n,conversation:i,onCloseMobile:t}){const{user:r}=H(),l=Z("up","md"),a=K(),{group:o,displayName:d,displayText:f,participants:x,lastActivity:g,hasOnlineInGroup:v}=as({conversation:i,currentUserId:`${r==null?void 0:r.id}`}),h=x&&x[0]||{},{name:b="Unknown",avatarUrl:j="",status:C="offline"}=h,R=c.useCallback(async()=>{try{l||t(),await os(i.id),a.push(`${U.dashboard.chat}?id=${i.id}`)}catch(P){console.error(P)}},[i.id,l,t,a]),L=e.jsx(_,{variant:v?"online":"invisible",anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(we,{variant:"compact",sx:{width:48,height:48},children:x.slice(0,2).map(P=>e.jsx(N,{alt:P.name,src:T(P.avatarUrl)},P.id))})}),$=e.jsx(_,{variant:C,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(N,{alt:b,src:T(j),sx:{width:48,height:48}})},C);return e.jsx(D,{component:"li",sx:{display:"flex"},children:e.jsxs(q,{onClick:R,sx:{py:1.5,px:2.5,gap:2,...s&&{bgcolor:"action.selected"}},children:[e.jsx(_,{color:"error",overlap:"circular",badgeContent:n?i.unreadCount:0,children:o?L:$}),!n&&e.jsxs(e.Fragment,{children:[e.jsx(G,{primary:d,primaryTypographyProps:{noWrap:!0,component:"span",variant:"subtitle2"},secondary:f,secondaryTypographyProps:{noWrap:!0,component:"span",variant:i.unreadCount?"subtitle2":"body2",color:i.unreadCount?"text.primary":"text.secondary"}}),e.jsxs(u,{alignItems:"flex-end",sx:{alignSelf:"stretch"},children:[e.jsx(I,{noWrap:!0,variant:"body2",component:"span",sx:{mb:1.5,fontSize:12,color:"text.disabled"},children:ee(g)}),!!i.unreadCount&&e.jsx(D,{sx:{width:8,height:8,bgcolor:"info.main",borderRadius:"50%"}})]})]})]})})}function ls(){var l;const{user:s}=H(),{user:n}=J();K();const i=ue(),t=n||s,r=c.useCallback(()=>{i.onClose()},[i]);return e.jsxs(e.Fragment,{children:[e.jsx(N,{src:T((t==null?void 0:t.photoURL)||(t==null?void 0:t.avatarUrl)),alt:t==null?void 0:t.displayName,onClick:i.onOpen,sx:{cursor:"pointer",width:48,height:48},children:(l=t==null?void 0:t.displayName)==null?void 0:l.charAt(0).toUpperCase()}),e.jsxs(me,{open:i.open,anchorEl:i.anchorEl,onClose:i.onClose,slotProps:{paper:{sx:{p:0}},arrow:{placement:"top-left"}},children:[e.jsxs(u,{direction:"row",alignItems:"center",spacing:2,sx:{py:2,pr:1,pl:2},children:[e.jsx(G,{primary:(t==null?void 0:t.displayName)||`${(t==null?void 0:t.firstName)||""} ${(t==null?void 0:t.lastName)||""}`.trim(),secondary:t==null?void 0:t.email,secondaryTypographyProps:{component:"span"}}),e.jsx(Ne,{title:"خروج",children:e.jsx(k,{color:"error",children:e.jsx(y,{icon:"ic:round-power-settings-new"})})})]}),e.jsx(pe,{sx:{borderStyle:"dashed"}}),e.jsxs(ge,{sx:{my:.5,px:.5},children:[e.jsxs(V,{onClick:r,children:[e.jsx(y,{icon:"solar:user-id-bold",width:24}),"پروفایل"]}),e.jsxs(V,{children:[e.jsx(y,{icon:"eva:settings-2-fill",width:24}),"تنظیمات"]})]})]})]})}function cs({sx:s,amount:n=6,...i}){return[...Array(n)].map((t,r)=>e.jsxs(u,{spacing:2,direction:"row",alignItems:"center",sx:{px:2.5,py:1.5,...s},...i,children:[e.jsx(A,{variant:"circular",sx:{width:48,height:48}}),e.jsxs(u,{spacing:1,flexGrow:1,children:[e.jsx(A,{sx:{width:.75,height:10}}),e.jsx(A,{sx:{width:.5,height:10}})]})]},r))}function ds({sx:s,...n}){return e.jsxs(u,{direction:"row",alignItems:"center",sx:{width:1,...s},...n,children:[e.jsx(A,{variant:"circular",sx:{width:40,height:40}}),e.jsxs(u,{spacing:1,flexGrow:1,sx:{mx:2},children:[e.jsx(A,{sx:{width:96,height:10}}),e.jsx(A,{sx:{width:40,height:10}})]}),e.jsx(A,{variant:"circular",sx:{width:28,height:28}}),e.jsx(A,{variant:"circular",sx:{width:28,height:28,mx:1}}),e.jsx(A,{variant:"circular",sx:{width:28,height:28,mr:1}})]})}function hs({sx:s,...n}){return e.jsx(u,{flexGrow:1,sx:{pt:5,...s},...n,children:e.jsxs(u,{alignItems:"center",children:[e.jsx(A,{variant:"circular",sx:{width:96,height:96}}),e.jsx(A,{sx:{mb:1,mt:2,height:10,width:.65}}),e.jsx(A,{sx:{width:.35,height:10,mb:5}}),e.jsx(Te,{color:"inherit",thickness:2})]})})}function xs({query:s,results:n,onClickResult:i}){const t=n.length,r=!t&&!!s,l=e.jsx(fe,{query:s,sx:{p:3,mx:"auto",width:"calc(100% - 40px)",bgcolor:"background.neutral"}}),a=e.jsx("nav",{children:e.jsx(D,{component:"ul",children:n.map(o=>e.jsx(D,{component:"li",sx:{display:"flex"},children:e.jsxs(q,{onClick:()=>i(o),sx:{gap:2,py:1.5,px:2.5,typography:"subtitle2"},children:[e.jsx(N,{alt:o.name,src:T(o.avatarUrl)}),o.name]})},o.id))})});return e.jsxs(e.Fragment,{children:[e.jsxs(I,{variant:"h6",sx:{px:2.5,mb:2},children:["مخاطبین (",t,")"]}),r?l:a]})}const ce=320,us=96;function ms({loading:s,contacts:n,conversations:i,collapseNav:t,selectedConversationId:r}){const l=je(),a=K(),o=Z("up","md"),{openMobile:d,onOpenMobile:f,onCloseMobile:x,onCloseDesktop:g,collapseDesktop:v,onCollapseDesktop:h}=t,[b,j]=c.useState({query:"",results:[]});c.useEffect(()=>{o||g()},[g,o]);const C=c.useCallback(()=>{o?h():x()},[o,x,h]),R=c.useCallback(()=>{o||x(),a.push(U.dashboard.chat)},[o,x,a]),L=c.useCallback(w=>{if(j(F=>({...F,query:w})),w){const F=n.filter(B=>B.name.toLowerCase().includes(w));j(B=>({...B,results:F}))}},[n]),$=c.useCallback(()=>{j({query:"",results:[]})},[]),P=c.useCallback(w=>{$(),a.push(`${U.dashboard.chat}?id=${w.id}`)},[$,a]),M=e.jsx(cs,{}),m=e.jsx("nav",{children:e.jsx(D,{component:"ul",children:i.allIds.map(w=>e.jsx(is,{collapse:v,conversation:i.byId[w],selected:w===r,onCloseMobile:x},w))})}),p=e.jsx(xs,{query:b.query,results:b.results,onClickResult:P}),S=e.jsx(Ve,{onClickAway:$,children:e.jsx(re,{fullWidth:!0,value:b.query,onChange:w=>L(w.target.value),placeholder:"جستجوی مخاطبین...",InputProps:{startAdornment:e.jsx(Pe,{position:"start",children:e.jsx(y,{icon:"eva:search-fill",sx:{color:"text.disabled"}})})},sx:{mt:2.5}})}),O=e.jsxs(e.Fragment,{children:[e.jsxs(u,{direction:"row",alignItems:"center",justifyContent:"center",sx:{p:2.5,pb:0},children:[!v&&e.jsxs(e.Fragment,{children:[e.jsx(ls,{}),e.jsx(D,{sx:{flexGrow:1}})]}),e.jsx(k,{onClick:C,children:e.jsx(y,{icon:v?"eva:arrow-ios-forward-fill":"eva:arrow-ios-back-fill"})}),!v&&e.jsx(k,{onClick:R,children:e.jsx(y,{width:24,icon:"solar:user-plus-bold"})})]}),e.jsx(D,{sx:{p:2.5,pt:0},children:!v&&S}),s?M:e.jsx(se,{sx:{pb:1},children:b.query&&i.allIds.length?p:m})]});return e.jsxs(e.Fragment,{children:[e.jsx(rs,{onClick:f,sx:{display:{md:"none"}},children:e.jsx(y,{width:16,icon:"solar:users-group-rounded-bold"})}),e.jsx(u,{sx:{minHeight:0,flex:"1 1 auto",width:ce,display:{xs:"none",md:"flex"},borderRight:`solid 1px ${l.vars.palette.divider}`,transition:l.transitions.create(["width"],{duration:l.transitions.duration.shorter}),...v&&{width:us}},children:O}),e.jsx(be,{open:d,onClose:x,slotProps:{backdrop:{invisible:!0}},PaperProps:{sx:{width:ce}},children:O})]})}function ps({participant:s,open:n,onClose:i}){return e.jsxs(ye,{fullWidth:!0,maxWidth:"xs",open:n,onClose:i,children:[e.jsx(k,{onClick:i,sx:{position:"absolute",right:8,top:8},children:e.jsx(y,{icon:"mingcute:close-line"})}),e.jsxs(ke,{sx:{py:5,px:3,display:"flex"},children:[e.jsx(N,{alt:s.name,src:T(s.avatarUrl),sx:{width:96,height:96,mr:3}}),e.jsxs(u,{spacing:1,children:[e.jsx(I,{variant:"caption",sx:{color:"primary.main"},children:s.role}),e.jsx(I,{variant:"subtitle1",children:s.name}),e.jsxs(u,{direction:"row",sx:{typography:"caption",color:"text.disabled"},children:[e.jsx(y,{icon:"mingcute:location-fill",width:16,sx:{flexShrink:0,mr:.5,mt:"2px"}}),s.address]}),e.jsxs(u,{spacing:1,direction:"row",sx:{pt:1.5},children:[e.jsx(k,{size:"small",color:"error",sx:{borderRadius:1,bgcolor:t=>E(t.vars.palette.error.mainChannel,.08),"&:hover":{bgcolor:t=>E(t.vars.palette.error.mainChannel,.16)}},children:e.jsx(y,{width:18,icon:"solar:phone-bold"})}),e.jsx(k,{size:"small",color:"info",sx:{borderRadius:1,bgcolor:t=>E(t.vars.palette.info.mainChannel,.08),"&:hover":{bgcolor:t=>E(t.vars.palette.info.mainChannel,.16)}},children:e.jsx(y,{width:18,icon:"solar:chat-round-dots-bold"})}),e.jsx(k,{size:"small",color:"primary",sx:{borderRadius:1,bgcolor:t=>E(t.vars.palette.primary.mainChannel,.08),"&:hover":{bgcolor:t=>E(t.vars.palette.primary.mainChannel,.16)}},children:e.jsx(y,{width:18,icon:"fluent:mail-24-filled"})}),e.jsx(k,{size:"small",color:"secondary",sx:{borderRadius:1,bgcolor:t=>E(t.vars.palette.secondary.mainChannel,.08),"&:hover":{bgcolor:t=>E(t.vars.palette.secondary.mainChannel,.16)}},children:e.jsx(y,{width:18,icon:"solar:videocamera-record-bold"})})]})]})]})]})}function gs({participants:s}){const n=te(!0),[i,t]=c.useState(null),r=c.useCallback(d=>{t(d)},[]),l=c.useCallback(()=>{t(null)},[]),a=s.length,o=e.jsx(e.Fragment,{children:s.map(d=>e.jsxs(q,{onClick:()=>r(d),children:[e.jsx(_,{variant:d.status,anchorOrigin:{vertical:"bottom",horizontal:"right"},children:e.jsx(N,{alt:d.name,src:T(d.avatarUrl)})}),e.jsx(G,{sx:{ml:2},primary:d.name,secondary:d.role,primaryTypographyProps:{noWrap:!0,typography:"subtitle2"},secondaryTypographyProps:{noWrap:!0,component:"span",typography:"caption"}})]},d.id))});return e.jsxs(e.Fragment,{children:[e.jsx(ae,{selected:n.value,disabled:!a,onClick:n.onToggle,children:`در اتاق (${a})`}),e.jsx(oe,{in:n.value,children:o}),i&&e.jsx(ps,{participant:i,open:!!i,onClose:l})]})}function fs({participant:s}){const n=te(!0),i=e.jsxs(u,{alignItems:"center",sx:{py:5},children:[e.jsx(N,{alt:s==null?void 0:s.name,src:T(s==null?void 0:s.avatarUrl),sx:{width:96,height:96,mb:2}}),e.jsx(I,{variant:"subtitle1",children:s==null?void 0:s.name}),e.jsx(I,{variant:"body2",sx:{color:"text.secondary",mt:.5},children:(()=>{const r=((s==null?void 0:s.role)||"").toUpperCase();return r==="DOCTOR"?"دکتر":r==="ADMIN"?"ادمین":r==="PATIENT"?"بیمار":(s==null?void 0:s.role)||""})()})]}),t=e.jsx(u,{spacing:2,sx:{px:2,py:2.5},children:[{icon:"solar:phone-bold",label:"شماره تلفن",value:(s==null?void 0:s.phone)||(s==null?void 0:s.phoneNumber)},{icon:"fluent:mail-24-filled",label:"ایمیل",value:s==null?void 0:s.email},{icon:"solar:user-id-bold",label:"تخصص",value:s==null?void 0:s.specialty}].filter(r=>r.value).map(r=>e.jsxs(u,{spacing:1,direction:"row",sx:{typography:"body2",wordBreak:"break-all"},children:[e.jsx(y,{icon:r.icon,sx:{flexShrink:0,color:"text.disabled"}}),e.jsxs(I,{variant:"body2",sx:{color:"text.secondary"},children:[r.label,": ",r.value]})]},r.icon))});return e.jsxs(e.Fragment,{children:[i,e.jsx(ae,{selected:n.value,onClick:n.onToggle,children:"اطلاعات"}),e.jsx(oe,{in:n.value,children:t})]})}function js({attachments:s}){const n=te(!0),i=s.length,t=s.filter(r=>r&&r.name).map((r,l)=>e.jsxs(u,{spacing:1.5,direction:"row",alignItems:"center",children:[e.jsx(Ge,{imageView:!0,file:r.preview||r.url||r.path||r,onDownload:()=>console.info("DOWNLOAD"),slotProps:{icon:{width:24,height:24}},sx:{width:40,height:40,bgcolor:"background.neutral"}}),e.jsx(G,{primary:r.name||"پیوست بدون نام",secondary:r.createdAt?De(r.createdAt):"",primaryTypographyProps:{noWrap:!0,typography:"body2"},secondaryTypographyProps:{mt:.25,noWrap:!0,component:"span",typography:"caption",color:"text.disabled"}})]},r.name+l));return e.jsxs(e.Fragment,{children:[e.jsx(ae,{selected:n.value,disabled:!i,onClick:n.onToggle,children:`پیوست‌ها (${i})`}),!!i&&e.jsx(oe,{in:n.value,children:e.jsx(u,{spacing:2,sx:{p:2},children:t})})]})}const bs=280,ys=320;function vs({collapseNav:s,participants:n,messages:i,loading:t}){const r=je(),{collapseDesktop:l,openMobile:a,onCloseMobile:o}=s,d=n.length>1,f=i.map(g=>g.attachments).flat(1)||[],x=t?e.jsx(hs,{}):e.jsx(se,{children:e.jsxs("div",{children:[d?e.jsx(gs,{participants:n}):e.jsx(fs,{participant:n[0]}),e.jsx(js,{attachments:f})]})});return e.jsxs(e.Fragment,{children:[e.jsx(u,{sx:{minHeight:0,flex:"1 1 auto",width:bs,display:{xs:"none",lg:"flex"},borderLeft:`solid 1px ${r.vars.palette.divider}`,transition:r.transitions.create(["width"],{duration:r.transitions.duration.shorter}),...l&&{width:0}},children:!l&&x}),e.jsx(be,{anchor:"right",open:a,onClose:o,slotProps:{backdrop:{invisible:!0}},PaperProps:{sx:{width:ys}},children:x})]})}function Cs({message:s,participants:n,currentUserId:i}){const t=s.isOwn,r=s.sender,l=n==null?void 0:n.find(d=>d.id===s.senderId||String(d.id)===String(s.senderId)),a=t?{type:"me"}:{avatarUrl:(l==null?void 0:l.avatarUrl)||null,firstName:(r==null?void 0:r.name)||(l==null?void 0:l.firstName)||"Unknown"};return{hasImage:s.contentType==="image",me:t,senderDetails:a}}function ws({message:s,participants:n,onOpenLightbox:i}){const{user:t}=H(),{me:r,senderDetails:l}=Cs({message:s,participants:n,currentUserId:`${t==null?void 0:t.id}`}),{firstName:a,avatarUrl:o}=l,{content:d,createdAt:f,contentType:x,attachments:g}=s,v=x==="image"||x==="media"?g&&g.length>0?g[0].url||g[0].preview:d:null,h=e.jsxs(I,{noWrap:!0,variant:"caption",sx:{mt:.5,color:"text.disabled",...!r&&{mr:"auto"}},children:[!r&&`${a}، `,ee(f)]}),b=e.jsx(u,{sx:{p:1.5,minWidth:48,maxWidth:320,borderRadius:1,typography:"body2",bgcolor:"background.neutral",...r&&{color:"grey.800",bgcolor:"primary.lighter"},...v&&{p:0,bgcolor:"transparent"}},children:v?e.jsx(D,{component:"img",alt:"attachment",src:v,onClick:()=>i(v),sx:{width:400,height:"auto",borderRadius:1.5,cursor:"pointer",objectFit:"cover",aspectRatio:"16/11","&:hover":{opacity:.9}}}):d}),j=e.jsxs(u,{direction:"row",className:"message-actions",sx:{pt:.5,left:0,opacity:0,top:"100%",position:"absolute",transition:C=>C.transitions.create(["opacity"],{duration:C.transitions.duration.shorter}),...r&&{right:0,left:"unset"}},children:[e.jsx(k,{size:"small",children:e.jsx(y,{icon:"solar:reply-bold",width:16})}),e.jsx(k,{size:"small",children:e.jsx(y,{icon:"eva:smiling-face-fill",width:16})}),e.jsx(k,{size:"small",children:e.jsx(y,{icon:"solar:trash-bin-trash-bold",width:16})})]});return e.jsxs(u,{direction:"row",justifyContent:r?"flex-end":"unset",sx:{mb:5},children:[!r&&e.jsx(N,{alt:a,src:T(o),sx:{width:32,height:32,mr:2}}),e.jsxs(u,{alignItems:r?"flex-end":"flex-start",children:[e.jsxs(u,{direction:"row",alignItems:"center",sx:{position:"relative","&:hover":{"& .message-actions":{opacity:1}}},children:[b,j]}),h]})]})}function ks(s){const n=c.useRef(null),i=c.useCallback(()=>{s&&n.current&&n.current&&(n.current.scrollTop=n.current.scrollHeight)},[s]);return c.useEffect(()=>{i()},[s]),{messagesEndRef:n}}function Ss({messages:s=[],participants:n,loading:i}){const{messagesEndRef:t}=ks(s),r=s.filter(a=>a.contentType==="image").map(a=>({src:a.content})),l=He(r);return i?e.jsx(u,{sx:{flex:"1 1 auto",position:"relative"},children:e.jsx(Oe,{color:"inherit",sx:{top:0,left:0,width:1,height:2,borderRadius:0,position:"absolute"}})}):e.jsxs(e.Fragment,{children:[e.jsx(se,{ref:t,sx:{px:3,pt:5,pb:3,flex:"1 1 auto",background:"linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%)"},children:s.map(a=>e.jsx(ws,{message:a,participants:n,onOpenLightbox:()=>l.onOpen(a.content)},a.id))}),e.jsx(_e,{slides:r,open:l.open,close:l.onClose,index:l.selected})]})}function Is({disabled:s,recipients:n,onAddRecipients:i,selectedConversationId:t,participants:r=[]}){const l=K(),{user:a}=H(),{user:o}=J(),d=c.useRef(null),[f,x]=c.useState(""),[g,v]=c.useState([]),[h,b]=c.useState(!1),j=c.useMemo(()=>({id:`${(o==null?void 0:o.id)||(a==null?void 0:a.id)}`,role:`${(o==null?void 0:o.role)||(a==null?void 0:a.role)}`,email:`${(o==null?void 0:o.email)||(a==null?void 0:a.email)}`,address:`${(o==null?void 0:o.address)||(a==null?void 0:a.address)}`,name:`${(o==null?void 0:o.displayName)||(a==null?void 0:a.displayName)}`,lastActivity:$e(),avatarUrl:`${(o==null?void 0:o.photoURL)||(a==null?void 0:a.photoURL)}`,phoneNumber:`${(o==null?void 0:o.phoneNumber)||(a==null?void 0:a.phoneNumber)}`,status:"online"}),[o,a]),C=c.useMemo(()=>{let m=null;if(t&&r&&r.length>0){const p=r[0];p&&p.id&&(m=p.id)}else if(n&&n.length>0){const p=n[0];p&&p.id&&(m=String(p.id))}return{id:le(),attachments:g,content:f.trim(),contentType:g.length>0?"image":"text",createdAt:Ee({minutes:1}),senderId:j.id,recipientId:m}},[f,g,j.id,t,r,n]);c.useMemo(()=>({id:le(),messages:[C],participants:[...n,j],type:n.length>1?"GROUP":"ONE_TO_ONE",unreadCount:0}),[C,j,n]),c.useCallback(()=>{d.current&&d.current.click()},[]);const R=c.useCallback(async(m,p)=>{b(!0);try{const S=m.map(async w=>{const F=new FormData;F.append("file",w),F.append("type",p==="image"?"image":"document");const B=`${(ne.site.serverUrl||"http://localhost:7272").replace(/\/$/,"")}/api/upload/chat`,ie=await Le.post(B,F,{headers:{Authorization:`Bearer ${(o==null?void 0:o.accessToken)||(a==null?void 0:a.accessToken)}`}});return{name:w.name,size:w.size,type:w.type,url:ie.data.url,preview:p==="image"?ie.data.url:null}}),O=await Promise.all(S);v(O)}catch(S){console.error("File upload error:",S),alert("خطا در آپلود فایل")}finally{b(!1)}},[a,o]);c.useCallback(()=>{const m=document.createElement("input");m.type="file",m.accept="image/*",m.onchange=async p=>{const S=Array.from(p.target.files||[]);S.length>0&&await R(S,"image")},m.click()},[R]);const L=c.useCallback(()=>{const m=document.createElement("input");m.type="file",m.onchange=async p=>{const S=Array.from(p.target.files||[]);S.length>0&&await R(S,"file")},m.click()},[R]),$=c.useCallback(m=>{v(p=>p.filter((S,O)=>O!==m))},[]),P=c.useCallback(m=>{x(m.target.value)},[]),M=c.useCallback(async()=>{try{if(f.trim()||g.length>0){const p=await ts(t,C);!t&&p.chatId&&(l.push(`${U.dashboard.chat}?id=${p.chatId}`),i([])),x(""),v([])}}catch(m){console.error("Send message error:",m),alert("خطا در ارسال پیام")}},[f,C,i,l,t,g]);return e.jsxs(e.Fragment,{children:[g.length>0&&e.jsx(u,{direction:"row",spacing:1,sx:{p:1,borderTop:m=>`solid 1px ${m.vars.palette.divider}`},children:g.map((m,p)=>e.jsxs(u,{direction:"row",spacing:1,alignItems:"center",sx:{bgcolor:"grey.100",p:1,borderRadius:1},children:[e.jsx(I,{variant:"body2",sx:{maxWidth:100,overflow:"hidden",textOverflow:"ellipsis"},children:m.name}),e.jsx(k,{size:"small",onClick:()=>$(p),children:e.jsx(y,{icon:"eva:close-fill",width:16})})]},p))}),e.jsx(Fe,{name:"chat-message",id:"chat-message-input",value:f,onChange:P,placeholder:"یک پیام بفرستید",disabled:s||h,onKeyDown:m=>{m.key==="Enter"&&!m.shiftKey&&(m.preventDefault(),M())},startAdornment:e.jsx(u,{direction:"row",sx:{flexShrink:0},children:e.jsx(k,{onClick:M,disabled:s||h||!f.trim()&&g.length===0,children:e.jsx(y,{icon:"carbon:send-filled"})})}),endAdornment:e.jsx(u,{direction:"row",sx:{flexShrink:0},children:e.jsx(k,{onClick:L,disabled:h,children:e.jsx(y,{icon:"eva:attach-2-fill"})})}),sx:{px:1,height:56,flexShrink:0,borderTop:m=>`solid 1px ${m.vars.palette.divider}`,"& input::placeholder":{fontSize:"0.875rem"}}}),e.jsx("input",{type:"file",ref:d,style:{display:"none"}})]})}const Rs=[{value:"spam",label:"اسپم"},{value:"harassment",label:"آزار و اذیت"},{value:"inappropriate_content",label:"محتوای نامناسب"},{value:"fake_account",label:"حساب جعلی"},{value:"other",label:"سایر"}];function As({open:s,onClose:n,reportedUserId:i,reportedUserName:t}){const{user:r}=J(),[l,a]=c.useState(""),[o,d]=c.useState(""),[f,x]=c.useState(!1),g=b=>{a(b.target.value),b.target.value!=="other"&&d("")},v=async()=>{var b,j;if(!l){W.error("لطفاً دلیل گزارش را انتخاب کنید");return}if(l==="other"&&!o.trim()){W.error("لطفاً توضیحات را وارد کنید");return}try{x(!0),await X.post(ve.chat.report,{reportedId:i,reason:l,description:l==="other"?o:null},{headers:{Authorization:`Bearer ${r==null?void 0:r.accessToken}`}}),W.success("گزارش با موفقیت ارسال شد. ادمین آن را بررسی خواهد کرد."),a(""),d(""),n()}catch(C){console.error("Error submitting report:",C);const R=((j=(b=C.response)==null?void 0:b.data)==null?void 0:j.message)||C.message||"خطا در ارسال گزارش";W.error(R)}finally{x(!1)}},h=()=>{f||(a(""),d(""),n())};return e.jsxs(ye,{open:s,onClose:h,maxWidth:"sm",fullWidth:!0,children:[e.jsx(qe,{children:e.jsxs(u,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(y,{icon:"solar:danger-triangle-bold",width:24}),e.jsx(I,{variant:"h6",children:"گزارش کاربر"})]})}),e.jsxs(ke,{children:[e.jsxs(I,{variant:"body2",sx:{mb:3,color:"text.secondary"},children:["گزارش کاربر: ",e.jsx("strong",{children:t})]}),e.jsx(I,{variant:"subtitle2",sx:{mb:2},children:"دلیل گزارش را انتخاب کنید:"}),e.jsx(Ke,{value:l,onChange:g,children:Rs.map(b=>e.jsx(Ye,{value:b.value,control:e.jsx(Je,{}),label:b.label},b.value))}),l==="other"&&e.jsx(D,{sx:{mt:3},children:e.jsx(re,{fullWidth:!0,multiline:!0,rows:4,label:"توضیحات",placeholder:"لطفاً دلیل گزارش را به صورت کامل توضیح دهید...",value:o,onChange:b=>d(b.target.value)})})]}),e.jsxs(Qe,{children:[e.jsx(Y,{onClick:h,disabled:f,children:"انصراف"}),e.jsx(Y,{variant:"contained",color:"error",onClick:v,disabled:f||!l||l==="other"&&!o.trim(),children:f?"در حال ارسال...":"ارسال گزارش"})]})]})}function Ns({collapseNav:s,participants:n,loading:i}){const t=ue(),{user:r}=J(),[l,a]=c.useState(!1),[o,d]=c.useState(!1),[f,x]=c.useState(!1),g=Z("up","lg"),v=n.length>1,h=n[0],{collapseDesktop:b,onCollapseDesktop:j,onOpenMobile:C}=s,R=c.useCallback(()=>{g?j():C()},[g]),L=c.useCallback(()=>{t.onClose(),a(!0)},[t]),$=c.useCallback(async()=>{var p,S;if(!(!(h!=null&&h.id)||!(r!=null&&r.accessToken)))try{x(!0),await X.post(ve.chat.block,{blockedId:h.id},{headers:{Authorization:`Bearer ${r.accessToken}`}}),W.success("کاربر با موفقیت مسدود شد"),a(!1),window.location.href="/dashboard/chat"}catch(O){console.error("Error blocking user:",O);const w=((S=(p=O.response)==null?void 0:p.data)==null?void 0:S.message)||O.message||"خطا در مسدود کردن کاربر";W.error(w)}finally{x(!1)}},[h,r]),P=c.useCallback(()=>{t.onClose(),d(!0)},[t]),M=e.jsx(we,{max:3,sx:{[`& .${Me.avatar}`]:{width:32,height:32}},children:n.map(p=>e.jsx(N,{alt:p.name,src:T(p.avatarUrl)},p.id))}),m=e.jsxs(u,{direction:"row",alignItems:"center",spacing:2,children:[e.jsx(N,{src:T(h==null?void 0:h.avatarUrl),alt:h==null?void 0:h.name}),e.jsx(G,{primary:h==null?void 0:h.name,secondary:h!=null&&h.lastActivity?`آخرین بازدید: ${ee(h.lastActivity)}`:"آخرین بازدید: نامشخص",secondaryTypographyProps:{component:"span"}})]});return i?e.jsx(ds,{}):e.jsxs(e.Fragment,{children:[v?M:m,e.jsxs(u,{direction:"row",flexGrow:1,justifyContent:"flex-end",children:[e.jsx(k,{onClick:R,children:e.jsx(y,{icon:b?"ri:sidebar-fold-fill":"ri:sidebar-unfold-fill"})}),e.jsx(k,{onClick:t.onOpen,children:e.jsx(y,{icon:"eva:more-vertical-fill"})})]}),e.jsx(me,{open:t.open,anchorEl:t.anchorEl,onClose:t.onClose,children:e.jsxs(ge,{children:[e.jsxs(V,{onClick:L,children:[e.jsx(y,{icon:"solar:forbidden-circle-bold"}),"مسدود کردن"]}),e.jsxs(V,{onClick:P,children:[e.jsx(y,{icon:"solar:danger-triangle-bold"}),"گزارش"]}),e.jsx(pe,{sx:{borderStyle:"dashed"}}),e.jsxs(V,{onClick:()=>{t.onClose()},sx:{color:"error.main"},children:[e.jsx(y,{icon:"solar:trash-bin-trash-bold"}),"حذف"]})]})}),e.jsx(Ue,{open:l,onClose:()=>a(!1),title:"مسدود کردن کاربر",content:e.jsxs(e.Fragment,{children:["آیا از مسدود کردن ",e.jsx("strong",{children:h==null?void 0:h.name})," مطمئن هستید؟",e.jsx("br",{}),"پس از مسدود کردن، امکان ارسال یا دریافت پیام از این کاربر را نخواهید داشت."]}),action:e.jsx(Y,{variant:"contained",color:"error",onClick:$,disabled:f,children:f?"در حال مسدود کردن...":"مسدود کردن"})}),e.jsx(As,{open:o,onClose:()=>d(!1),reportedUserId:h==null?void 0:h.id,reportedUserName:h==null?void 0:h.name})]})}function Ts({contacts:s,onAddRecipients:n}){const[i,t]=c.useState(""),r=c.useCallback(l=>{t(""),n(l)},[n]);return e.jsxs(e.Fragment,{children:[e.jsx(I,{variant:"subtitle2",sx:{color:"text.primary",mr:2},children:"به:"}),e.jsx(Xe,{sx:{minWidth:{md:320},flexGrow:{xs:1,md:"unset"}},multiple:!0,limitTags:3,popupIcon:null,defaultValue:[],disableCloseOnSelect:!0,noOptionsText:e.jsx(fe,{query:i}),onChange:(l,a)=>r(a),onInputChange:(l,a)=>t(a),options:s,getOptionLabel:l=>l.name,isOptionEqualToValue:(l,a)=>l.id===a.id,renderInput:l=>e.jsx(re,{...l,placeholder:"+ مخاطبین"}),renderOption:(l,a,{selected:o})=>c.createElement("li",{...l,key:a.id},e.jsxs(D,{sx:{mr:1,width:32,height:32,overflow:"hidden",borderRadius:"50%",position:"relative"},children:[e.jsx(N,{alt:a.name,src:T(a.avatarUrl),sx:{width:1,height:1}}),e.jsx(u,{alignItems:"center",justifyContent:"center",sx:{top:0,left:0,width:1,height:1,opacity:0,position:"absolute",bgcolor:d=>E(d.vars.palette.grey["900Channel"],.8),transition:d=>d.transitions.create(["opacity"],{easing:d.transitions.easing.easeInOut,duration:d.transitions.duration.shorter}),...o&&{opacity:1,color:"primary.main"}},children:e.jsx(y,{icon:"eva:checkmark-fill"})})]},a.id),a.name),renderTags:(l,a)=>l.map((o,d)=>c.createElement(Ze,{...a({index:d}),key:o.id,label:o.name,avatar:e.jsx(N,{alt:o.name,src:T(o.avatarUrl)}),size:"small",variant:"soft"}))})]})}function de(){const[s,n]=c.useState(!1),[i,t]=c.useState(!1),r=c.useCallback(()=>{t(d=>!d)},[]),l=c.useCallback(()=>{t(!1)},[]),a=c.useCallback(()=>{n(!0)},[]),o=c.useCallback(()=>{n(!1)},[]);return{collapseDesktop:i,onCloseDesktop:l,onCollapseDesktop:r,openMobile:s,onOpenMobile:a,onCloseMobile:o}}function Ps(){const{contacts:s}=es(),i=new URLSearchParams(window.location.search).get("id")||"",[t,r]=c.useState([]),{conversations:l,conversationsLoading:a}=Ie(),{conversation:o,conversationError:d,conversationLoading:f}=ss(`${i}`),x=de(),g=de(),{user:v}=H();let h=[];if(o){const j=o.participants;Array.isArray(j)&&j.length&&typeof j[0]=="object"?h=j.filter(C=>String(C.id)!==String(v==null?void 0:v.id)):o.otherParticipant?h=[{id:o.otherParticipant.id,name:`${o.otherParticipant.firstName} ${o.otherParticipant.lastName}`,firstName:o.otherParticipant.firstName,lastName:o.otherParticipant.lastName,email:o.otherParticipant.email,phone:o.otherParticipant.phone,phoneNumber:o.otherParticipant.phone,specialty:o.otherParticipant.specialty,role:o.otherParticipant.role||o.otherParticipant.specialty,avatarUrl:o.otherParticipant.avatarUrl||null,lastActivity:o.otherParticipant.lastActivity||o.otherParticipant.updatedAt,status:"offline"}]:h=[]}c.useEffect(()=>{var j;(d||!i)&&(j=window==null?void 0:window.history)!=null&&j.pushState&&window.history.pushState({},"","/dashboard/chat")},[d,i]);const b=c.useCallback(j=>{r(j)},[]);return e.jsxs(We,{maxWidth:!1,sx:{display:"flex",flex:"1 1 auto",flexDirection:"column"},children:[e.jsx(I,{variant:"h4",sx:{mb:{xs:3,md:5}},children:"چت"}),e.jsx(ns,{sx:{minHeight:0,flex:"1 1 0",borderRadius:2,position:"relative",bgcolor:"background.paper",boxShadow:j=>j.customShadows.card},slots:{header:i?e.jsx(Ns,{collapseNav:x,participants:h,loading:f}):e.jsx(Ts,{contacts:s,onAddRecipients:b}),nav:e.jsx(ms,{contacts:s,conversations:l,loading:a,selectedConversationId:i,collapseNav:g}),main:e.jsxs(e.Fragment,{children:[i?e.jsx(Ss,{messages:(o==null?void 0:o.messages)??[],participants:h,loading:f}):e.jsx(Be,{imgUrl:`${ne.site.basePath}/assets/icons/empty/ic-chat-active.svg`,title:"خوش آمدید!",description:"یک مکالمه را انتخاب کنید یا مکالمه جدیدی شروع کنید..."}),e.jsx(Is,{recipients:t,onAddRecipients:b,selectedConversationId:i,participants:h,disabled:!t.length&&!i})]}),details:i&&e.jsx(vs,{collapseNav:x,participants:h,loading:f,messages:(o==null?void 0:o.messages)??[]})}})]})}const Ds={title:`چت با پزشکان | Dashboard - ${ne.site.name}`};function at(){return e.jsxs(e.Fragment,{children:[e.jsx(ze,{children:e.jsxs("title",{children:[" ",Ds.title]})}),e.jsx(Ps,{})]})}export{at as default};
