# ุชูุถุญ ูุดุฏุงุฑูุง Validation ุจุฑุง P1/P2 Detection

## ุฎูุงุตู ูุดฺฉู

ููุช ูุฏู P1/P2 ุฑุง ุชุดุฎุต ูโุฏูุฏุ ฺูุฏ validation check ุงูุฌุงู ูโุดูุฏ. ุงฺฏุฑ ูุฑ ฺฉุฏุงู fail ฺฉููุฏุ ุงุฒ fallback (Computer Vision) ุงุณุชูุงุฏู ูโุดูุฏ.

---

## ูุนู ูุดุฏุงุฑูุง

### 1. โ `ML detection successful`
**ูุนู**: ูุฏู P1/P2 ุฑุง ูพุฏุง ฺฉุฑุฏู ุงุณุช.
- `p1: (736.6, 139.9)` - ููุทู ูพุงู (1cm ุงุฒ p2)
- `p2: (907.1, 56.9)` - ููุทู ุจุงูุง
- `Confidence: 100%` - ุงุทููุงู ูุฏู
- `Processing time: 107ms` - ุฒูุงู ูพุฑุฏุงุฒุด

**ูุถุนุช**: โ ุฎูุจ - ูุฏู ฺฉุงุฑ ฺฉุฑุฏู ุงุณุช

---

### 2. โ๏ธ `ML detection failed validation`
**ูุนู**: ูุฏู P1/P2 ุฑุง ูพุฏุง ฺฉุฑุฏู ุงูุง validation checks fail ฺฉุฑุฏูโุงูุฏ.

**ุฏูุงู ููฺฉู**:

#### a) `isVertical: false`
- **ูุนู**: ููุงุท ุจู ุตูุฑุช ุนููุฏ align ูุณุชูุฏ
- **ฺฺฉ**: `dx < 50` ู `50 < dy < 200`
- **ูุซุงู**: `dx: 170.5` (ุจุงุฏ < 50 ุจุงุดุฏ)
- **ุนูุช**: 
  - ูุฏู ุงุดุชุจุงู ุชุดุฎุต ุฏุงุฏู
  - p1 ู p2 ุฌุงุจุฌุง ุดุฏูโุงูุฏ
  - ุชุตูุฑ crop ูุดุฏู ุง crop ุงุดุชุจุงู ุงุณุช

#### b) `UpperRight: false`
- **ูุนู**: ููุงุท ุฏุฑ upper right corner ูุณุชูุฏ
- **ฺฺฉ**: `x >= 70% && x <= 99%` ู `y >= 0 && y <= 30%`
- **ูุซุงู**: `p1: (736.6, 139.9)` ุฏุฑ ุชุตูุฑ 1000x500
- **ุนูุช**:
  - ุชุตูุฑ crop ูุดุฏู
  - ูุฏู ุฏุฑ ุฌุง ุงุดุชุจุงู ุฌุณุชุฌู ฺฉุฑุฏู
  - ุชุตูุฑ ุจุฒุฑฺฏ ุงุณุช ู crop region ุฏุฑุณุช ูุณุช

#### c) `Confidence < 30%`
- **ูุนู**: ุงุทููุงู ูุฏู ฺฉู ุงุณุช
- **ฺฺฉ**: `confidence >= 0.3`
- **ุนูุช**: ูุฏู ูุทูุฆู ูุณุช ุงุฒ ุชุดุฎุต

**ูุถุนุช**: โ๏ธ ูุงุฒ ุจู ุจุฑุฑุณ - ุงุฒ fallback ุงุณุชูุงุฏู ูโุดูุฏ

---

### 3. โ๏ธ `No valid pair found`
**ูุนู**: Computer Vision fallback ูู ูุชูุงูุณุช ฺฉ ุฌูุช ูุนุชุจุฑ ูพุฏุง ฺฉูุฏ.

**ุนูุช**:
- ุชุตูุฑ ฺฉูุช ูพุงู ุฏุงุฑุฏ
- ููุงุท calibration ุฏุฑ ุชุตูุฑ ูุณุชูุฏ
- ุฑูุด Computer Vision ููุงุณุจ ุงู ุชุตูุฑ ูุณุช

**ูุถุนุช**: โ๏ธ ูุดฺฉู - ุงุฒ conversion ูพุดโูุฑุถ ุงุณุชูุงุฏู ูโุดูุฏ

---

### 4. โ๏ธ `Detected points are NOT vertically aligned`
**ูุนู**: ููุงุท ูพุฏุง ุดุฏู ุนููุฏ ูุณุชูุฏ.

**ูุซุงู**: `dx: 96.0, dy: 181.0`
- `dx = 96` (ุจุงุฏ < 50 ุจุงุดุฏ) - ุฎู ุจุฒุฑฺฏ!
- `dy = 181` (ุจุงุฏ ุจู 50-200 ุจุงุดุฏ) - ุฏุฑุณุช ุงุณุช

**ุนูุช**: 
- ููุงุท ุงุดุชุจุงู ุชุดุฎุต ุฏุงุฏู ุดุฏูโุงูุฏ
- ุง p1/p2 ุฌุงุจุฌุง ุดุฏูโุงูุฏ

**ูุถุนุช**: โ๏ธ ูุดฺฉู - ุงุฒ conversion ูพุดโูุฑุถ ุงุณุชูุงุฏู ูโุดูุฏ

---

### 5. โ๏ธ `Falling back to default conversion`
**ูุนู**: ุงุฒ conversion factor ูพุดโูุฑุถ (0.11 mm/pixel) ุงุณุชูุงุฏู ูโุดูุฏ.

**ุนูุช**: 
- ML detection fail ฺฉุฑุฏ
- Computer Vision fallback ูู fail ฺฉุฑุฏ
- ุง validation checks fail ฺฉุฑุฏูุฏ

**ูุถุนุช**: โ๏ธ ูุดุฏุงุฑ - ููฺฉู ุงุณุช ุงูุฏุงุฒูโฺฏุฑโูุง ุฏูู ูุจุงุดูุฏ

---

## ุฑุงูโุญูโูุง

### 1. ุจุฑุฑุณ Crop
- ูุทูุฆู ุดูุฏ ฺฉู backend ุชุตูุฑ ุฑุง crop ูโฺฉูุฏ (80-95% x, 0-20% y)
- ูุงฺฏโูุง backend ุฑุง ฺฺฉ ฺฉูุฏ: `[P1P2] Cropped image: ...`

### 2. ุจูุจูุฏ Validation
- threshold `dx` ุงุฒ 30 ุจู 50 ุงูุฒุงุด ุงูุช (ุงูุนุทุงูโูพุฐุฑุชุฑ)
- margin ุจุฑุง upper right corner ุงูุฒุงุด ุงูุช (70-99% x, 0-30% y)
- ุงฺฏุฑ p1/p2 ุฌุงุจุฌุง ุดุฏู ุจุงุดูุฏุ ุฎูุฏฺฉุงุฑ swap ูโุดููุฏ

### 3. ุงุณุชูุงุฏู ุงุฒ TTA
- ุงุฒ endpoint `/detect-p1p2-tta` ุงุณุชูุงุฏู ฺฉูุฏ (ุฏูุช ุจุงูุงุชุฑ)

### 4. ุจุฑุฑุณ ุชุตูุฑ
- ูุทูุฆู ุดูุฏ ฺฉู ููุงุท calibration ุฏุฑ upper right corner ูุณุชูุฏ
- ฺฉูุช ุชุตูุฑ ุจุงุฏ ุฎูุจ ุจุงุดุฏ

---

## ูุซุงู ูุงฺฏ ูููู

```
โ ML detection successful
   Confidence: 100.0%
   p1: (850.2, 120.5)
   p2: (860.1, 45.3)
๐ Validation:
   isVertical: true (dx: 9.9, dy: 75.2)
   isInUpperRight: true
   passesValidation: true
โ Using ML-detected points
```

---

## ูุซุงู ูุงฺฏ ูุงูููู (ูุดฺฉู ูุนู)

```
โ ML detection successful
   p1: (736.6, 139.9)
   p2: (907.1, 56.9)
๐ Validation:
   isVertical: false (dx: 170.5, dy: 83.0)  โ ูุดฺฉู: dx ุฎู ุจุฒุฑฺฏ ุงุณุช
   isInUpperRight: false  โ ูุดฺฉู: ููุงุท ุฏุฑ upper right ูุณุชูุฏ
โ๏ธ ML detection failed validation - using fallback
```

**ุนูุช**: 
- `dx = 170.5` ุฎู ุจุฒุฑฺฏ ุงุณุช (ุจุงุฏ < 50)
- ุงู ุนู p1 ู p2 ุจู ุตูุฑุช ุงูู ุงุฒ ูู ูุงุตูู ุฏุงุฑูุฏุ ูู ุนููุฏ
- ุงุญุชูุงูุงู ูุฏู ุงุดุชุจุงู ุชุดุฎุต ุฏุงุฏู ุง crop ฺฉุงุฑ ูฺฉุฑุฏู

---

## ูฺฉุงุช ููู

1. **dx ุจุงุฏ ฺฉูฺฺฉ ุจุงุดุฏ** (< 50): ููุงุท ุจุงุฏ ุนููุฏ ุจุงุดูุฏ
2. **dy ุจุงุฏ ุจู 50-200 ุจุงุดุฏ**: ูุงุตูู ุนููุฏ ููุทู ุจุฑุง 1cm
3. **ููุงุท ุจุงุฏ ุฏุฑ upper right corner ุจุงุดูุฏ**: 70-99% x, 0-30% y
4. **Confidence ุจุงุฏ >= 30% ุจุงุดุฏ**: ูุฏู ุจุงุฏ ูุทูุฆู ุจุงุดุฏ

ุงฺฏุฑ ููู ุงูโูุง ุฏุฑุณุช ุจุงุดูุฏุ ุงุฒ ML detection ุงุณุชูุงุฏู ูโุดูุฏ. ุฏุฑ ุบุฑ ุงู ุตูุฑุชุ ุงุฒ fallback ุงุณุชูุงุฏู ูโุดูุฏ.













