# ุฑุงูููุง ุจูููโุณุงุฒ GPU ุจุฑุง Fine-tuning

## ๐ฏ ูุดฺฉู

- ูุตุฑู GPU ุฏุฑ ููุณุงู ุงุณุช (50-200 ูุงุช)
- GPU ุจู ุทูุฑ ฺฉุงูู ุงุณุชูุงุฏู ููโุดูุฏ
- VRAM ุชูุฑุจุง ูพุฑ ุงุณุช (7GB ุงุฒ 8GB)
- ุขููุฒุด ฺฉูุฏ ุงุณุช

## โ ุฑุงูฺฉุงุฑูุง ุงุนูุงู ุดุฏู

### 1. ุจูููโุณุงุฒ Data Loading

- **ุงูุฒุงุด `num_workers`**: ุงุฒ 4 ุจู 8 (ูพุดโูุฑุถ ุฌุฏุฏ)
  - ุงุณุชูุงุฏู ุจูุชุฑ ุงุฒ CPU cores
  - ฺฉุงูุด ุฒูุงู ุงูุชุธุงุฑ GPU ุจุฑุง ุฏุงุฏู
  
- **ุงูุฒุงุด `prefetch_factor`**: ุงุฒ 2 ุจู 4 (ูพุดโูุฑุถ ุฌุฏุฏ)
  - ูพุดโุจุงุฑฺฏุฐุงุฑ ุจุดุชุฑ batch ูุง
  - ฺฉุงูุด idle time GPU

- **ุงุณุชูุงุฏู ุงุฒ `non_blocking=True`**: 
  - ุงูุชูุงู ุบุฑูุณุฏูุฏฺฉููุฏู ุฏุงุฏู ุจู GPU
  - ูพุฑุฏุงุฒุด ููุฒูุงู CPU ู GPU

### 2. ุจูููโุณุงุฒ ูุฏู

- **`torch.compile`**: 
  - ฺฉุงููพุงู ูุฏู ุจุฑุง ุณุฑุนุช ุจุดุชุฑ (30-50% ุจูุจูุฏ)
  - ูุนุงู ุจุง `--use_compile`
  
- **`channels_last` memory format**:
  - ูุฑูุช ุญุงูุธู ุจูููโุชุฑ ุจุฑุง GPU
  - ูุนุงู ุจุง `--channels_last`

### 3. Mixed Precision

- ุงุณุชูุงุฏู ุงุฒ FP16 ุจุฑุง:
  - ุณุฑุนุช ุจุดุชุฑ
  - ูุตุฑู ฺฉูุชุฑ VRAM
  - ูุนุงู ุจุง `--mixed_precision`

## ๐ ุงุณุชูุงุฏู

### ุฑูุด 1: ุงุณุชูุงุฏู ุงุฒ ูุงู Batch (ูพุดููุงุฏ)

```bash
cd Aariz
finetune_combined.bat
```

ูุงู batch ุจูโุฑูุฒุฑุณุงู ุดุฏู ู ุดุงูู ุจูููโุณุงุฒโูุง ุงุณุช.

### ุฑูุด 2: ุงุฌุฑุง ุฏุณุช ุจุง ุชูุธูุงุช ุจููู

```bash
python finetune_combined.py \
    --resume checkpoints/checkpoint_best.pth \
    --batch_size 6 \
    --num_workers 8 \
    --prefetch_factor 4 \
    --mixed_precision \
    --use_compile \
    --channels_last
```

## โ๏ธ ุชูุธูุงุช ูพุดููุงุฏ

### ุจุฑุง GPU ุจุง VRAM ูุญุฏูุฏ (7-8GB) ู CPU i5 9400F (6 cores):

```bash
--batch_size 6
--num_workers 6  # ุจุฑุง 6 cores: 4-6 ููุงุณุจ ุงุณุช
--prefetch_factor 4
--mixed_precision
--use_compile
--channels_last
```

**ูฺฉุชู ููู ุจุฑุง i5 9400F:**
- ุงู CPU ุฏุงุฑุง 6 cores ู 6 threads ุงุณุช (ุจุฏูู Hyper-Threading)
- `num_workers=6` ุจููู ุงุณุช (ูุนุงุฏู ุชุนุฏุงุฏ cores)
- `num_workers=4` ูุญุงูุธูโฺฉุงุฑุงููโุชุฑ ู ุจุฑุง ุณุณุชูโูุง ุจุง RAM ูุญุฏูุฏ
- `num_workers=8` ููฺฉู ุงุณุช overhead ุงุฌุงุฏ ฺฉูุฏ ู ุชูุตู ููโุดูุฏ

### ุจุฑุง GPU ุจุง VRAM ุจุดุชุฑ (10GB+):

```bash
--batch_size 8
--num_workers 12
--prefetch_factor 6
--mixed_precision
--use_compile
--channels_last
```

### ุงฺฏุฑ ูููุฒ VRAM ูพุฑ ุงุณุช:

```bash
--batch_size 4
--num_workers 6
--prefetch_factor 2
--mixed_precision
--use_compile
--channels_last
```

## ๐ ูุชุงุฌ ุงูุชุธุงุฑ

### ูุจู ุงุฒ ุจูููโุณุงุฒ:
- ูุตุฑู GPU: ููุณุงู 50-200 ูุงุช
- GPU Utilization: 50-70%
- ุฒูุงู ูุฑ epoch: ~3-4 ุฏููู

### ุจุนุฏ ุงุฒ ุจูููโุณุงุฒ:
- ูุตุฑู GPU: ูพุงุฏุงุฑุชุฑ (150-200 ูุงุช)
- GPU Utilization: 80-95%
- ุฒูุงู ูุฑ epoch: ~2-2.5 ุฏููู (30-40% ุณุฑุนโุชุฑ)

## ๐ง ุชูุธูุงุช ูพุดุฑูุชู

### ุงฺฏุฑ CPU bottleneck ุงุณุช:

ุงูุฒุงุด `num_workers` (ุงูุง ูู ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ cores):
```bash
--num_workers 6  # ุจุฑุง i5 9400F (6 cores) - ุญุฏุงฺฉุซุฑ ููุฏุงุฑ ููุงุณุจ
--num_workers 8  # ุจุฑุง CPU ุจุง 8+ cores
--num_workers 12 # ุจุฑุง CPU ุจุง 12+ cores
```

**ูุงุนุฏู ฺฉู:**
- `num_workers` = ุชุนุฏุงุฏ CPU cores (ุง ฺฉู ฺฉูุชุฑ)
- ุจุฑุง i5 9400F: 4-6 ููุงุณุจ ุงุณุช
- ุจุดุชุฑ ุงุฒ ุชุนุฏุงุฏ cores ูุนูููุงู overhead ุงุฌุงุฏ ูโฺฉูุฏ

### ุงฺฏุฑ Memory bottleneck ุงุณุช:

ฺฉุงูุด `prefetch_factor`:
```bash
--prefetch_factor 2  # ุง ุญุช 1
```

### ุงฺฏุฑ VRAM ูุดฺฉู ุฏุงุฑุฏ:

ฺฉุงูุด `batch_size`:
```bash
--batch_size 4  # ุง ุญุช 2
```

ุง ุงุณุชูุงุฏู ุงุฒ `--freeze_backbone`:
```bash
--freeze_backbone  # ููุท head ุฑุง ุขููุฒุด ูโุฏูุฏ
```

## ๐ก ูฺฉุงุช ููู

1. **ุงููู epoch ฺฉูุฏุชุฑ ุงุณุช**: ุจู ุฏูู compilation ุฏุฑ `torch.compile`
2. **num_workers**: ุจุงุฏ ฺฉูุชุฑ ุงุฒ ุชุนุฏุงุฏ CPU cores ุจุงุดุฏ
3. **prefetch_factor**: ูุฑฺู ุจุดุชุฑุ RAM ุจุดุชุฑ ุงุณุชูุงุฏู ูโุดูุฏ
4. **channels_last**: ููฺฉู ุงุณุช ุฏุฑ ุจุฑุฎ ูุฏูโูุง ฺฉุงุฑ ูฺฉูุฏ (ุจู ุตูุฑุช ุฎูุฏฺฉุงุฑ skip ูโุดูุฏ)
5. **torch.compile**: ูุงุฒ ุจู PyTorch 2.0+ ุฏุงุฑุฏ

## ๐ ุนุจโุงุจ

### ูุดฺฉู: Out of Memory

- ฺฉุงูุด `batch_size`
- ฺฉุงูุด `prefetch_factor`
- ุงุณุชูุงุฏู ุงุฒ `--freeze_backbone`

### ูุดฺฉู: CPU ุฏุฑ 100%

- ฺฉุงูุด `num_workers`
- ฺฉุงูุด `prefetch_factor`

### ูุดฺฉู: GPU ูููุฒ ุฏุฑ ููุณุงู

- ุงูุฒุงุด `num_workers`
- ุงูุฒุงุด `prefetch_factor`
- ุจุฑุฑุณ ุงูฺฉู ุขุง augmentation ุฎู ุณูฺฏู ุงุณุช

## ๐ ูุงูุชูุฑูฺฏ

ุจุฑุง ูุธุงุฑุช ุจุฑ ุงุณุชูุงุฏู ุงุฒ GPU:

```bash
# Windows
nvidia-smi -l 1

# ุง ุงุณุชูุงุฏู ุงุฒ Task Manager > Performance > GPU
```

ูุชุฑฺฉโูุง ููู:
- GPU Utilization: ุจุงุฏ ุจุงูุง 80% ุจุงุดุฏ
- Memory Usage: ุจุงุฏ ูพุงุฏุงุฑ ุจุงุดุฏ
- Power: ุจุงุฏ ูพุงุฏุงุฑุชุฑ ุจุงุดุฏ (ฺฉูุชุฑ ููุณุงู)

## โ ฺฺฉโูุณุช

- [ ] `num_workers` ุงูุฒุงุด ุงูุชู (8+)
- [ ] `prefetch_factor` ุงูุฒุงุด ุงูุชู (4+)
- [ ] `non_blocking=True` ูุนุงู ุงุณุช
- [ ] `mixed_precision` ูุนุงู ุงุณุช
- [ ] `torch.compile` ูุนุงู ุงุณุช (ุงฺฏุฑ PyTorch 2.0+)
- [ ] `channels_last` ูุนุงู ุงุณุช
- [ ] GPU Utilization ุจุงูุง 80% ุงุณุช
- [ ] ูุตุฑู GPU ูพุงุฏุงุฑุชุฑ ุงุณุช

## ๐ฏ ูุชุฌู

ุจุง ุงู ุจูููโุณุงุฒโูุง:
- ุงุณุชูุงุฏู ุงุฒ GPU ุจูุจูุฏ ูโุงุจุฏ (80-95%)
- ูุตุฑู GPU ูพุงุฏุงุฑุชุฑ ูโุดูุฏ
- ุณุฑุนุช ุขููุฒุด 30-40% ุงูุฒุงุด ูโุงุจุฏ
- VRAM ุจูููโุชุฑ ุงุณุชูุงุฏู ูโุดูุฏ

