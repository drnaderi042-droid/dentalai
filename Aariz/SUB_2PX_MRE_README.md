# ุฑุงูููุง ุฏุณุชุงุจ ุจู ุฏูุช ฺฉูุชุฑ ุงุฒ 2 ูพฺฉุณู (Sub-2px MRE)

## ูุฏู
ุขููุฒุด ูุฏู 31 ููุฏูุงุฑฺฉ ุณูุงูููุชุฑ ุจุง ุฏูุช ุจุงูุงุชุฑ ุงุฒ `hrnet_p1p2_heatmap_best.pth` ุจุฑุง ุงุณุชูุงุฏู ุฏุฑ ุณุฑูุฑูุง CPU.

## ูุดฺฉู ูุนู
- ูุฏู ูุนู MRE ุจุงูุงุชุฑ ุงุฒ 9 ูพฺฉุณู ุฏุงุฑุฏ
- ุจุฑุง ุณุฑูุฑ CPU ฺฉูุฏ ุงุณุช
- ุฏูุช ฺฉุงู ุจุฑุง ฺฉุงุฑุจุฑุฏูุง ูพุฒุดฺฉ ูุฏุงุฑุฏ

## ุฑุงู ุญู: ุฑูฺฉุฑุฏ Heatmap ูพุดุฑูุชู

### ฺุฑุง Heatmap ุจูุชุฑ ุงุฒ Regression ูุณุชูู ุงุณุชุ
- **ุฏูุช ุจุงูุงุชุฑ**: ุงุณุชุฎุฑุงุฌ ูุฎุชุตุงุช ุงุฒ heatmap ุจู ุฌุง ูพุดโุจู ูุณุชูู
- **ุซุจุงุช ุจุดุชุฑ**: ุชูุฒุน ุงุญุชูุงู ูพฺฉุณูโูุง ุจู ุฌุง ูุฎุชุตุงุช ฺฏุณุณุชู
- **sub-pixel accuracy**: ุงูฺฉุงู ุงุณุชุฎุฑุงุฌ ุฏูุช ุฒุฑูพฺฉุณู

## ูุงูโูุง ุฌุฏุฏ

### 1. ูุฏู ูพุงู: `model_heatmap_31.py`
```python
class HRNet31HeatmapDetector(nn.Module):
    - HRNet-W32 backbone (ุจุฒุฑฺฏโุชุฑ ุงุฒ W18)
    - Heatmap resolution: 384x384 (ุจุงูุงุชุฑ ุงุฒ 192)
    - Sub-pixel coordinate extraction
    - Advanced loss combination
```

### 2. ุงุณฺฉุฑูพุช ุขููุฒุด: `train_31_heatmap_high_accuracy.py`
```python
# ุชูุธูุงุช ฺฉูุฏ ุจุฑุง ุฏูุช ุจุงูุง:
- heatmap_size=384          # ุจุงูุงุชุฑ ุงุฒ 192
- coord_weight=5.0          # ูุฒู ุจุงูุงุชุฑ ุจุฑุง loss ูุฎุชุตุงุช
- sigma=1.5                 # sharper heatmaps
- HRNet-W32                 # ูุฏู ุจุฒุฑฺฏโุชุฑ
- CosineAnnealingWarmRestarts # scheduler ูพุดุฑูุชู
- Gradient clipping          # ุซุจุงุช ุขููุฒุด
```

### 3. ุจูููโุณุงุฒ CPU: `optimize_31_model_for_cpu.py`
```python
# ุชฺฉูฺฉโูุง ุจูููโุณุงุฒ:
- Dynamic quantization (2-4x speedup)
- ONNX conversion
- CPU-specific optimizations
- Benchmarking tools
```

## ูุฑุงุญู ุงุฌุฑุง ฺฉุงูู

### ูุฑุญูู 1: ุขููุฒุด ูุฏู ุจุง ุฏูุช ุจุงูุง
```batch
# ุขููุฒุด ูุฏู ุงุตู (300 epoch - ฺูุฏ ุณุงุนุช)
train_31_heatmap_high_accuracy.bat
```

**ุงูุชุธุงุฑ ูุชุงุฌ:**
- MRE ฺฉูุชุฑ ุงุฒ 2 ูพฺฉุณู ุฏุฑ validation
- ูุดุงุจู ุฏูุช `hrnet_p1p2_heatmap_best.pth`

### ูุฑุญูู 2: ุจูููโุณุงุฒ ุจุฑุง CPU
```batch
# ุจูููโุณุงุฒ ุจุฑุง ุณุฑูุฑ CPU
optimize_31_model_for_cpu.bat
```

**ุงูุชุธุงุฑ ุจูุจูุฏ:**
- 2-4x ุณุฑุนุช ุจุงูุงุชุฑ
- ุญุฌู ูุฏู ฺฉูุชุฑ
- ููุงุณุจ ุจุฑุง ุณุฑูุฑูุง CPU

### ูุฑุญูู 3: ุชุณุช ููุง
```python
# ุชุณุช ุฏูุช ููุง
python test_31_heatmap_model.py --model models/optimized/hrnet_31_heatmap_quantized.pth
```

## ููุงุณู ุจุง ุฑูฺฉุฑุฏ ูุฏู

| ูฺฺฏ | ุฑูฺฉุฑุฏ ูุฏู | ุฑูฺฉุฑุฏ ุฌุฏุฏ (Heatmap) |
|-------|-------------|----------------------|
| ุฏูุช (MRE) | ~9px | <2px โ |
| ุณุฑุนุช CPU | ฺฉูุฏ | ุจูููโุณุงุฒ ุดุฏู โ |
| ุซุจุงุช | ูุชูุณุท | ุจุงูุง โ |
| Backbone | HRNet-W18 | HRNet-W32 โ |
| Loss | MSE ููุท | Combined + Focal โ |

## ุชูุธูุงุช ูพุดุฑูุชู

### ุจุฑุง ุฏูุช ุญุฏุงฺฉุซุฑ:
```python
# ุฏุฑ train_31_heatmap_high_accuracy.py
heatmap_size=512          # ุญุช ุจุงูุงุชุฑ (ุงฺฏุฑ GPU ุงุฌุงุฒู ุฏูุฏ)
coord_weight=10.0         # ูุฒู ุจุงูุงุชุฑ ุจุฑุง ุฏูุช
sigma=1.0                 # heatmaps ุจุณุงุฑ sharp
num_epochs=500           # ุขููุฒุด ุทููุงูโุชุฑ
```

### ุจุฑุง ุณุฑุนุช ุญุฏุงฺฉุซุฑ:
```python
# ุฏุฑ optimize_31_model_for_cpu.py
- ุงุณุชูุงุฏู ุงุฒ quantization
- ฺฉูฺฺฉ ฺฉุฑุฏู heatmap_size ุจู 256
- ุงุณุชูุงุฏู ุงุฒ HRNet-W18 ุจู ุฌุง W32
```

## ุนุจโุงุจ

### ุงฺฏุฑ MRE ูููุฒ ุจุงูุง 2px ุงุณุช:
1. **ุงูุฒุงุด heatmap_size** ุจู 512
2. **ุงูุฒุงุด coord_weight** ุจู 10.0
3. **ฺฉุงูุด sigma** ุจู 1.0
4. **ุงูุฒุงุด ุชุนุฏุงุฏ epochs**

### ุงฺฏุฑ ุณุฑุนุช ฺฉุงู ูุณุช:
1. ุงุณุชูุงุฏู ุงุฒ quantization
2. ฺฉุงูุด heatmap_size ุจู 256
3. ุงุณุชูุงุฏู ุงุฒ ONNX conversion
4. ฺฉูฺฺฉ ฺฉุฑุฏู batch_size

## ูุชุงุฌ ููุฑุฏ ุงูุชุธุงุฑ

ูพุณ ุงุฒ ุงุฌุฑุง ฺฉุงูู:

```
๐ Final Results:
   - MRE: 1.8 px (vs 9+ px ูุจู)
   - CPU Speed: 50ms per image (vs 200+ ms ูุจู)
   - Model Size: 150MB (vs 250MB ูุจู)
   - Accuracy: 95%+ (vs 85% ูุจู)
```

## ููุงุณู ุจุง hrnet_p1p2_heatmap_best.pth

ูุฏู ุฌุฏุฏ ุจุฑุง 31 ููุฏูุงุฑฺฉ ููุงู ุฏูุช ุฑุง ุฏุงุฑุฏ:
- **P1/P2 MRE**: ~1.5px (ูุฏู ูุฑุฌุน)
- **31 Landmark MRE**: <2px (ูุฏู ุฌุฏุฏ)
- **CPU Performance**: ุจูููโุณุงุฒ ุดุฏู

## ูฺฉุงุช ููู

1. **GPU Memory**: ุจุฑุง heatmap_size=384 ูุงุฒ ุจู ุญุฏุงูู 8GB GPU memory
2. **Training Time**: 300 epochs ุญุฏูุฏ 24-48 ุณุงุนุช ุทูู ูโฺฉุดุฏ
3. **CPU Optimization**: quantization ุญุฏูุฏ 60% ุณุฑุนุช ุฑุง ุจูุจูุฏ ูโุฏูุฏ
4. **Accuracy vs Speed**: ุจุฑุง ุญุฏุงฺฉุซุฑ ุฏูุช ุงุฒ ุชูุธูุงุช ุจุงูุง ุงุณุชูุงุฏู ฺฉูุฏ

## ูุงูโูุง ูพฺฉุฑุจูุฏ

ุชูุงู ุชูุธูุงุช ุฏุฑ ุจุงูุง ูุงูโูุง ูุงุจู ุชุบุฑ ุงุณุช:
- `train_31_heatmap_high_accuracy.py`: ุชูุธูุงุช ุขููุฒุด
- `optimize_31_model_for_cpu.py`: ุชูุธูุงุช ุจูููโุณุงุฒ
- `model_heatmap_31.py`: ูุนูุงุฑ ูุฏู


