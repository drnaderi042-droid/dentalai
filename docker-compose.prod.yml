# Production configuration for DentalAI
# Use this for production deployment: docker-compose -f docker-compose.yml -f docker-compose.prod.yml up -d

version: '3.8'

services:
  # Production PostgreSQL with optimizations
  postgres:
    image: postgres:15-alpine
    deploy:
      resources:
        limits:
          memory: 1G
        reservations:
          memory: 512M
    environment:
      - POSTGRES_DB=dentalai
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=${DB_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    command:
      - "postgres"
      - "-c"
      - "max_connections=200"
      - "-c"
      - "shared_buffers=256MB"
      - "-c"
      - "effective_cache_size=1GB"
      - "-c"
      - "maintenance_work_mem=64MB"
      - "-c"
      - "checkpoint_completion_target=0.9"
      - "-c"
      - "wal_buffers=16MB"
      - "-c"
      - "default_statistics_target=100"
    networks:
      - dentalai-network

  # Production AI API
  ai-api:
    build:
      context: .
      dockerfile: Dockerfile.python
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
        reservations:
          memory: 2G
          cpus: '1.0'
    environment:
      - FLASK_ENV=production
      - PYTHONPATH=/app
      - OMP_NUM_THREADS=2
      - MKL_NUM_THREADS=2
    volumes:
      - ./models:/app/models:ro
      - ./datasets:/app/datasets:ro
    networks:
      - dentalai-network

  # Production API
  api:
    build:
      context: ./minimal-api-dev-v6
      dockerfile: ../Dockerfile.api
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@postgres:5432/dentalai
      - NEXTAUTH_SECRET=${NEXTAUTH_SECRET}
      - NEXTAUTH_URL=${NEXTAUTH_URL}
      - PORT=7272
    networks:
      - dentalai-network

  # Production Frontend
  frontend:
    build:
      context: ./vite-js
      dockerfile: ../Dockerfile.frontend
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    environment:
      - VITE_API_URL=${VITE_API_URL}
      - VITE_AI_API_URL=${VITE_AI_API_URL}
    networks:
      - dentalai-network

  # Production Dashboard
  dashboard:
    build:
      context: ./next-js
      dockerfile: ../Dockerfile.dashboard
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    environment:
      - NEXT_PUBLIC_API_URL=${NEXT_PUBLIC_API_URL}
      - DATABASE_URL=postgresql://postgres:${DB_PASSWORD}@postgres:5432/dentalai
    networks:
      - dentalai-network

  # Production Nginx with SSL
  nginx:
    image: nginx:alpine
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
        reservations:
          memory: 128M
          cpus: '0.25'
    volumes:
      - ./nginx/nginx.prod.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:ro
      - nginx_logs:/var/log/nginx
    ports:
      - "80:80"
      - "443:443"
    networks:
      - dentalai-network

  # Redis for caching (optional)
  redis:
    image: redis:7-alpine
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
    command: redis-server --appendonly yes
    volumes:
      - redis_data:/data
    networks:
      - dentalai-network

volumes:
  postgres_data:
  redis_data:
  nginx_logs:

networks:
  dentalai-network:
    driver: bridge
